var os_1 = require("os");
var ExtractVariable = (function () {
    function ExtractVariable() {
        this.key = ExtractVariable.name;
    }
    ExtractVariable.prototype.canProvideFix = function (info) {
        return execute(info, function () {
            var identifier = info.positionNode;
            return { display: "Extract variable from " + identifier.text };
        }, function () {
            var identifier = info.positionNode;
            return { display: "Extract variable from " + identifier.text };
        }, function () {
            return { display: "Extract variable" };
        });
        throw "Unexpected state in canProvideFix";
    };
    ExtractVariable.prototype.provideFix = function (info) {
        return execute(info, function () {
            return extractVariableFromCall(info);
        }, function () {
            return extractVariableFromCall(info, "Result");
        }, function (callExpression) {
            return extractVariableFromArg(info, callExpression);
        });
        throw "Unexpected state in provideFix";
    };
    return ExtractVariable;
})();
exports.ExtractVariable = ExtractVariable;
function execute(info, onProperty, onFuncCall, onExtractable) {
    var callExpression = findLowestNode(info.positionNode, 165);
    if (callExpression) {
        if (isPropertyCall(info)) {
            return onProperty();
        } else if (isFuncCall(info)) {
            return onFuncCall();
        } else if (isExtractable(info, callExpression)) {
            return onExtractable(callExpression);
        }
    } else if (isPropertyAccess(info)) {
        return onProperty();
    }
}
function extractVariableFromCall(info, postFix) {
    if (postFix === void 0) {
        postFix = "";
    }
    var typeChecker = info.typeChecker;
    var type = getTypeStringForNode(info.positionNode, typeChecker);
    var identifier = info.positionNode;
    return [{
        span: {
            start: startOfLine(info) + indentAtPos(info),
            length: 0
        },
        newText: "var " + identifier.text + postFix + ": " + type + " = ",
        filePath: info.filePath
    }];
}
function extractVariableFromArg(info, callExpression) {
    var argumentIndex = getArgumentIndex(info.positionNode, callExpression);
    var _a = getArgumentDescription(callExpression, argumentIndex, info.typeChecker),
        name = _a.name,
        type = _a.type;
    var indent = indentAtPos(info);
    var value = extractValue(info, callExpression);
    return [{
        span: {
            start: callExpression.arguments[argumentIndex].getStart(),
            length: value.length
        },
        newText: name,
        filePath: info.filePath
    }, {
        span: {
            start: startOfLine(info) + indent,
            length: 0
        },
        newText: "var " + name + ": " + type + " = " + value + ";" + os_1.EOL + createIndent(indent),
        filePath: info.filePath
    }];
}
function isPropertyAccess(info) {
    return isValidPath(info.positionNode, [66, 163, 192]);
}
function isFuncCall(info) {
    return isValidPath(info.positionNode, [66, 165, 192]);
}
function isPropertyCall(info) {
    return isValidPath(info.positionNode, [66, 163, 165, 192]);
}
function isExtractable(info, callExpression) {
    var argumentIndex = getArgumentIndex(info.positionNode, callExpression);
    return argumentIndex > -1 && !(info.positionNode.kind == 66 && info.positionNode.parent == callExpression);
}
function findLowestNode(startNode, kind) {
    var node = startNode;
    var result = new Array();
    while (node) {
        if (node.kind == kind) {
            result.push(node);
        }
        node = node.parent;
    }
    if (result.length == 0) {
        return null;
    } else {
        return result.reverse()[0];
    }
}
function getArgumentDescription(node, argumentIndex, typeChecker) {
    var signature = typeChecker.getResolvedSignature(node);
    var argument = signature.parameters[argumentIndex];
    var sigDeclaration = argument.valueDeclaration.type;
    return {
        name: argument.name.trim(),
        type: node.getSourceFile().text.substring(sigDeclaration.pos, sigDeclaration.end).trim()
    };
}
function startOfLine(info) {
    var line = info.project.languageServiceHost.getPositionFromIndex(info.filePath, info.position).line;
    return info.project.languageServiceHost.getIndexFromPosition(info.filePath, { line: line, col: 0 });
}
function indentAtPos(info) {
    return info.service.getIndentationAtPosition(info.filePath, info.positionNode.pos, info.project.projectFile.project.formatCodeOptions);
}
function createIndent(indent) {
    return Array(indent + 1).join(" ");
}
function getTypeStringForNode(node, typeChecker) {
    var type = typeChecker.getTypeAtLocation(node);
    var typeSignature = ts.displayPartsToString(ts.typeToDisplayParts(typeChecker, type)).replace(/\s+/g, " ");
    var fatArrowPos = typeSignature.indexOf("=>");
    if (fatArrowPos != -1) {
        return typeSignature.substr(fatArrowPos + 3).trim();
    } else {
        return typeSignature.trim();
    }
}
function extractValue(info, callExpression) {
    var index = getArgumentIndex(info.positionNode, callExpression);
    var argNode = callExpression.arguments[index];
    return info.positionNode.getSourceFile().text.substr(argNode.pos, argNode.end - argNode.pos).trim();
}
function getArgumentIndex(node, callExpression) {
    for (var i = 0; i < callExpression.arguments.length; i++) {
        var arg = callExpression.arguments[i];
        if (node.pos >= arg.pos && node.end <= arg.end) {
            return i;
        }
    }
    return -1;
}
function isValidPath(startNode, kinds) {
    var node = startNode;
    for (var i = 0; i < kinds.length; i++) {
        if (!(node.kind == kinds[i])) {
            return false;
        }
        node = node.parent;
        if (!node) {
            return false;
        }
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2xhbmcvZml4bXl0cy9xdWlja0ZpeGVzL2V4dHJhY3RWYXJpYWJsZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDekIsSUFBSSxlQUFlLEdBQUcsQ0FBQyxZQUFZO0FBQy9CLGFBQVMsZUFBZSxHQUFHO0FBQ3ZCLFlBQUksQ0FBQyxHQUFHLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQztLQUNuQztBQUNELG1CQUFlLENBQUMsU0FBUyxDQUFDLGFBQWEsR0FBRyxVQUFVLElBQUksRUFBRTtBQUN0RCxlQUFPLE9BQU8sQ0FBQyxJQUFJLEVBQUUsWUFBWTtBQUM3QixnQkFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQztBQUNuQyxtQkFBTyxFQUFFLE9BQU8sRUFBRSx3QkFBd0IsR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7U0FDbEUsRUFBRSxZQUFZO0FBQ1gsZ0JBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7QUFDbkMsbUJBQU8sRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEdBQUcsVUFBVSxDQUFDLElBQUksRUFBRSxDQUFDO1NBQ2xFLEVBQUUsWUFBWTtBQUNYLG1CQUFPLEVBQUUsT0FBTyxFQUFFLGtCQUFrQixFQUFFLENBQUM7U0FDMUMsQ0FBQyxDQUFDO0FBQ0gsY0FBTSxtQ0FBbUMsQ0FBQztLQUM3QyxDQUFDO0FBQ0YsbUJBQWUsQ0FBQyxTQUFTLENBQUMsVUFBVSxHQUFHLFVBQVUsSUFBSSxFQUFFO0FBQ25ELGVBQU8sT0FBTyxDQUFDLElBQUksRUFBRSxZQUFZO0FBQzdCLG1CQUFPLHVCQUF1QixDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3hDLEVBQUUsWUFBWTtBQUNYLG1CQUFPLHVCQUF1QixDQUFDLElBQUksRUFBRSxRQUFRLENBQUMsQ0FBQztTQUNsRCxFQUFFLFVBQVUsY0FBYyxFQUFFO0FBQ3pCLG1CQUFPLHNCQUFzQixDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQztTQUN2RCxDQUFDLENBQUM7QUFDSCxjQUFNLGdDQUFnQyxDQUFDO0tBQzFDLENBQUM7QUFDRixXQUFPLGVBQWUsQ0FBQztDQUMxQixDQUFBLEVBQUcsQ0FBQztBQUNMLE9BQU8sQ0FBQyxlQUFlLEdBQUcsZUFBZSxDQUFDO0FBQzFDLFNBQVMsT0FBTyxDQUFDLElBQUksRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLGFBQWEsRUFBRTtBQUMxRCxRQUFJLGNBQWMsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLENBQUMsQ0FBQztBQUM1RCxRQUFJLGNBQWMsRUFBRTtBQUNoQixZQUFJLGNBQWMsQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUN0QixtQkFBTyxVQUFVLEVBQUUsQ0FBQztTQUN2QixNQUNJLElBQUksVUFBVSxDQUFDLElBQUksQ0FBQyxFQUFFO0FBQ3ZCLG1CQUFPLFVBQVUsRUFBRSxDQUFDO1NBQ3ZCLE1BQ0ksSUFBSSxhQUFhLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxFQUFFO0FBQzFDLG1CQUFPLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQztTQUN4QztLQUNKLE1BQ0ksSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsRUFBRTtBQUM3QixlQUFPLFVBQVUsRUFBRSxDQUFDO0tBQ3ZCO0NBQ0o7QUFDRCxTQUFTLHVCQUF1QixDQUFDLElBQUksRUFBRSxPQUFPLEVBQUU7QUFDNUMsUUFBSSxPQUFPLEtBQUssS0FBSyxDQUFDLEVBQUU7QUFBRSxlQUFPLEdBQUcsRUFBRSxDQUFDO0tBQUU7QUFDekMsUUFBSSxXQUFXLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQztBQUNuQyxRQUFJLElBQUksR0FBRyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQ2hFLFFBQUksVUFBVSxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUM7QUFDbkMsV0FBTyxDQUFDO0FBQ0EsWUFBSSxFQUFFO0FBQ0YsaUJBQUssRUFBRSxXQUFXLENBQUMsSUFBSSxDQUFDLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQztBQUM1QyxrQkFBTSxFQUFFLENBQUM7U0FDWjtBQUNELGVBQU8sRUFBRSxNQUFNLEdBQUcsVUFBVSxDQUFDLElBQUksR0FBRyxPQUFPLEdBQUcsSUFBSSxHQUFHLElBQUksR0FBRyxLQUFLO0FBQ2pFLGdCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7S0FDMUIsQ0FBQyxDQUFDO0NBQ1Y7QUFDRCxTQUFTLHNCQUFzQixDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7QUFDbEQsUUFBSSxhQUFhLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUMsQ0FBQztBQUN4RSxRQUFJLEVBQUUsR0FBRyxzQkFBc0IsQ0FBQyxjQUFjLEVBQUUsYUFBYSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUM7UUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUk7UUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQztBQUNqSCxRQUFJLE1BQU0sR0FBRyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDL0IsUUFBSSxLQUFLLEdBQUcsWUFBWSxDQUFDLElBQUksRUFBRSxjQUFjLENBQUMsQ0FBQztBQUMvQyxXQUFPLENBQ0g7QUFDSSxZQUFJLEVBQUU7QUFDRixpQkFBSyxFQUFFLGNBQWMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsUUFBUSxFQUFFO0FBQ3pELGtCQUFNLEVBQUUsS0FBSyxDQUFDLE1BQU07U0FDdkI7QUFDRCxlQUFPLEVBQUUsSUFBSTtBQUNiLGdCQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVE7S0FDMUIsRUFDRDtBQUNJLFlBQUksRUFBRTtBQUNGLGlCQUFLLEVBQUUsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU07QUFDakMsa0JBQU0sRUFBRSxDQUFDO1NBQ1o7QUFDRCxlQUFPLEVBQUUsTUFBTSxHQUFHLElBQUksR0FBRyxJQUFJLEdBQUcsSUFBSSxHQUFHLEtBQUssR0FBRyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQztBQUM1RixnQkFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO0tBQzFCLENBQUMsQ0FBQztDQUNWO0FBQ0QsU0FBUyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUU7QUFDNUIsV0FBTyxXQUFXLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLEVBQUUsRUFDckMsR0FBRyxFQUNILEdBQUcsQ0FBQyxDQUFDLENBQUM7Q0FDYjtBQUNELFNBQVMsVUFBVSxDQUFDLElBQUksRUFBRTtBQUN0QixXQUFPLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsRUFBRSxFQUNyQyxHQUFHLEVBQ0gsR0FBRyxDQUFDLENBQUMsQ0FBQztDQUNiO0FBQ0QsU0FBUyxjQUFjLENBQUMsSUFBSSxFQUFFO0FBQzFCLFdBQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQyxFQUFFLEVBQ3JDLEdBQUcsRUFDSCxHQUFHLEVBQ0gsR0FBRyxDQUFDLENBQUMsQ0FBQztDQUNiO0FBQ0QsU0FBUyxhQUFhLENBQUMsSUFBSSxFQUFFLGNBQWMsRUFBRTtBQUN6QyxRQUFJLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLGNBQWMsQ0FBQyxDQUFDO0FBQ3hFLFdBQU8sQUFBQyxhQUFhLEdBQUcsQ0FBQyxDQUFDLElBQ3JCLEVBQUUsQUFBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksSUFBSSxFQUFFLElBQzNCLElBQUksQ0FBQyxZQUFZLENBQUMsTUFBTSxJQUFJLGNBQWMsQ0FBQyxBQUFDLEFBQUMsQ0FBQztDQUMxRDtBQUNELFNBQVMsY0FBYyxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUU7QUFDckMsUUFBSSxJQUFJLEdBQUcsU0FBUyxDQUFDO0FBQ3JCLFFBQUksTUFBTSxHQUFHLElBQUksS0FBSyxFQUFFLENBQUM7QUFDekIsV0FBTyxJQUFJLEVBQUU7QUFDVCxZQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxFQUFFO0FBQ25CLGtCQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1NBQ3JCO0FBQ0QsWUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7S0FDdEI7QUFDRCxRQUFJLE1BQU0sQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFO0FBQ3BCLGVBQU8sSUFBSSxDQUFDO0tBQ2YsTUFDSTtBQUNELGVBQU8sTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzlCO0NBQ0o7QUFDRCxTQUFTLHNCQUFzQixDQUFDLElBQUksRUFBRSxhQUFhLEVBQUUsV0FBVyxFQUFFO0FBQzlELFFBQUksU0FBUyxHQUFHLFdBQVcsQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN2RCxRQUFJLFFBQVEsR0FBRyxTQUFTLENBQUMsVUFBVSxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ25ELFFBQUksY0FBYyxHQUFHLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUM7QUFDcEQsV0FBTztBQUNILFlBQUksRUFBRSxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtBQUMxQixZQUFJLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsY0FBYyxDQUFDLEdBQUcsRUFBRSxjQUFjLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFO0tBQzNGLENBQUM7Q0FDTDtBQUNELFNBQVMsV0FBVyxDQUFDLElBQUksRUFBRTtBQUN2QixRQUFJLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQixDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FBQztBQUNwRyxXQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsbUJBQW1CLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7Q0FDdkc7QUFDRCxTQUFTLFdBQVcsQ0FBQyxJQUFJLEVBQUU7QUFDdkIsV0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7Q0FDMUk7QUFDRCxTQUFTLFlBQVksQ0FBQyxNQUFNLEVBQUU7QUFDMUIsV0FBTyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztDQUN0QztBQUNELFNBQVMsb0JBQW9CLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRTtBQUM3QyxRQUFJLElBQUksR0FBRyxXQUFXLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDL0MsUUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDLG9CQUFvQixDQUFDLEVBQUUsQ0FBQyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQzNHLFFBQUksV0FBVyxHQUFHLGFBQWEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDOUMsUUFBSSxXQUFXLElBQUksQ0FBQyxDQUFDLEVBQUU7QUFDbkIsZUFBTyxhQUFhLENBQUMsTUFBTSxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztLQUN2RCxNQUNJO0FBQ0QsZUFBTyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDL0I7Q0FDSjtBQUNELFNBQVMsWUFBWSxDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7QUFDeEMsUUFBSSxLQUFLLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxjQUFjLENBQUMsQ0FBQztBQUNoRSxRQUFJLE9BQU8sR0FBRyxjQUFjLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO0FBQzlDLFdBQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxFQUFFLENBQUM7Q0FDdkc7QUFDRCxTQUFTLGdCQUFnQixDQUFDLElBQUksRUFBRSxjQUFjLEVBQUU7QUFDNUMsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLGNBQWMsQ0FBQyxTQUFTLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO0FBQ3RELFlBQUksR0FBRyxHQUFHLGNBQWMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEMsWUFBSSxBQUFDLElBQUksQ0FBQyxHQUFHLElBQUksR0FBRyxDQUFDLEdBQUcsSUFBTSxJQUFJLENBQUMsR0FBRyxJQUFJLEdBQUcsQ0FBQyxHQUFHLEFBQUMsRUFBRTtBQUNoRCxtQkFBTyxDQUFDLENBQUM7U0FDWjtLQUNKO0FBQ0QsV0FBTyxDQUFDLENBQUMsQ0FBQztDQUNiO0FBQ0QsU0FBUyxXQUFXLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRTtBQUNuQyxRQUFJLElBQUksR0FBRyxTQUFTLENBQUM7QUFDckIsU0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUU7QUFDbkMsWUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFBLEFBQUMsRUFBRTtBQUMxQixtQkFBTyxLQUFLLENBQUM7U0FDaEI7QUFDRCxZQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUNuQixZQUFJLENBQUMsSUFBSSxFQUFFO0FBQ1AsbUJBQU8sS0FBSyxDQUFDO1NBQ2hCO0tBQ0o7QUFDRCxXQUFPLElBQUksQ0FBQztDQUNmIiwiZmlsZSI6Ii9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2xhbmcvZml4bXl0cy9xdWlja0ZpeGVzL2V4dHJhY3RWYXJpYWJsZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBvc18xID0gcmVxdWlyZShcIm9zXCIpO1xudmFyIEV4dHJhY3RWYXJpYWJsZSA9IChmdW5jdGlvbiAoKSB7XG4gICAgZnVuY3Rpb24gRXh0cmFjdFZhcmlhYmxlKCkge1xuICAgICAgICB0aGlzLmtleSA9IEV4dHJhY3RWYXJpYWJsZS5uYW1lO1xuICAgIH1cbiAgICBFeHRyYWN0VmFyaWFibGUucHJvdG90eXBlLmNhblByb3ZpZGVGaXggPSBmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICByZXR1cm4gZXhlY3V0ZShpbmZvLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICB2YXIgaWRlbnRpZmllciA9IGluZm8ucG9zaXRpb25Ob2RlO1xuICAgICAgICAgICAgcmV0dXJuIHsgZGlzcGxheTogXCJFeHRyYWN0IHZhcmlhYmxlIGZyb20gXCIgKyBpZGVudGlmaWVyLnRleHQgfTtcbiAgICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgdmFyIGlkZW50aWZpZXIgPSBpbmZvLnBvc2l0aW9uTm9kZTtcbiAgICAgICAgICAgIHJldHVybiB7IGRpc3BsYXk6IFwiRXh0cmFjdCB2YXJpYWJsZSBmcm9tIFwiICsgaWRlbnRpZmllci50ZXh0IH07XG4gICAgICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIHJldHVybiB7IGRpc3BsYXk6IFwiRXh0cmFjdCB2YXJpYWJsZVwiIH07XG4gICAgICAgIH0pO1xuICAgICAgICB0aHJvdyBcIlVuZXhwZWN0ZWQgc3RhdGUgaW4gY2FuUHJvdmlkZUZpeFwiO1xuICAgIH07XG4gICAgRXh0cmFjdFZhcmlhYmxlLnByb3RvdHlwZS5wcm92aWRlRml4ID0gZnVuY3Rpb24gKGluZm8pIHtcbiAgICAgICAgcmV0dXJuIGV4ZWN1dGUoaW5mbywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIGV4dHJhY3RWYXJpYWJsZUZyb21DYWxsKGluZm8pO1xuICAgICAgICB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICByZXR1cm4gZXh0cmFjdFZhcmlhYmxlRnJvbUNhbGwoaW5mbywgXCJSZXN1bHRcIik7XG4gICAgICAgIH0sIGZ1bmN0aW9uIChjYWxsRXhwcmVzc2lvbikge1xuICAgICAgICAgICAgcmV0dXJuIGV4dHJhY3RWYXJpYWJsZUZyb21BcmcoaW5mbywgY2FsbEV4cHJlc3Npb24pO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhyb3cgXCJVbmV4cGVjdGVkIHN0YXRlIGluIHByb3ZpZGVGaXhcIjtcbiAgICB9O1xuICAgIHJldHVybiBFeHRyYWN0VmFyaWFibGU7XG59KSgpO1xuZXhwb3J0cy5FeHRyYWN0VmFyaWFibGUgPSBFeHRyYWN0VmFyaWFibGU7XG5mdW5jdGlvbiBleGVjdXRlKGluZm8sIG9uUHJvcGVydHksIG9uRnVuY0NhbGwsIG9uRXh0cmFjdGFibGUpIHtcbiAgICB2YXIgY2FsbEV4cHJlc3Npb24gPSBmaW5kTG93ZXN0Tm9kZShpbmZvLnBvc2l0aW9uTm9kZSwgMTY1KTtcbiAgICBpZiAoY2FsbEV4cHJlc3Npb24pIHtcbiAgICAgICAgaWYgKGlzUHJvcGVydHlDYWxsKGluZm8pKSB7XG4gICAgICAgICAgICByZXR1cm4gb25Qcm9wZXJ0eSgpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGlzRnVuY0NhbGwoaW5mbykpIHtcbiAgICAgICAgICAgIHJldHVybiBvbkZ1bmNDYWxsKCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoaXNFeHRyYWN0YWJsZShpbmZvLCBjYWxsRXhwcmVzc2lvbikpIHtcbiAgICAgICAgICAgIHJldHVybiBvbkV4dHJhY3RhYmxlKGNhbGxFeHByZXNzaW9uKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNlIGlmIChpc1Byb3BlcnR5QWNjZXNzKGluZm8pKSB7XG4gICAgICAgIHJldHVybiBvblByb3BlcnR5KCk7XG4gICAgfVxufVxuZnVuY3Rpb24gZXh0cmFjdFZhcmlhYmxlRnJvbUNhbGwoaW5mbywgcG9zdEZpeCkge1xuICAgIGlmIChwb3N0Rml4ID09PSB2b2lkIDApIHsgcG9zdEZpeCA9ICcnOyB9XG4gICAgdmFyIHR5cGVDaGVja2VyID0gaW5mby50eXBlQ2hlY2tlcjtcbiAgICB2YXIgdHlwZSA9IGdldFR5cGVTdHJpbmdGb3JOb2RlKGluZm8ucG9zaXRpb25Ob2RlLCB0eXBlQ2hlY2tlcik7XG4gICAgdmFyIGlkZW50aWZpZXIgPSBpbmZvLnBvc2l0aW9uTm9kZTtcbiAgICByZXR1cm4gW3tcbiAgICAgICAgICAgIHNwYW46IHtcbiAgICAgICAgICAgICAgICBzdGFydDogc3RhcnRPZkxpbmUoaW5mbykgKyBpbmRlbnRBdFBvcyhpbmZvKSxcbiAgICAgICAgICAgICAgICBsZW5ndGg6IDBcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBuZXdUZXh0OiBcInZhciBcIiArIGlkZW50aWZpZXIudGV4dCArIHBvc3RGaXggKyBcIjogXCIgKyB0eXBlICsgXCIgPSBcIixcbiAgICAgICAgICAgIGZpbGVQYXRoOiBpbmZvLmZpbGVQYXRoXG4gICAgICAgIH1dO1xufVxuZnVuY3Rpb24gZXh0cmFjdFZhcmlhYmxlRnJvbUFyZyhpbmZvLCBjYWxsRXhwcmVzc2lvbikge1xuICAgIHZhciBhcmd1bWVudEluZGV4ID0gZ2V0QXJndW1lbnRJbmRleChpbmZvLnBvc2l0aW9uTm9kZSwgY2FsbEV4cHJlc3Npb24pO1xuICAgIHZhciBfYSA9IGdldEFyZ3VtZW50RGVzY3JpcHRpb24oY2FsbEV4cHJlc3Npb24sIGFyZ3VtZW50SW5kZXgsIGluZm8udHlwZUNoZWNrZXIpLCBuYW1lID0gX2EubmFtZSwgdHlwZSA9IF9hLnR5cGU7XG4gICAgdmFyIGluZGVudCA9IGluZGVudEF0UG9zKGluZm8pO1xuICAgIHZhciB2YWx1ZSA9IGV4dHJhY3RWYWx1ZShpbmZvLCBjYWxsRXhwcmVzc2lvbik7XG4gICAgcmV0dXJuIFtcbiAgICAgICAge1xuICAgICAgICAgICAgc3Bhbjoge1xuICAgICAgICAgICAgICAgIHN0YXJ0OiBjYWxsRXhwcmVzc2lvbi5hcmd1bWVudHNbYXJndW1lbnRJbmRleF0uZ2V0U3RhcnQoKSxcbiAgICAgICAgICAgICAgICBsZW5ndGg6IHZhbHVlLmxlbmd0aFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5ld1RleHQ6IG5hbWUsXG4gICAgICAgICAgICBmaWxlUGF0aDogaW5mby5maWxlUGF0aFxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgICBzcGFuOiB7XG4gICAgICAgICAgICAgICAgc3RhcnQ6IHN0YXJ0T2ZMaW5lKGluZm8pICsgaW5kZW50LFxuICAgICAgICAgICAgICAgIGxlbmd0aDogMFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIG5ld1RleHQ6IFwidmFyIFwiICsgbmFtZSArIFwiOiBcIiArIHR5cGUgKyBcIiA9IFwiICsgdmFsdWUgKyBcIjtcIiArIG9zXzEuRU9MICsgY3JlYXRlSW5kZW50KGluZGVudCksXG4gICAgICAgICAgICBmaWxlUGF0aDogaW5mby5maWxlUGF0aFxuICAgICAgICB9XTtcbn1cbmZ1bmN0aW9uIGlzUHJvcGVydHlBY2Nlc3MoaW5mbykge1xuICAgIHJldHVybiBpc1ZhbGlkUGF0aChpbmZvLnBvc2l0aW9uTm9kZSwgWzY2LFxuICAgICAgICAxNjMsXG4gICAgICAgIDE5Ml0pO1xufVxuZnVuY3Rpb24gaXNGdW5jQ2FsbChpbmZvKSB7XG4gICAgcmV0dXJuIGlzVmFsaWRQYXRoKGluZm8ucG9zaXRpb25Ob2RlLCBbNjYsXG4gICAgICAgIDE2NSxcbiAgICAgICAgMTkyXSk7XG59XG5mdW5jdGlvbiBpc1Byb3BlcnR5Q2FsbChpbmZvKSB7XG4gICAgcmV0dXJuIGlzVmFsaWRQYXRoKGluZm8ucG9zaXRpb25Ob2RlLCBbNjYsXG4gICAgICAgIDE2MyxcbiAgICAgICAgMTY1LFxuICAgICAgICAxOTJdKTtcbn1cbmZ1bmN0aW9uIGlzRXh0cmFjdGFibGUoaW5mbywgY2FsbEV4cHJlc3Npb24pIHtcbiAgICB2YXIgYXJndW1lbnRJbmRleCA9IGdldEFyZ3VtZW50SW5kZXgoaW5mby5wb3NpdGlvbk5vZGUsIGNhbGxFeHByZXNzaW9uKTtcbiAgICByZXR1cm4gKGFyZ3VtZW50SW5kZXggPiAtMSkgJiZcbiAgICAgICAgKCEoKGluZm8ucG9zaXRpb25Ob2RlLmtpbmQgPT0gNjYpICYmXG4gICAgICAgICAgICAoaW5mby5wb3NpdGlvbk5vZGUucGFyZW50ID09IGNhbGxFeHByZXNzaW9uKSkpO1xufVxuZnVuY3Rpb24gZmluZExvd2VzdE5vZGUoc3RhcnROb2RlLCBraW5kKSB7XG4gICAgdmFyIG5vZGUgPSBzdGFydE5vZGU7XG4gICAgdmFyIHJlc3VsdCA9IG5ldyBBcnJheSgpO1xuICAgIHdoaWxlIChub2RlKSB7XG4gICAgICAgIGlmIChub2RlLmtpbmQgPT0ga2luZCkge1xuICAgICAgICAgICAgcmVzdWx0LnB1c2gobm9kZSk7XG4gICAgICAgIH1cbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50O1xuICAgIH1cbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA9PSAwKSB7XG4gICAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHJlc3VsdC5yZXZlcnNlKClbMF07XG4gICAgfVxufVxuZnVuY3Rpb24gZ2V0QXJndW1lbnREZXNjcmlwdGlvbihub2RlLCBhcmd1bWVudEluZGV4LCB0eXBlQ2hlY2tlcikge1xuICAgIHZhciBzaWduYXR1cmUgPSB0eXBlQ2hlY2tlci5nZXRSZXNvbHZlZFNpZ25hdHVyZShub2RlKTtcbiAgICB2YXIgYXJndW1lbnQgPSBzaWduYXR1cmUucGFyYW1ldGVyc1thcmd1bWVudEluZGV4XTtcbiAgICB2YXIgc2lnRGVjbGFyYXRpb24gPSBhcmd1bWVudC52YWx1ZURlY2xhcmF0aW9uLnR5cGU7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogYXJndW1lbnQubmFtZS50cmltKCksXG4gICAgICAgIHR5cGU6IG5vZGUuZ2V0U291cmNlRmlsZSgpLnRleHQuc3Vic3RyaW5nKHNpZ0RlY2xhcmF0aW9uLnBvcywgc2lnRGVjbGFyYXRpb24uZW5kKS50cmltKClcbiAgICB9O1xufVxuZnVuY3Rpb24gc3RhcnRPZkxpbmUoaW5mbykge1xuICAgIHZhciBsaW5lID0gaW5mby5wcm9qZWN0Lmxhbmd1YWdlU2VydmljZUhvc3QuZ2V0UG9zaXRpb25Gcm9tSW5kZXgoaW5mby5maWxlUGF0aCwgaW5mby5wb3NpdGlvbikubGluZTtcbiAgICByZXR1cm4gaW5mby5wcm9qZWN0Lmxhbmd1YWdlU2VydmljZUhvc3QuZ2V0SW5kZXhGcm9tUG9zaXRpb24oaW5mby5maWxlUGF0aCwgeyBsaW5lOiBsaW5lLCBjb2w6IDAgfSk7XG59XG5mdW5jdGlvbiBpbmRlbnRBdFBvcyhpbmZvKSB7XG4gICAgcmV0dXJuIGluZm8uc2VydmljZS5nZXRJbmRlbnRhdGlvbkF0UG9zaXRpb24oaW5mby5maWxlUGF0aCwgaW5mby5wb3NpdGlvbk5vZGUucG9zLCBpbmZvLnByb2plY3QucHJvamVjdEZpbGUucHJvamVjdC5mb3JtYXRDb2RlT3B0aW9ucyk7XG59XG5mdW5jdGlvbiBjcmVhdGVJbmRlbnQoaW5kZW50KSB7XG4gICAgcmV0dXJuIEFycmF5KGluZGVudCArIDEpLmpvaW4oJyAnKTtcbn1cbmZ1bmN0aW9uIGdldFR5cGVTdHJpbmdGb3JOb2RlKG5vZGUsIHR5cGVDaGVja2VyKSB7XG4gICAgdmFyIHR5cGUgPSB0eXBlQ2hlY2tlci5nZXRUeXBlQXRMb2NhdGlvbihub2RlKTtcbiAgICB2YXIgdHlwZVNpZ25hdHVyZSA9IHRzLmRpc3BsYXlQYXJ0c1RvU3RyaW5nKHRzLnR5cGVUb0Rpc3BsYXlQYXJ0cyh0eXBlQ2hlY2tlciwgdHlwZSkpLnJlcGxhY2UoL1xccysvZywgJyAnKTtcbiAgICB2YXIgZmF0QXJyb3dQb3MgPSB0eXBlU2lnbmF0dXJlLmluZGV4T2YoXCI9PlwiKTtcbiAgICBpZiAoZmF0QXJyb3dQb3MgIT0gLTEpIHtcbiAgICAgICAgcmV0dXJuIHR5cGVTaWduYXR1cmUuc3Vic3RyKGZhdEFycm93UG9zICsgMykudHJpbSgpO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgcmV0dXJuIHR5cGVTaWduYXR1cmUudHJpbSgpO1xuICAgIH1cbn1cbmZ1bmN0aW9uIGV4dHJhY3RWYWx1ZShpbmZvLCBjYWxsRXhwcmVzc2lvbikge1xuICAgIHZhciBpbmRleCA9IGdldEFyZ3VtZW50SW5kZXgoaW5mby5wb3NpdGlvbk5vZGUsIGNhbGxFeHByZXNzaW9uKTtcbiAgICB2YXIgYXJnTm9kZSA9IGNhbGxFeHByZXNzaW9uLmFyZ3VtZW50c1tpbmRleF07XG4gICAgcmV0dXJuIGluZm8ucG9zaXRpb25Ob2RlLmdldFNvdXJjZUZpbGUoKS50ZXh0LnN1YnN0cihhcmdOb2RlLnBvcywgYXJnTm9kZS5lbmQgLSBhcmdOb2RlLnBvcykudHJpbSgpO1xufVxuZnVuY3Rpb24gZ2V0QXJndW1lbnRJbmRleChub2RlLCBjYWxsRXhwcmVzc2lvbikge1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgY2FsbEV4cHJlc3Npb24uYXJndW1lbnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIHZhciBhcmcgPSBjYWxsRXhwcmVzc2lvbi5hcmd1bWVudHNbaV07XG4gICAgICAgIGlmICgobm9kZS5wb3MgPj0gYXJnLnBvcykgJiYgKG5vZGUuZW5kIDw9IGFyZy5lbmQpKSB7XG4gICAgICAgICAgICByZXR1cm4gaTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gLTE7XG59XG5mdW5jdGlvbiBpc1ZhbGlkUGF0aChzdGFydE5vZGUsIGtpbmRzKSB7XG4gICAgdmFyIG5vZGUgPSBzdGFydE5vZGU7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBraW5kcy5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoIShub2RlLmtpbmQgPT0ga2luZHNbaV0pKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgbm9kZSA9IG5vZGUucGFyZW50O1xuICAgICAgICBpZiAoIW5vZGUpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbn1cbiJdfQ==