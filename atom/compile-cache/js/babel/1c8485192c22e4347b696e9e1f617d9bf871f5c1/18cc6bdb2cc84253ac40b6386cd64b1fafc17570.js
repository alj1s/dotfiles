var __extends = this && this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() {
        this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var childprocess = require('child_process');
var exec = childprocess.exec;
var spawn = childprocess.spawn;
var path = require('path');
function createId() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0,
            v = c == 'x' ? r : r & 0x3 | 0x8;
        return v.toString(16);
    });
}
var orphanExitCode = 100;
var RequesterResponder = (function () {
    function RequesterResponder() {
        var _this = this;
        this.getProcess = function () {
            throw new Error('getProcess is abstract');return null;
        };
        this.currentListeners = {};
        this.currentLastOfType = {};
        this.pendingRequests = [];
        this.pendingRequestsChanged = function (pending) {
            return null;
        };
        this.sendToIpcHeart = function (data, message) {
            if (!_this.getProcess()) {
                console.log('PARENT ERR: no child when you tried to send :', message);
                return Promise.reject(new Error('No worker active to recieve message: ' + message));
            }
            if (!_this.currentListeners[message]) _this.currentListeners[message] = {};
            var id = createId();
            var defer = Promise.defer();
            _this.currentListeners[message][id] = defer;
            _this.pendingRequests.push(message);
            _this.pendingRequestsChanged(_this.pendingRequests);
            _this.getProcess().send({ message: message, id: id, data: data, request: true });
            return defer.promise;
        };
        this.responders = {};
        this.processRequest = function (m) {
            var parsed = m;
            if (!parsed.message || !_this.responders[parsed.message]) {
                return;
            }
            var message = parsed.message;
            var responsePromise;
            try {
                responsePromise = _this.responders[message](parsed.data);
            } catch (err) {
                responsePromise = Promise.reject({ method: message, message: err.message, stack: err.stack, details: err.details || {} });
            }
            responsePromise.then(function (response) {
                _this.getProcess().send({
                    message: message,
                    id: parsed.id,
                    data: response,
                    error: null,
                    request: false
                });
            })['catch'](function (error) {
                _this.getProcess().send({
                    message: message,
                    id: parsed.id,
                    data: null,
                    error: error,
                    request: false
                });
            });
        };
    }
    RequesterResponder.prototype.processResponse = function (m) {
        var parsed = m;
        this.pendingRequests.pop();
        this.pendingRequestsChanged(this.pendingRequests);
        if (!parsed.message || !parsed.id) {
            console.log('PARENT ERR: Invalid JSON data from child:', m);
        } else if (!this.currentListeners[parsed.message] || !this.currentListeners[parsed.message][parsed.id]) {
            console.log('PARENT ERR: No one was listening:', parsed.message, parsed.data);
        } else {
            if (parsed.error) {
                this.currentListeners[parsed.message][parsed.id].reject(parsed.error);
                console.log(parsed.error);
                console.log(parsed.error.stack);
            } else {
                this.currentListeners[parsed.message][parsed.id].resolve(parsed.data);
            }
            delete this.currentListeners[parsed.message][parsed.id];
            if (this.currentLastOfType[parsed.message]) {
                var last = this.currentLastOfType[parsed.message];
                delete this.currentLastOfType[parsed.message];
                var lastPromise = this.sendToIpcHeart(last.data, parsed.message);
                lastPromise.then(function (res) {
                    return last.defer.resolve(res);
                }, function (rej) {
                    return last.defer.reject(rej);
                });
            }
        }
    };
    RequesterResponder.prototype.sendToIpc = function (func) {
        var _this = this;
        var message = func.name;
        return function (data) {
            return _this.sendToIpcHeart(data, message);
        };
    };
    RequesterResponder.prototype.sendToIpcOnlyLast = function (func, defaultResponse) {
        var _this = this;
        return function (data) {
            var message = func.name;
            if (!_this.getProcess()) {
                console.log('PARENT ERR: no child when you tried to send :', message);
                return Promise.reject(new Error('No worker active to recieve message: ' + message));
            }
            if (!Object.keys(_this.currentListeners[message] || {}).length) {
                return _this.sendToIpcHeart(data, message);
            } else {
                if (_this.currentLastOfType[message]) {
                    _this.currentLastOfType[message].defer.resolve(defaultResponse);
                }
                var defer = Promise.defer();
                _this.currentLastOfType[message] = {
                    data: data,
                    defer: defer
                };
                return defer.promise;
            }
        };
    };
    RequesterResponder.prototype.addToResponders = function (func) {
        this.responders[func.name] = func;
    };
    RequesterResponder.prototype.registerAllFunctionsExportedFromAsResponders = function (aModule) {
        var _this = this;
        Object.keys(aModule).filter(function (funcName) {
            return typeof aModule[funcName] == 'function';
        }).forEach(function (funcName) {
            return _this.addToResponders(aModule[funcName]);
        });
    };
    return RequesterResponder;
})();
var Parent = (function (_super) {
    __extends(Parent, _super);
    function Parent() {
        var _this = this;
        _super.apply(this, arguments);
        this.node = process.execPath;
        this.gotENOENTonSpawnNode = false;
        this.getProcess = function () {
            return _this.child;
        };
        this.stopped = false;
    }
    Parent.prototype.startWorker = function (childJsPath, terminalError, customArguments) {
        var _this = this;
        try {
            this.child = spawn(this.node, [childJsPath].concat(customArguments), { cwd: path.dirname(childJsPath), env: { ATOM_SHELL_INTERNAL_RUN_AS_NODE: '1' }, stdio: ['ipc'] });
            this.child.on('error', function (err) {
                if (err.code === 'ENOENT' && err.path === _this.node) {
                    _this.gotENOENTonSpawnNode = true;
                }
                console.log('CHILD ERR ONERROR:', err.message, err.stack, err);
                _this.child = null;
            });
            this.child.on('message', function (message) {
                if (message.request) {
                    _this.processRequest(message);
                } else {
                    _this.processResponse(message);
                }
            });
            this.child.stderr.on('data', function (err) {
                console.log('CHILD ERR STDERR:', err.toString());
            });
            this.child.on('close', function (code) {
                if (_this.stopped) {
                    return;
                }
                if (code === orphanExitCode) {
                    _this.startWorker(childJsPath, terminalError, customArguments);
                } else if (_this.gotENOENTonSpawnNode) {
                    terminalError(new Error('gotENOENTonSpawnNode'));
                } else {
                    console.log('ts worker restarting. Don\'t know why it stopped with code:', code);
                    _this.startWorker(childJsPath, terminalError, customArguments);
                }
            });
        } catch (err) {
            terminalError(err);
        }
    };
    Parent.prototype.stopWorker = function () {
        this.stopped = true;
        if (!this.child) return;
        try {
            this.child.kill('SIGTERM');
        } catch (ex) {
            console.error('failed to kill worker child');
        }
        this.child = null;
    };
    return Parent;
})(RequesterResponder);
exports.Parent = Parent;
var Child = (function (_super) {
    __extends(Child, _super);
    function Child() {
        var _this = this;
        _super.call(this);
        this.getProcess = function () {
            return process;
        };
        this.keepAlive();
        process.on('message', function (message) {
            if (message.request) {
                _this.processRequest(message);
            } else {
                _this.processResponse(message);
            }
        });
    }
    Child.prototype.keepAlive = function () {
        setInterval(function () {
            if (!process.connected) {
                process.exit(orphanExitCode);
            }
        }, 1000);
    };
    return Child;
})(RequesterResponder);
exports.Child = Child;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC93b3JrZXIvbGliL3dvcmtlckxpYi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLFNBQVMsR0FBRyxBQUFDLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFLLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRTtBQUN4RCxTQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0RCxhQUFTLEVBQUUsR0FBRztBQUFFLFlBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0tBQUU7QUFDdkMsS0FBQyxDQUFDLFNBQVMsR0FBRyxDQUFDLEtBQUssSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUEsQUFBQyxDQUFDO0NBQ3hGLENBQUM7QUFDRixJQUFJLFlBQVksR0FBRyxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDNUMsSUFBSSxJQUFJLEdBQUcsWUFBWSxDQUFDLElBQUksQ0FBQztBQUM3QixJQUFJLEtBQUssR0FBRyxZQUFZLENBQUMsS0FBSyxDQUFDO0FBQy9CLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixTQUFTLFFBQVEsR0FBRztBQUNoQixXQUFPLHNDQUFzQyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsVUFBVSxDQUFDLEVBQUU7QUFDeEUsWUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDO1lBQUUsQ0FBQyxHQUFHLENBQUMsSUFBSSxHQUFH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QUMsQ0FBQzthQUNqQyxNQUNJO0FBQ0QscUJBQUssQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7YUFDbEM7U0FDSixDQUFDLENBQUM7S0FDTjtBQUNELFNBQUssQ0FBQyxTQUFTLENBQUMsU0FBUyxHQUFHLFlBQVk7QUFDcEMsbUJBQVcsQ0FBQyxZQUFZO0FBQ3BCLGdCQUFJLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRTtBQUNwQix1QkFBTyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQzthQUNoQztTQUNKLEVBQUUsSUFBSSxDQUFDLENBQUM7S0FDWixDQUFDO0FBQ0YsV0FBTyxLQUFLLENBQUM7Q0FDaEIsQ0FBQSxDQUFFLGtCQUFrQixDQUFDLENBQUM7QUFDdkIsT0FBTyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMiLCJmaWxlIjoiL1VzZXJzL2FuZHJld2pvbmVzLy5hdG9tL3BhY2thZ2VzL2F0b20tdHlwZXNjcmlwdC9kaXN0L3dvcmtlci9saWIvd29ya2VyTGliLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIF9fZXh0ZW5kcyA9ICh0aGlzICYmIHRoaXMuX19leHRlbmRzKSB8fCBmdW5jdGlvbiAoZCwgYikge1xuICAgIGZvciAodmFyIHAgaW4gYikgaWYgKGIuaGFzT3duUHJvcGVydHkocCkpIGRbcF0gPSBiW3BdO1xuICAgIGZ1bmN0aW9uIF9fKCkgeyB0aGlzLmNvbnN0cnVjdG9yID0gZDsgfVxuICAgIGQucHJvdG90eXBlID0gYiA9PT0gbnVsbCA/IE9iamVjdC5jcmVhdGUoYikgOiAoX18ucHJvdG90eXBlID0gYi5wcm90b3R5cGUsIG5ldyBfXygpKTtcbn07XG52YXIgY2hpbGRwcm9jZXNzID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xudmFyIGV4ZWMgPSBjaGlsZHByb2Nlc3MuZXhlYztcbnZhciBzcGF3biA9IGNoaWxkcHJvY2Vzcy5zcGF3bjtcbnZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuZnVuY3Rpb24gY3JlYXRlSWQoKSB7XG4gICAgcmV0dXJuICd4eHh4eHh4eC14eHh4LTR4eHgteXh4eC14eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4eV0vZywgZnVuY3Rpb24gKGMpIHtcbiAgICAgICAgdmFyIHIgPSBNYXRoLnJhbmRvbSgpICogMTYgfCAwLCB2ID0gYyA9PSAneCcgPyByIDogKHIgJiAweDMgfCAweDgpO1xuICAgICAgICByZXR1cm4gdi50b1N0cmluZygxNik7XG4gICAgfSk7XG59XG52YXIgb3JwaGFuRXhpdENvZGUgPSAxMDA7XG52YXIgUmVxdWVzdGVyUmVzcG9uZGVyID0gKGZ1bmN0aW9uICgpIHtcbiAgICBmdW5jdGlvbiBSZXF1ZXN0ZXJSZXNwb25kZXIoKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHRoaXMuZ2V0UHJvY2VzcyA9IGZ1bmN0aW9uICgpIHsgdGhyb3cgbmV3IEVycm9yKCdnZXRQcm9jZXNzIGlzIGFic3RyYWN0Jyk7IHJldHVybiBudWxsOyB9O1xuICAgICAgICB0aGlzLmN1cnJlbnRMaXN0ZW5lcnMgPSB7fTtcbiAgICAgICAgdGhpcy5jdXJyZW50TGFzdE9mVHlwZSA9IHt9O1xuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0cyA9IFtdO1xuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c0NoYW5nZWQgPSBmdW5jdGlvbiAocGVuZGluZykgeyByZXR1cm4gbnVsbDsgfTtcbiAgICAgICAgdGhpcy5zZW5kVG9JcGNIZWFydCA9IGZ1bmN0aW9uIChkYXRhLCBtZXNzYWdlKSB7XG4gICAgICAgICAgICBpZiAoIV90aGlzLmdldFByb2Nlc3MoKSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQQVJFTlQgRVJSOiBubyBjaGlsZCB3aGVuIHlvdSB0cmllZCB0byBzZW5kIDonLCBtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiTm8gd29ya2VyIGFjdGl2ZSB0byByZWNpZXZlIG1lc3NhZ2U6IFwiICsgbWVzc2FnZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFfdGhpcy5jdXJyZW50TGlzdGVuZXJzW21lc3NhZ2VdKVxuICAgICAgICAgICAgICAgIF90aGlzLmN1cnJlbnRMaXN0ZW5lcnNbbWVzc2FnZV0gPSB7fTtcbiAgICAgICAgICAgIHZhciBpZCA9IGNyZWF0ZUlkKCk7XG4gICAgICAgICAgICB2YXIgZGVmZXIgPSBQcm9taXNlLmRlZmVyKCk7XG4gICAgICAgICAgICBfdGhpcy5jdXJyZW50TGlzdGVuZXJzW21lc3NhZ2VdW2lkXSA9IGRlZmVyO1xuICAgICAgICAgICAgX3RoaXMucGVuZGluZ1JlcXVlc3RzLnB1c2gobWVzc2FnZSk7XG4gICAgICAgICAgICBfdGhpcy5wZW5kaW5nUmVxdWVzdHNDaGFuZ2VkKF90aGlzLnBlbmRpbmdSZXF1ZXN0cyk7XG4gICAgICAgICAgICBfdGhpcy5nZXRQcm9jZXNzKCkuc2VuZCh7IG1lc3NhZ2U6IG1lc3NhZ2UsIGlkOiBpZCwgZGF0YTogZGF0YSwgcmVxdWVzdDogdHJ1ZSB9KTtcbiAgICAgICAgICAgIHJldHVybiBkZWZlci5wcm9taXNlO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnJlc3BvbmRlcnMgPSB7fTtcbiAgICAgICAgdGhpcy5wcm9jZXNzUmVxdWVzdCA9IGZ1bmN0aW9uIChtKSB7XG4gICAgICAgICAgICB2YXIgcGFyc2VkID0gbTtcbiAgICAgICAgICAgIGlmICghcGFyc2VkLm1lc3NhZ2UgfHwgIV90aGlzLnJlc3BvbmRlcnNbcGFyc2VkLm1lc3NhZ2VdKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBwYXJzZWQubWVzc2FnZTtcbiAgICAgICAgICAgIHZhciByZXNwb25zZVByb21pc2U7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlUHJvbWlzZSA9IF90aGlzLnJlc3BvbmRlcnNbbWVzc2FnZV0ocGFyc2VkLmRhdGEpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICAgIHJlc3BvbnNlUHJvbWlzZSA9IFByb21pc2UucmVqZWN0KHsgbWV0aG9kOiBtZXNzYWdlLCBtZXNzYWdlOiBlcnIubWVzc2FnZSwgc3RhY2s6IGVyci5zdGFjaywgZGV0YWlsczogZXJyLmRldGFpbHMgfHwge30gfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXNwb25zZVByb21pc2VcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5nZXRQcm9jZXNzKCkuc2VuZCh7XG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgIGlkOiBwYXJzZWQuaWQsXG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IHJlc3BvbnNlLFxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgcmVxdWVzdDogZmFsc2VcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikge1xuICAgICAgICAgICAgICAgIF90aGlzLmdldFByb2Nlc3MoKS5zZW5kKHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgaWQ6IHBhcnNlZC5pZCxcbiAgICAgICAgICAgICAgICAgICAgZGF0YTogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLFxuICAgICAgICAgICAgICAgICAgICByZXF1ZXN0OiBmYWxzZVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgfVxuICAgIFJlcXVlc3RlclJlc3BvbmRlci5wcm90b3R5cGUucHJvY2Vzc1Jlc3BvbnNlID0gZnVuY3Rpb24gKG0pIHtcbiAgICAgICAgdmFyIHBhcnNlZCA9IG07XG4gICAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzLnBvcCgpO1xuICAgICAgICB0aGlzLnBlbmRpbmdSZXF1ZXN0c0NoYW5nZWQodGhpcy5wZW5kaW5nUmVxdWVzdHMpO1xuICAgICAgICBpZiAoIXBhcnNlZC5tZXNzYWdlIHx8ICFwYXJzZWQuaWQpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQQVJFTlQgRVJSOiBJbnZhbGlkIEpTT04gZGF0YSBmcm9tIGNoaWxkOicsIG0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKCF0aGlzLmN1cnJlbnRMaXN0ZW5lcnNbcGFyc2VkLm1lc3NhZ2VdIHx8ICF0aGlzLmN1cnJlbnRMaXN0ZW5lcnNbcGFyc2VkLm1lc3NhZ2VdW3BhcnNlZC5pZF0pIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQQVJFTlQgRVJSOiBObyBvbmUgd2FzIGxpc3RlbmluZzonLCBwYXJzZWQubWVzc2FnZSwgcGFyc2VkLmRhdGEpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKHBhcnNlZC5lcnJvcikge1xuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudExpc3RlbmVyc1twYXJzZWQubWVzc2FnZV1bcGFyc2VkLmlkXS5yZWplY3QocGFyc2VkLmVycm9yKTtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhwYXJzZWQuZXJyb3IpO1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHBhcnNlZC5lcnJvci5zdGFjayk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRMaXN0ZW5lcnNbcGFyc2VkLm1lc3NhZ2VdW3BhcnNlZC5pZF0ucmVzb2x2ZShwYXJzZWQuZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBkZWxldGUgdGhpcy5jdXJyZW50TGlzdGVuZXJzW3BhcnNlZC5tZXNzYWdlXVtwYXJzZWQuaWRdO1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudExhc3RPZlR5cGVbcGFyc2VkLm1lc3NhZ2VdKSB7XG4gICAgICAgICAgICAgICAgdmFyIGxhc3QgPSB0aGlzLmN1cnJlbnRMYXN0T2ZUeXBlW3BhcnNlZC5tZXNzYWdlXTtcbiAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jdXJyZW50TGFzdE9mVHlwZVtwYXJzZWQubWVzc2FnZV07XG4gICAgICAgICAgICAgICAgdmFyIGxhc3RQcm9taXNlID0gdGhpcy5zZW5kVG9JcGNIZWFydChsYXN0LmRhdGEsIHBhcnNlZC5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICBsYXN0UHJvbWlzZS50aGVuKGZ1bmN0aW9uIChyZXMpIHsgcmV0dXJuIGxhc3QuZGVmZXIucmVzb2x2ZShyZXMpOyB9LCBmdW5jdGlvbiAocmVqKSB7IHJldHVybiBsYXN0LmRlZmVyLnJlamVjdChyZWopOyB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH07XG4gICAgUmVxdWVzdGVyUmVzcG9uZGVyLnByb3RvdHlwZS5zZW5kVG9JcGMgPSBmdW5jdGlvbiAoZnVuYykge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB2YXIgbWVzc2FnZSA9IGZ1bmMubmFtZTtcbiAgICAgICAgcmV0dXJuIGZ1bmN0aW9uIChkYXRhKSB7IHJldHVybiBfdGhpcy5zZW5kVG9JcGNIZWFydChkYXRhLCBtZXNzYWdlKTsgfTtcbiAgICB9O1xuICAgIFJlcXVlc3RlclJlc3BvbmRlci5wcm90b3R5cGUuc2VuZFRvSXBjT25seUxhc3QgPSBmdW5jdGlvbiAoZnVuYywgZGVmYXVsdFJlc3BvbnNlKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHJldHVybiBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBmdW5jLm5hbWU7XG4gICAgICAgICAgICBpZiAoIV90aGlzLmdldFByb2Nlc3MoKSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdQQVJFTlQgRVJSOiBubyBjaGlsZCB3aGVuIHlvdSB0cmllZCB0byBzZW5kIDonLCBtZXNzYWdlKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZWplY3QobmV3IEVycm9yKFwiTm8gd29ya2VyIGFjdGl2ZSB0byByZWNpZXZlIG1lc3NhZ2U6IFwiICsgbWVzc2FnZSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKCFPYmplY3Qua2V5cyhfdGhpcy5jdXJyZW50TGlzdGVuZXJzW21lc3NhZ2VdIHx8IHt9KS5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gX3RoaXMuc2VuZFRvSXBjSGVhcnQoZGF0YSwgbWVzc2FnZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuY3VycmVudExhc3RPZlR5cGVbbWVzc2FnZV0pIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMuY3VycmVudExhc3RPZlR5cGVbbWVzc2FnZV0uZGVmZXIucmVzb2x2ZShkZWZhdWx0UmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB2YXIgZGVmZXIgPSBQcm9taXNlLmRlZmVyKCk7XG4gICAgICAgICAgICAgICAgX3RoaXMuY3VycmVudExhc3RPZlR5cGVbbWVzc2FnZV0gPSB7XG4gICAgICAgICAgICAgICAgICAgIGRhdGE6IGRhdGEsXG4gICAgICAgICAgICAgICAgICAgIGRlZmVyOiBkZWZlclxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgcmV0dXJuIGRlZmVyLnByb21pc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgfTtcbiAgICBSZXF1ZXN0ZXJSZXNwb25kZXIucHJvdG90eXBlLmFkZFRvUmVzcG9uZGVycyA9IGZ1bmN0aW9uIChmdW5jKSB7XG4gICAgICAgIHRoaXMucmVzcG9uZGVyc1tmdW5jLm5hbWVdID0gZnVuYztcbiAgICB9O1xuICAgIFJlcXVlc3RlclJlc3BvbmRlci5wcm90b3R5cGUucmVnaXN0ZXJBbGxGdW5jdGlvbnNFeHBvcnRlZEZyb21Bc1Jlc3BvbmRlcnMgPSBmdW5jdGlvbiAoYU1vZHVsZSkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICBPYmplY3Qua2V5cyhhTW9kdWxlKVxuICAgICAgICAgICAgLmZpbHRlcihmdW5jdGlvbiAoZnVuY05hbWUpIHsgcmV0dXJuIHR5cGVvZiBhTW9kdWxlW2Z1bmNOYW1lXSA9PSAnZnVuY3Rpb24nOyB9KVxuICAgICAgICAgICAgLmZvckVhY2goZnVuY3Rpb24gKGZ1bmNOYW1lKSB7IHJldHVybiBfdGhpcy5hZGRUb1Jlc3BvbmRlcnMoYU1vZHVsZVtmdW5jTmFtZV0pOyB9KTtcbiAgICB9O1xuICAgIHJldHVybiBSZXF1ZXN0ZXJSZXNwb25kZXI7XG59KSgpO1xudmFyIFBhcmVudCA9IChmdW5jdGlvbiAoX3N1cGVyKSB7XG4gICAgX19leHRlbmRzKFBhcmVudCwgX3N1cGVyKTtcbiAgICBmdW5jdGlvbiBQYXJlbnQoKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIF9zdXBlci5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgICAgICB0aGlzLm5vZGUgPSBwcm9jZXNzLmV4ZWNQYXRoO1xuICAgICAgICB0aGlzLmdvdEVOT0VOVG9uU3Bhd25Ob2RlID0gZmFsc2U7XG4gICAgICAgIHRoaXMuZ2V0UHJvY2VzcyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmNoaWxkOyB9O1xuICAgICAgICB0aGlzLnN0b3BwZWQgPSBmYWxzZTtcbiAgICB9XG4gICAgUGFyZW50LnByb3RvdHlwZS5zdGFydFdvcmtlciA9IGZ1bmN0aW9uIChjaGlsZEpzUGF0aCwgdGVybWluYWxFcnJvciwgY3VzdG9tQXJndW1lbnRzKSB7XG4gICAgICAgIHZhciBfdGhpcyA9IHRoaXM7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLmNoaWxkID0gc3Bhd24odGhpcy5ub2RlLCBbXG4gICAgICAgICAgICAgICAgY2hpbGRKc1BhdGhcbiAgICAgICAgICAgIF0uY29uY2F0KGN1c3RvbUFyZ3VtZW50cyksIHsgY3dkOiBwYXRoLmRpcm5hbWUoY2hpbGRKc1BhdGgpLCBlbnY6IHsgQVRPTV9TSEVMTF9JTlRFUk5BTF9SVU5fQVNfTk9ERTogJzEnIH0sIHN0ZGlvOiBbJ2lwYyddIH0pO1xuICAgICAgICAgICAgdGhpcy5jaGlsZC5vbignZXJyb3InLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgaWYgKGVyci5jb2RlID09PSBcIkVOT0VOVFwiICYmIGVyci5wYXRoID09PSBfdGhpcy5ub2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLmdvdEVOT0VOVG9uU3Bhd25Ob2RlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ0NISUxEIEVSUiBPTkVSUk9SOicsIGVyci5tZXNzYWdlLCBlcnIuc3RhY2ssIGVycik7XG4gICAgICAgICAgICAgICAgX3RoaXMuY2hpbGQgPSBudWxsO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB0aGlzLmNoaWxkLm9uKCdtZXNzYWdlJywgZnVuY3Rpb24gKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5yZXF1ZXN0KSB7XG4gICAgICAgICAgICAgICAgICAgIF90aGlzLnByb2Nlc3NSZXF1ZXN0KG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgX3RoaXMucHJvY2Vzc1Jlc3BvbnNlKG1lc3NhZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgdGhpcy5jaGlsZC5zdGRlcnIub24oJ2RhdGEnLCBmdW5jdGlvbiAoZXJyKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJDSElMRCBFUlIgU1RERVJSOlwiLCBlcnIudG9TdHJpbmcoKSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHRoaXMuY2hpbGQub24oJ2Nsb3NlJywgZnVuY3Rpb24gKGNvZGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoX3RoaXMuc3RvcHBlZCkge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChjb2RlID09PSBvcnBoYW5FeGl0Q29kZSkge1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5zdGFydFdvcmtlcihjaGlsZEpzUGF0aCwgdGVybWluYWxFcnJvciwgY3VzdG9tQXJndW1lbnRzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoX3RoaXMuZ290RU5PRU5Ub25TcGF3bk5vZGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGVybWluYWxFcnJvcihuZXcgRXJyb3IoJ2dvdEVOT0VOVG9uU3Bhd25Ob2RlJykpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coXCJ0cyB3b3JrZXIgcmVzdGFydGluZy4gRG9uJ3Qga25vdyB3aHkgaXQgc3RvcHBlZCB3aXRoIGNvZGU6XCIsIGNvZGUpO1xuICAgICAgICAgICAgICAgICAgICBfdGhpcy5zdGFydFdvcmtlcihjaGlsZEpzUGF0aCwgdGVybWluYWxFcnJvciwgY3VzdG9tQXJndW1lbnRzKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICB0ZXJtaW5hbEVycm9yKGVycik7XG4gICAgICAgIH1cbiAgICB9O1xuICAgIFBhcmVudC5wcm90b3R5cGUuc3RvcFdvcmtlciA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdGhpcy5zdG9wcGVkID0gdHJ1ZTtcbiAgICAgICAgaWYgKCF0aGlzLmNoaWxkKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy5jaGlsZC5raWxsKCdTSUdURVJNJyk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKCdmYWlsZWQgdG8ga2lsbCB3b3JrZXIgY2hpbGQnKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNoaWxkID0gbnVsbDtcbiAgICB9O1xuICAgIHJldHVybiBQYXJlbnQ7XG59KShSZXF1ZXN0ZXJSZXNwb25kZXIpO1xuZXhwb3J0cy5QYXJlbnQgPSBQYXJlbnQ7XG52YXIgQ2hpbGQgPSAoZnVuY3Rpb24gKF9zdXBlcikge1xuICAgIF9fZXh0ZW5kcyhDaGlsZCwgX3N1cGVyKTtcbiAgICBmdW5jdGlvbiBDaGlsZCgpIHtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgX3N1cGVyLmNhbGwodGhpcyk7XG4gICAgICAgIHRoaXMuZ2V0UHJvY2VzcyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHByb2Nlc3M7IH07XG4gICAgICAgIHRoaXMua2VlcEFsaXZlKCk7XG4gICAgICAgIHByb2Nlc3Mub24oJ21lc3NhZ2UnLCBmdW5jdGlvbiAobWVzc2FnZSkge1xuICAgICAgICAgICAgaWYgKG1lc3NhZ2UucmVxdWVzdCkge1xuICAgICAgICAgICAgICAgIF90aGlzLnByb2Nlc3NSZXF1ZXN0KG1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgX3RoaXMucHJvY2Vzc1Jlc3BvbnNlKG1lc3NhZ2UpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9XG4gICAgQ2hpbGQucHJvdG90eXBlLmtlZXBBbGl2ZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgc2V0SW50ZXJ2YWwoZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgaWYgKCFwcm9jZXNzLmNvbm5lY3RlZCkge1xuICAgICAgICAgICAgICAgIHByb2Nlc3MuZXhpdChvcnBoYW5FeGl0Q29kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIDEwMDApO1xuICAgIH07XG4gICAgcmV0dXJuIENoaWxkO1xufSkoUmVxdWVzdGVyUmVzcG9uZGVyKTtcbmV4cG9ydHMuQ2hpbGQgPSBDaGlsZDtcbiJdfQ==