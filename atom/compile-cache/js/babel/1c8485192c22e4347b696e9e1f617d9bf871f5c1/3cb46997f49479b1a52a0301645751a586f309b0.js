var atomConfig = require('./atom/atomConfig');
var makeTypeScriptGlobal_1 = require('../typescript/makeTypeScriptGlobal');
makeTypeScriptGlobal_1.makeTsGlobal(atomConfig.typescriptServices);
var path = require('path');
var fs = require('fs');
var apd = require('atom-package-dependencies');
var mainPanelView_1 = require('./atom/views/mainPanelView');
var autoCompleteProvider = require('./atom/autoCompleteProvider');
var tooltipManager = require('./atom/tooltipManager');
var atomUtils = require('./atom/atomUtils');
var commands = require('./atom/commands/commands');
var onSaveHandler = require('./atom/onSaveHandler');
var debugAtomTs = require('./atom/debugAtomTs');
var atom_space_pen_views_1 = require('atom-space-pen-views');
var documentationView = require('./atom/views/documentationView');
var renameView = require('./atom/views/renameView');
var mainPanelView = require('./atom/views/mainPanelView');
var fileStatusCache_1 = require('./atom/fileStatusCache');
var editorSetup = require('./atom/editorSetup');
var statusBar;
var statusBarMessage;
var editorWatch;
var autoCompleteWatch;
var parent = require('../worker/parent');
exports.config = atomConfig.schema;
var utils_1 = require('./lang/utils');
var hideIfNotActiveOnStart = utils_1.debounce(function () {
    var editor = atom.workspace.getActiveTextEditor();
    if (!atomUtils.onDiskAndTs(editor)) {
        mainPanelView.hide();
    }
}, 100);
var __onlyOnce = false;
function onlyOnceStuff() {
    if (__onlyOnce) return;else __onlyOnce = true;
    documentationView.attach();
    renameView.attach();
}
function readyToActivate() {
    parent.startWorker();
    atom.workspace.onDidChangeActivePaneItem(function (editor) {
        if (atomUtils.onDiskAndTs(editor)) {
            var filePath = editor.getPath();
            parent.errorsForFile({ filePath: filePath }).then(function (resp) {
                mainPanelView_1.errorView.setErrors(filePath, resp.errors);
                atomUtils.triggerLinter();
            });
            mainPanelView.panelView.updateFileStatus(filePath);
            mainPanelView.show();
        } else {
            mainPanelView.hide();
        }
    });
    editorWatch = atom.workspace.observeTextEditors(function (editor) {
        var editorView = atom_space_pen_views_1.$(atom.views.getView(editor));
        tooltipManager.attach(editorView, editor);
        var filePath = editor.getPath();
        var ext = path.extname(filePath);
        if (atomUtils.isAllowedExtension(ext)) {
            var isTst = ext === '.tst';
            try {
                onlyOnceStuff();
                var onDisk = false;
                if (fs.existsSync(filePath)) {
                    onDisk = true;
                }
                mainPanelView.attach();
                hideIfNotActiveOnStart();
                debugAtomTs.runDebugCode({ filePath: filePath, editor: editor });
                if (onDisk) {
                    parent.updateText({ filePath: filePath, text: editor.getText() }).then(function () {
                        return parent.errorsForFile({ filePath: filePath });
                    }).then(function (resp) {
                        return mainPanelView_1.errorView.setErrors(filePath, resp.errors);
                    });
                    parent.getOutputJsStatus({ filePath: filePath }).then(function (res) {
                        var status = fileStatusCache_1.getFileStatus(filePath);
                        status.emitDiffers = res.emitDiffers;
                        var ed = atom.workspace.getActiveTextEditor();
                        if (ed && ed.getPath() === filePath) {
                            mainPanelView.panelView.updateFileStatus(filePath);
                        }
                    });
                }
                editorSetup.setupEditor(editor);
                var changeObserver = editor.onDidStopChanging(function () {
                    if (editor === atom.workspace.getActiveTextEditor()) {
                        var status_1 = fileStatusCache_1.getFileStatus(filePath);
                        status_1.modified = editor.isModified();
                        mainPanelView.panelView.updateFileStatus(filePath);
                    }
                    if (!onDisk) {
                        var root = { line: 0, col: 0 };
                        mainPanelView_1.errorView.setErrors(filePath, [{ startPos: root, endPos: root, filePath: filePath, message: 'Please save file for it be processed by TypeScript', preview: '' }]);
                        return;
                    }
                    parent.errorsForFile({ filePath: filePath }).then(function (resp) {
                        return mainPanelView_1.errorView.setErrors(filePath, resp.errors);
                    });
                });
                var buffer = editor.buffer;
                var fasterChangeObserver = editor.buffer.onDidChange(function (diff) {
                    //// For debugging
                    // console.log(buffer.characterIndexForPosition(diff.oldRange.start), buffer.characterIndexForPosition(diff.oldRange.end), diff.oldText,
                    //     buffer.characterIndexForPosition(diff.newRange.start), buffer.characterIndexForPosition(diff.newRange.end), diff.newText);
                    //// Examples
                    //// 20 20 "aaaa" 20 20 ""
                    //// 23 23 "" 23 24 "a"
                    //// 20 20 "" 20 24 "aaaa"
                    // stack();
                    var newText = diff.newText;
                    var oldText = diff.oldText;
                    var start = { line: diff.oldRange.start.row, col: diff.oldRange.start.column };
                    var end = { line: diff.oldRange.end.row, col: diff.oldRange.end.column };
                    var promise = parent.editText({ filePath: filePath, start: start, end: end, newText: newText });
                });
                var saveObserver = editor.onDidSave(function (event) {
                    onDisk = true;
                    filePath = event.path;
                    onSaveHandler.handle({ filePath: filePath, editor: editor });
                });
                var destroyObserver = editor.onDidDestroy(function () {
                    mainPanelView_1.errorView.setErrors(filePath, []);
                    changeObserver.dispose();
                    fasterChangeObserver.dispose();
                    saveObserver.dispose();
                    destroyObserver.dispose();
                });
            } catch (ex) {
                console.error('Solve this in atom-typescript', ex);
                throw ex;
            }
        }
    });
    commands.registerCommands();
}
function activate(state) {
    var linter = apd.require('linter');
    var acp = apd.require('autocomplete-plus');
    if (!linter || !acp) {
        var notification = atom.notifications.addInfo('AtomTS: Some dependencies not found. Running "apm install" on these for you. Please wait for a success confirmation!', { dismissable: true });
        apd.install(function () {
            atom.notifications.addSuccess('AtomTS: Dependencies installed correctly. Enjoy TypeScript â™¥', { dismissable: true });
            notification.dismiss();
            if (atom.packages.isPackageDisabled('linter')) atom.packages.enablePackage('linter');
            if (atom.packages.isPackageDisabled('autocomplete-plus')) atom.packages.enablePackage('autocomplete-plus');
            if (!apd.require('linter')) atom.packages.loadPackage('linter');
            if (!apd.require('autocomplete-plus')) atom.packages.loadPackage('autocomplete-plus');
            atom.packages.activatePackage('linter').then(function () {
                return atom.packages.activatePackage('autocomplete-plus');
            }).then(function () {
                return waitForGrammarActivation();
            }).then(function () {
                return readyToActivate();
            });
        });
        return;
    }
    waitForGrammarActivation().then(function () {
        return readyToActivate();
    });
}
exports.activate = activate;
function deactivate() {
    if (statusBarMessage) statusBarMessage.destroy();
    if (editorWatch) editorWatch.dispose();
    if (autoCompleteWatch) autoCompleteWatch.dispose();
    parent.stopWorker();
}
exports.deactivate = deactivate;
function serialize() {
    return {};
}
exports.serialize = serialize;
function deserialize() {}
exports.deserialize = deserialize;
function provide() {
    return [autoCompleteProvider.provider];
}
exports.provide = provide;
var linter = require('../linter');
function provideLinter() {
    return linter.provider;
}
exports.provideLinter = provideLinter;
function consumeSnippets(snippetsManager) {
    atomUtils._setSnippetsManager(snippetsManager);
}
exports.consumeSnippets = consumeSnippets;
function waitForGrammarActivation() {
    var activated = false;
    var deferred = Promise.defer();
    var editorWatch = atom.workspace.observeTextEditors(function (editor) {
        if (activated) return;
        editor.observeGrammar(function (grammar) {
            if (grammar.packageName === 'atom-typescript') {
                activated = true;
                deferred.resolve({});
            }
        });
    });
    return deferred.promise.then(function () {
        return editorWatch.dispose();
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2F0b210cy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUM5QyxJQUFJLHNCQUFzQixHQUFHLE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0FBQzNFLHNCQUFzQixDQUFDLFlBQVksQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNuRSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQy9DLElBQUksZUFBZSxHQUFHLE9BQU8sQ0FBQyw0QkFBNEIsQ0FBQyxDQUFDO0FBQzVELElBQUksb0JBQW9CLEdBQUcsT0FBTyxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFDbEUsSUFBSSxjQUFjLEdBQUcsT0FBTyxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFDdEQsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLGtCQUFrQixDQUFDLENBQUM7QUFDNUMsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDbkQsSUFBSSxhQUFhLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDcEQsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLG9CQUFvQixDQUFDLENBQUM7QUFDaEQsSUFBSSxzQkFBc0IsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUM3RCxJQUFJLGlCQUFpQixHQUFHLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2xFLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0FB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QyxZQUFZO0FBQUUsZUFBTyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7S0FBRSxDQUFDLENBQUM7Q0FDL0UiLCJmaWxlIjoiL1VzZXJzL2FuZHJld2pvbmVzLy5hdG9tL3BhY2thZ2VzL2F0b20tdHlwZXNjcmlwdC9kaXN0L21haW4vYXRvbXRzLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGF0b21Db25maWcgPSByZXF1aXJlKCcuL2F0b20vYXRvbUNvbmZpZycpO1xudmFyIG1ha2VUeXBlU2NyaXB0R2xvYmFsXzEgPSByZXF1aXJlKFwiLi4vdHlwZXNjcmlwdC9tYWtlVHlwZVNjcmlwdEdsb2JhbFwiKTtcbm1ha2VUeXBlU2NyaXB0R2xvYmFsXzEubWFrZVRzR2xvYmFsKGF0b21Db25maWcudHlwZXNjcmlwdFNlcnZpY2VzKTtcbnZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBhcGQgPSByZXF1aXJlKCdhdG9tLXBhY2thZ2UtZGVwZW5kZW5jaWVzJyk7XG52YXIgbWFpblBhbmVsVmlld18xID0gcmVxdWlyZShcIi4vYXRvbS92aWV3cy9tYWluUGFuZWxWaWV3XCIpO1xudmFyIGF1dG9Db21wbGV0ZVByb3ZpZGVyID0gcmVxdWlyZSgnLi9hdG9tL2F1dG9Db21wbGV0ZVByb3ZpZGVyJyk7XG52YXIgdG9vbHRpcE1hbmFnZXIgPSByZXF1aXJlKCcuL2F0b20vdG9vbHRpcE1hbmFnZXInKTtcbnZhciBhdG9tVXRpbHMgPSByZXF1aXJlKCcuL2F0b20vYXRvbVV0aWxzJyk7XG52YXIgY29tbWFuZHMgPSByZXF1aXJlKFwiLi9hdG9tL2NvbW1hbmRzL2NvbW1hbmRzXCIpO1xudmFyIG9uU2F2ZUhhbmRsZXIgPSByZXF1aXJlKCcuL2F0b20vb25TYXZlSGFuZGxlcicpO1xudmFyIGRlYnVnQXRvbVRzID0gcmVxdWlyZSgnLi9hdG9tL2RlYnVnQXRvbVRzJyk7XG52YXIgYXRvbV9zcGFjZV9wZW5fdmlld3NfMSA9IHJlcXVpcmUoXCJhdG9tLXNwYWNlLXBlbi12aWV3c1wiKTtcbnZhciBkb2N1bWVudGF0aW9uVmlldyA9IHJlcXVpcmUoJy4vYXRvbS92aWV3cy9kb2N1bWVudGF0aW9uVmlldycpO1xudmFyIHJlbmFtZVZpZXcgPSByZXF1aXJlKCcuL2F0b20vdmlld3MvcmVuYW1lVmlldycpO1xudmFyIG1haW5QYW5lbFZpZXcgPSByZXF1aXJlKFwiLi9hdG9tL3ZpZXdzL21haW5QYW5lbFZpZXdcIik7XG52YXIgZmlsZVN0YXR1c0NhY2hlXzEgPSByZXF1aXJlKFwiLi9hdG9tL2ZpbGVTdGF0dXNDYWNoZVwiKTtcbnZhciBlZGl0b3JTZXR1cCA9IHJlcXVpcmUoXCIuL2F0b20vZWRpdG9yU2V0dXBcIik7XG52YXIgc3RhdHVzQmFyO1xudmFyIHN0YXR1c0Jhck1lc3NhZ2U7XG52YXIgZWRpdG9yV2F0Y2g7XG52YXIgYXV0b0NvbXBsZXRlV2F0Y2g7XG52YXIgcGFyZW50ID0gcmVxdWlyZSgnLi4vd29ya2VyL3BhcmVudCcpO1xuZXhwb3J0cy5jb25maWcgPSBhdG9tQ29uZmlnLnNjaGVtYTtcbnZhciB1dGlsc18xID0gcmVxdWlyZShcIi4vbGFuZy91dGlsc1wiKTtcbnZhciBoaWRlSWZOb3RBY3RpdmVPblN0YXJ0ID0gdXRpbHNfMS5kZWJvdW5jZShmdW5jdGlvbiAoKSB7XG4gICAgdmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcbiAgICBpZiAoIWF0b21VdGlscy5vbkRpc2tBbmRUcyhlZGl0b3IpKSB7XG4gICAgICAgIG1haW5QYW5lbFZpZXcuaGlkZSgpO1xuICAgIH1cbn0sIDEwMCk7XG52YXIgX19vbmx5T25jZSA9IGZhbHNlO1xuZnVuY3Rpb24gb25seU9uY2VTdHVmZigpIHtcbiAgICBpZiAoX19vbmx5T25jZSlcbiAgICAgICAgcmV0dXJuO1xuICAgIGVsc2VcbiAgICAgICAgX19vbmx5T25jZSA9IHRydWU7XG4gICAgZG9jdW1lbnRhdGlvblZpZXcuYXR0YWNoKCk7XG4gICAgcmVuYW1lVmlldy5hdHRhY2goKTtcbn1cbmZ1bmN0aW9uIHJlYWR5VG9BY3RpdmF0ZSgpIHtcbiAgICBwYXJlbnQuc3RhcnRXb3JrZXIoKTtcbiAgICBhdG9tLndvcmtzcGFjZS5vbkRpZENoYW5nZUFjdGl2ZVBhbmVJdGVtKGZ1bmN0aW9uIChlZGl0b3IpIHtcbiAgICAgICAgaWYgKGF0b21VdGlscy5vbkRpc2tBbmRUcyhlZGl0b3IpKSB7XG4gICAgICAgICAgICB2YXIgZmlsZVBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xuICAgICAgICAgICAgcGFyZW50LmVycm9yc0ZvckZpbGUoeyBmaWxlUGF0aDogZmlsZVBhdGggfSlcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzcCkge1xuICAgICAgICAgICAgICAgIG1haW5QYW5lbFZpZXdfMS5lcnJvclZpZXcuc2V0RXJyb3JzKGZpbGVQYXRoLCByZXNwLmVycm9ycyk7XG4gICAgICAgICAgICAgICAgYXRvbVV0aWxzLnRyaWdnZXJMaW50ZXIoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgbWFpblBhbmVsVmlldy5wYW5lbFZpZXcudXBkYXRlRmlsZVN0YXR1cyhmaWxlUGF0aCk7XG4gICAgICAgICAgICBtYWluUGFuZWxWaWV3LnNob3coKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIG1haW5QYW5lbFZpZXcuaGlkZSgpO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgZWRpdG9yV2F0Y2ggPSBhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoZnVuY3Rpb24gKGVkaXRvcikge1xuICAgICAgICB2YXIgZWRpdG9yVmlldyA9IGF0b21fc3BhY2VfcGVuX3ZpZXdzXzEuJChhdG9tLnZpZXdzLmdldFZpZXcoZWRpdG9yKSk7XG4gICAgICAgIHRvb2x0aXBNYW5hZ2VyLmF0dGFjaChlZGl0b3JWaWV3LCBlZGl0b3IpO1xuICAgICAgICB2YXIgZmlsZVBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xuICAgICAgICB2YXIgZXh0ID0gcGF0aC5leHRuYW1lKGZpbGVQYXRoKTtcbiAgICAgICAgaWYgKGF0b21VdGlscy5pc0FsbG93ZWRFeHRlbnNpb24oZXh0KSkge1xuICAgICAgICAgICAgdmFyIGlzVHN0ID0gZXh0ID09PSAnLnRzdCc7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICAgIG9ubHlPbmNlU3R1ZmYoKTtcbiAgICAgICAgICAgICAgICB2YXIgb25EaXNrID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgaWYgKGZzLmV4aXN0c1N5bmMoZmlsZVBhdGgpKSB7XG4gICAgICAgICAgICAgICAgICAgIG9uRGlzayA9IHRydWU7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1haW5QYW5lbFZpZXcuYXR0YWNoKCk7XG4gICAgICAgICAgICAgICAgaGlkZUlmTm90QWN0aXZlT25TdGFydCgpO1xuICAgICAgICAgICAgICAgIGRlYnVnQXRvbVRzLnJ1bkRlYnVnQ29kZSh7IGZpbGVQYXRoOiBmaWxlUGF0aCwgZWRpdG9yOiBlZGl0b3IgfSk7XG4gICAgICAgICAgICAgICAgaWYgKG9uRGlzaykge1xuICAgICAgICAgICAgICAgICAgICBwYXJlbnQudXBkYXRlVGV4dCh7IGZpbGVQYXRoOiBmaWxlUGF0aCwgdGV4dDogZWRpdG9yLmdldFRleHQoKSB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gcGFyZW50LmVycm9yc0ZvckZpbGUoeyBmaWxlUGF0aDogZmlsZVBhdGggfSk7IH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAocmVzcCkgeyByZXR1cm4gbWFpblBhbmVsVmlld18xLmVycm9yVmlldy5zZXRFcnJvcnMoZmlsZVBhdGgsIHJlc3AuZXJyb3JzKTsgfSk7XG4gICAgICAgICAgICAgICAgICAgIHBhcmVudC5nZXRPdXRwdXRKc1N0YXR1cyh7IGZpbGVQYXRoOiBmaWxlUGF0aCB9KS50aGVuKGZ1bmN0aW9uIChyZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBzdGF0dXMgPSBmaWxlU3RhdHVzQ2FjaGVfMS5nZXRGaWxlU3RhdHVzKGZpbGVQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXR1cy5lbWl0RGlmZmVycyA9IHJlcy5lbWl0RGlmZmVycztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBlZCA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChlZCAmJiBlZC5nZXRQYXRoKCkgPT09IGZpbGVQYXRoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFpblBhbmVsVmlldy5wYW5lbFZpZXcudXBkYXRlRmlsZVN0YXR1cyhmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlZGl0b3JTZXR1cC5zZXR1cEVkaXRvcihlZGl0b3IpO1xuICAgICAgICAgICAgICAgIHZhciBjaGFuZ2VPYnNlcnZlciA9IGVkaXRvci5vbkRpZFN0b3BDaGFuZ2luZyhmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChlZGl0b3IgPT09IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXR1c18xID0gZmlsZVN0YXR1c0NhY2hlXzEuZ2V0RmlsZVN0YXR1cyhmaWxlUGF0aCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdGF0dXNfMS5tb2RpZmllZCA9IGVkaXRvci5pc01vZGlmaWVkKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYWluUGFuZWxWaWV3LnBhbmVsVmlldy51cGRhdGVGaWxlU3RhdHVzKGZpbGVQYXRoKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAoIW9uRGlzaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHJvb3QgPSB7IGxpbmU6IDAsIGNvbDogMCB9O1xuICAgICAgICAgICAgICAgICAgICAgICAgbWFpblBhbmVsVmlld18xLmVycm9yVmlldy5zZXRFcnJvcnMoZmlsZVBhdGgsIFt7IHN0YXJ0UG9zOiByb290LCBlbmRQb3M6IHJvb3QsIGZpbGVQYXRoOiBmaWxlUGF0aCwgbWVzc2FnZTogXCJQbGVhc2Ugc2F2ZSBmaWxlIGZvciBpdCBiZSBwcm9jZXNzZWQgYnkgVHlwZVNjcmlwdFwiLCBwcmV2aWV3OiBcIlwiIH1dKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBwYXJlbnQuZXJyb3JzRm9yRmlsZSh7IGZpbGVQYXRoOiBmaWxlUGF0aCB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHsgcmV0dXJuIG1haW5QYW5lbFZpZXdfMS5lcnJvclZpZXcuc2V0RXJyb3JzKGZpbGVQYXRoLCByZXNwLmVycm9ycyk7IH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHZhciBidWZmZXIgPSBlZGl0b3IuYnVmZmVyO1xuICAgICAgICAgICAgICAgIHZhciBmYXN0ZXJDaGFuZ2VPYnNlcnZlciA9IGVkaXRvci5idWZmZXIub25EaWRDaGFuZ2UoZnVuY3Rpb24gKGRpZmYpIHtcbiAgICAgICAgICAgICAgICAgICAgLy8vLyBGb3IgZGVidWdnaW5nXG4gICAgICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKGJ1ZmZlci5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKGRpZmYub2xkUmFuZ2Uuc3RhcnQpLCBidWZmZXIuY2hhcmFjdGVySW5kZXhGb3JQb3NpdGlvbihkaWZmLm9sZFJhbmdlLmVuZCksIGRpZmYub2xkVGV4dCxcbiAgICAgICAgICAgICAgICAgICAgLy8gICAgIGJ1ZmZlci5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKGRpZmYubmV3UmFuZ2Uuc3RhcnQpLCBidWZmZXIuY2hhcmFjdGVySW5kZXhGb3JQb3NpdGlvbihkaWZmLm5ld1JhbmdlLmVuZCksIGRpZmYubmV3VGV4dCk7XG4gICAgICAgICAgICAgICAgICAgIC8vLy8gRXhhbXBsZXNcbiAgICAgICAgICAgICAgICAgICAgLy8vLyAyMCAyMCBcImFhYWFcIiAyMCAyMCBcIlwiXG4gICAgICAgICAgICAgICAgICAgIC8vLy8gMjMgMjMgXCJcIiAyMyAyNCBcImFcIlxuICAgICAgICAgICAgICAgICAgICAvLy8vIDIwIDIwIFwiXCIgMjAgMjQgXCJhYWFhXCJcbiAgICAgICAgICAgICAgICAgICAgLy8gc3RhY2soKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG5ld1RleHQgPSBkaWZmLm5ld1RleHQ7XG4gICAgICAgICAgICAgICAgICAgIHZhciBvbGRUZXh0ID0gZGlmZi5vbGRUZXh0O1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSB7IGxpbmU6IGRpZmYub2xkUmFuZ2Uuc3RhcnQucm93LCBjb2w6IGRpZmYub2xkUmFuZ2Uuc3RhcnQuY29sdW1uIH07XG4gICAgICAgICAgICAgICAgICAgIHZhciBlbmQgPSB7IGxpbmU6IGRpZmYub2xkUmFuZ2UuZW5kLnJvdywgY29sOiBkaWZmLm9sZFJhbmdlLmVuZC5jb2x1bW4gfTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHByb21pc2UgPSBwYXJlbnQuZWRpdFRleHQoeyBmaWxlUGF0aDogZmlsZVBhdGgsIHN0YXJ0OiBzdGFydCwgZW5kOiBlbmQsIG5ld1RleHQ6IG5ld1RleHQgfSk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdmFyIHNhdmVPYnNlcnZlciA9IGVkaXRvci5vbkRpZFNhdmUoZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIG9uRGlzayA9IHRydWU7XG4gICAgICAgICAgICAgICAgICAgIGZpbGVQYXRoID0gZXZlbnQucGF0aDtcbiAgICAgICAgICAgICAgICAgICAgb25TYXZlSGFuZGxlci5oYW5kbGUoeyBmaWxlUGF0aDogZmlsZVBhdGgsIGVkaXRvcjogZWRpdG9yIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHZhciBkZXN0cm95T2JzZXJ2ZXIgPSBlZGl0b3Iub25EaWREZXN0cm95KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgbWFpblBhbmVsVmlld18xLmVycm9yVmlldy5zZXRFcnJvcnMoZmlsZVBhdGgsIFtdKTtcbiAgICAgICAgICAgICAgICAgICAgY2hhbmdlT2JzZXJ2ZXIuZGlzcG9zZSgpO1xuICAgICAgICAgICAgICAgICAgICBmYXN0ZXJDaGFuZ2VPYnNlcnZlci5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNhdmVPYnNlcnZlci5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgICAgIGRlc3Ryb3lPYnNlcnZlci5kaXNwb3NlKCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdTb2x2ZSB0aGlzIGluIGF0b20tdHlwZXNjcmlwdCcsIGV4KTtcbiAgICAgICAgICAgICAgICB0aHJvdyBleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0pO1xuICAgIGNvbW1hbmRzLnJlZ2lzdGVyQ29tbWFuZHMoKTtcbn1cbmZ1bmN0aW9uIGFjdGl2YXRlKHN0YXRlKSB7XG4gICAgdmFyIGxpbnRlciA9IGFwZC5yZXF1aXJlKCdsaW50ZXInKTtcbiAgICB2YXIgYWNwID0gYXBkLnJlcXVpcmUoJ2F1dG9jb21wbGV0ZS1wbHVzJyk7XG4gICAgaWYgKCFsaW50ZXIgfHwgIWFjcCkge1xuICAgICAgICB2YXIgbm90aWZpY2F0aW9uID0gYXRvbS5ub3RpZmljYXRpb25zLmFkZEluZm8oJ0F0b21UUzogU29tZSBkZXBlbmRlbmNpZXMgbm90IGZvdW5kLiBSdW5uaW5nIFwiYXBtIGluc3RhbGxcIiBvbiB0aGVzZSBmb3IgeW91LiBQbGVhc2Ugd2FpdCBmb3IgYSBzdWNjZXNzIGNvbmZpcm1hdGlvbiEnLCB7IGRpc21pc3NhYmxlOiB0cnVlIH0pO1xuICAgICAgICBhcGQuaW5zdGFsbChmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkU3VjY2VzcyhcIkF0b21UUzogRGVwZW5kZW5jaWVzIGluc3RhbGxlZCBjb3JyZWN0bHkuIEVuam95IFR5cGVTY3JpcHQgXFx1MjY2NVwiLCB7IGRpc21pc3NhYmxlOiB0cnVlIH0pO1xuICAgICAgICAgICAgbm90aWZpY2F0aW9uLmRpc21pc3MoKTtcbiAgICAgICAgICAgIGlmIChhdG9tLnBhY2thZ2VzLmlzUGFja2FnZURpc2FibGVkKCdsaW50ZXInKSlcbiAgICAgICAgICAgICAgICBhdG9tLnBhY2thZ2VzLmVuYWJsZVBhY2thZ2UoJ2xpbnRlcicpO1xuICAgICAgICAgICAgaWYgKGF0b20ucGFja2FnZXMuaXNQYWNrYWdlRGlzYWJsZWQoJ2F1dG9jb21wbGV0ZS1wbHVzJykpXG4gICAgICAgICAgICAgICAgYXRvbS5wYWNrYWdlcy5lbmFibGVQYWNrYWdlKCdhdXRvY29tcGxldGUtcGx1cycpO1xuICAgICAgICAgICAgaWYgKCFhcGQucmVxdWlyZSgnbGludGVyJykpXG4gICAgICAgICAgICAgICAgYXRvbS5wYWNrYWdlcy5sb2FkUGFja2FnZSgnbGludGVyJyk7XG4gICAgICAgICAgICBpZiAoIWFwZC5yZXF1aXJlKCdhdXRvY29tcGxldGUtcGx1cycpKVxuICAgICAgICAgICAgICAgIGF0b20ucGFja2FnZXMubG9hZFBhY2thZ2UoJ2F1dG9jb21wbGV0ZS1wbHVzJyk7XG4gICAgICAgICAgICBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZSgnbGludGVyJylcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBhdG9tLnBhY2thZ2VzLmFjdGl2YXRlUGFja2FnZSgnYXV0b2NvbXBsZXRlLXBsdXMnKTsgfSlcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiB3YWl0Rm9yR3JhbW1hckFjdGl2YXRpb24oKTsgfSlcbiAgICAgICAgICAgICAgICAudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiByZWFkeVRvQWN0aXZhdGUoKTsgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm47XG4gICAgfVxuICAgIHdhaXRGb3JHcmFtbWFyQWN0aXZhdGlvbigpLnRoZW4oZnVuY3Rpb24gKCkgeyByZXR1cm4gcmVhZHlUb0FjdGl2YXRlKCk7IH0pO1xufVxuZXhwb3J0cy5hY3RpdmF0ZSA9IGFjdGl2YXRlO1xuZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgICBpZiAoc3RhdHVzQmFyTWVzc2FnZSlcbiAgICAgICAgc3RhdHVzQmFyTWVzc2FnZS5kZXN0cm95KCk7XG4gICAgaWYgKGVkaXRvcldhdGNoKVxuICAgICAgICBlZGl0b3JXYXRjaC5kaXNwb3NlKCk7XG4gICAgaWYgKGF1dG9Db21wbGV0ZVdhdGNoKVxuICAgICAgICBhdXRvQ29tcGxldGVXYXRjaC5kaXNwb3NlKCk7XG4gICAgcGFyZW50LnN0b3BXb3JrZXIoKTtcbn1cbmV4cG9ydHMuZGVhY3RpdmF0ZSA9IGRlYWN0aXZhdGU7XG5mdW5jdGlvbiBzZXJpYWxpemUoKSB7XG4gICAgcmV0dXJuIHt9O1xufVxuZXhwb3J0cy5zZXJpYWxpemUgPSBzZXJpYWxpemU7XG5mdW5jdGlvbiBkZXNlcmlhbGl6ZSgpIHtcbn1cbmV4cG9ydHMuZGVzZXJpYWxpemUgPSBkZXNlcmlhbGl6ZTtcbmZ1bmN0aW9uIHByb3ZpZGUoKSB7XG4gICAgcmV0dXJuIFthdXRvQ29tcGxldGVQcm92aWRlci5wcm92aWRlcl07XG59XG5leHBvcnRzLnByb3ZpZGUgPSBwcm92aWRlO1xudmFyIGxpbnRlciA9IHJlcXVpcmUoXCIuLi9saW50ZXJcIik7XG5mdW5jdGlvbiBwcm92aWRlTGludGVyKCkge1xuICAgIHJldHVybiBsaW50ZXIucHJvdmlkZXI7XG59XG5leHBvcnRzLnByb3ZpZGVMaW50ZXIgPSBwcm92aWRlTGludGVyO1xuZnVuY3Rpb24gY29uc3VtZVNuaXBwZXRzKHNuaXBwZXRzTWFuYWdlcikge1xuICAgIGF0b21VdGlscy5fc2V0U25pcHBldHNNYW5hZ2VyKHNuaXBwZXRzTWFuYWdlcik7XG59XG5leHBvcnRzLmNvbnN1bWVTbmlwcGV0cyA9IGNvbnN1bWVTbmlwcGV0cztcbmZ1bmN0aW9uIHdhaXRGb3JHcmFtbWFyQWN0aXZhdGlvbigpIHtcbiAgICB2YXIgYWN0aXZhdGVkID0gZmFsc2U7XG4gICAgdmFyIGRlZmVycmVkID0gUHJvbWlzZS5kZWZlcigpO1xuICAgIHZhciBlZGl0b3JXYXRjaCA9IGF0b20ud29ya3NwYWNlLm9ic2VydmVUZXh0RWRpdG9ycyhmdW5jdGlvbiAoZWRpdG9yKSB7XG4gICAgICAgIGlmIChhY3RpdmF0ZWQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIGVkaXRvci5vYnNlcnZlR3JhbW1hcihmdW5jdGlvbiAoZ3JhbW1hcikge1xuICAgICAgICAgICAgaWYgKGdyYW1tYXIucGFja2FnZU5hbWUgPT09ICdhdG9tLXR5cGVzY3JpcHQnKSB7XG4gICAgICAgICAgICAgICAgYWN0aXZhdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICBkZWZlcnJlZC5yZXNvbHZlKHt9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGRlZmVycmVkLnByb21pc2UudGhlbihmdW5jdGlvbiAoKSB7IHJldHVybiBlZGl0b3JXYXRjaC5kaXNwb3NlKCk7IH0pO1xufVxuIl19