var fs = require("fs");
var path = require("path");
var tsconfig = require("../tsconfig/tsconfig");
var project_1 = require("./core/project");
var fsu = require("../utils/fsUtil");
var queryParent = require("../../worker/queryParent");
exports.queryParent = queryParent;
var child;
function fixChild(childInjected) {
    child = childInjected;
    queryParent.echoNumWithModification = child.sendToIpc(queryParent.echoNumWithModification);
    queryParent.getUpdatedTextForUnsavedEditors = child.sendToIpc(queryParent.getUpdatedTextForUnsavedEditors);
    queryParent.getOpenEditorPaths = child.sendToIpc(queryParent.getOpenEditorPaths);
    queryParent.setConfigurationError = child.sendToIpc(queryParent.setConfigurationError);
    queryParent.notifySuccess = child.sendToIpc(queryParent.notifySuccess);
    queryParent.buildUpdate = child.sendToIpc(queryParent.buildUpdate);
}
exports.fixChild = fixChild;
function consistentPath(query) {
    if (!query.filePath) return;
    query.filePath = fsu.consistentPath(query.filePath);
}
exports.consistentPath = consistentPath;
var projectByProjectFilePath = {};
var projectByFilePath = {};
var watchingProjectFile = {};
function watchProjectFileIfNotDoingItAlready(projectFilePath) {
    if (!fs.existsSync(projectFilePath)) {
        return;
    }
    if (watchingProjectFile[projectFilePath]) return;
    watchingProjectFile[projectFilePath] = true;
    fs.watch(projectFilePath, { persistent: false, recursive: false }, function () {
        if (!fs.existsSync(projectFilePath)) {
            var project = projectByProjectFilePath[projectFilePath];
            if (project) {
                var files = project.projectFile.project.files;
                delete projectByProjectFilePath[projectFilePath];
                files.forEach(function (file) {
                    return delete projectByFilePath[file];
                });
            }
            return;
        }
        try {
            var projectFile = getOrCreateProjectFile(projectFilePath);
            cacheAndCreateProject(projectFile);
            queryParent.setConfigurationError({ projectFilePath: projectFile.projectFilePath, error: null });
        } catch (ex) {}
    });
}
function cacheAndCreateProject(projectFile) {
    var project = projectByProjectFilePath[projectFile.projectFilePath] = new project_1.Project(projectFile);
    projectFile.project.files.forEach(function (file) {
        return projectByFilePath[file] = project;
    });
    queryParent.getUpdatedTextForUnsavedEditors({}).then(function (resp) {
        resp.editors.forEach(function (e) {
            consistentPath(e);
            project.languageServiceHost.updateScript(e.filePath, e.text);
        });
    });
    watchProjectFileIfNotDoingItAlready(projectFile.projectFilePath);
    return project;
}
exports.cacheAndCreateProject = cacheAndCreateProject;
function getOrCreateProjectFile(filePath) {
    try {
        if (path.dirname(filePath) == project_1.languageServiceHost.typescriptDirectory) {
            return tsconfig.getDefaultInMemoryProject(filePath);
        }
        var projectFile = tsconfig.getProjectSync(filePath);
        queryParent.setConfigurationError({ projectFilePath: projectFile.projectFilePath, error: null });
        return projectFile;
    } catch (ex) {
        var err = ex;
        if (err.message === tsconfig.errors.GET_PROJECT_NO_PROJECT_FOUND) {
            if (tsconfig.endsWith(filePath.toLowerCase(), ".d.ts")) {
                return tsconfig.getDefaultInMemoryProject(filePath);
            } else {
                var details = ex.details;
                queryParent.setConfigurationError({
                    projectFilePath: details.projectFilePath,
                    error: {
                        message: ex.message,
                        details: ex.details
                    }
                });
            }
        }
        if (ex.message === tsconfig.errors.GET_PROJECT_JSON_PARSE_FAILED) {
            var details0 = ex.details;
            queryParent.setConfigurationError({
                projectFilePath: details0.projectFilePath,
                error: {
                    message: ex.message,
                    details: ex.details
                }
            });
            watchProjectFileIfNotDoingItAlready(details0.projectFilePath);
        }
        if (ex.message === tsconfig.errors.GET_PROJECT_PROJECT_FILE_INVALID_OPTIONS) {
            var details1 = ex.details;
            queryParent.setConfigurationError({
                projectFilePath: details1.projectFilePath,
                error: {
                    message: ex.message,
                    details: ex.details
                }
            });
            watchProjectFileIfNotDoingItAlready(details1.projectFilePath);
        }
        if (ex.message === tsconfig.errors.GET_PROJECT_GLOB_EXPAND_FAILED) {
            var details2 = ex.details;
            queryParent.setConfigurationError({
                projectFilePath: details2.projectFilePath,
                error: {
                    message: ex.message,
                    details: ex.details
                }
            });
            watchProjectFileIfNotDoingItAlready(details2.projectFilePath);
        }
        throw ex;
    }
}
exports.getOrCreateProjectFile = getOrCreateProjectFile;
function getOrCreateProject(filePath) {
    if (tsconfig.endsWith(filePath, ".tst")) {
        filePath = filePath + ".ts";
    }
    filePath = fsu.consistentPath(filePath);
    if (projectByFilePath[filePath]) {
        return projectByFilePath[filePath];
    } else {
        var projectFile = getOrCreateProjectFile(filePath);
        var project = cacheAndCreateProject(projectFile);
        return project;
    }
}
exports.getOrCreateProject = getOrCreateProject;
function resetCache(query) {
    projectByProjectFilePath = {};
    projectByFilePath = {};
    if (query.filePath) {
        consistentPath(query);
        var project = getOrCreateProject(query.filePath);
        project.languageServiceHost.updateScript(query.filePath, query.text);
    }
    queryParent.getUpdatedTextForUnsavedEditors({}).then(function (resp) {
        resp.editors.forEach(function (e) {
            consistentPath(e);
            var proj = getOrCreateProject(e.filePath);
            proj.languageServiceHost.updateScript(e.filePath, e.text);
        });
    });
}
exports.resetCache = resetCache;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2xhbmcvcHJvamVjdENhY2hlLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUN2QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxRQUFRLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUM7QUFDL0MsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7QUFDMUMsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDckMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLDBCQUEwQixDQUFDLENBQUM7QUFDdEQsT0FBTyxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7QUFDbEMsSUFBSSxLQUFLLENBQUM7QUFDVixTQUFTLFFBQVEsQ0FBQyxhQUFhLEVBQUU7QUFDN0IsU0FBSyxHQUFHLGFBQWEsQ0FBQztBQUN0QixlQUFXLENBQUMsdUJBQXVCLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsdUJBQXVCLENBQUMsQ0FBQztBQUMzRixlQUFXLENBQUMsK0JBQStCLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsK0JBQStCLENBQUMsQ0FBQztBQUMzRyxlQUFXLENBQUMsa0JBQWtCLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsQ0FBQztBQUNqRixlQUFXLENBQUMscUJBQXFCLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxXQUFXLENBQUMscUJBQXFCLENBQUMsQ0FBQztBQUN2RixlQUFXLENBQUMsYUFBYSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FB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QUFFO0FBQ3RCLFlBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxFQUFFO0FBQzlCLDBCQUFjLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbEIsZ0JBQUksSUFBSSxHQUFHLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQyxnQkFBSSxDQUFDLG1CQUFtQixDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUM3RCxDQUFDLENBQUM7S0FDTixDQUFDLENBQUM7Q0FDTjtBQUNELE9BQU8sQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDIiwiZmlsZSI6Ii9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2xhbmcvcHJvamVjdENhY2hlLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGZzID0gcmVxdWlyZShcImZzXCIpO1xudmFyIHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcbnZhciB0c2NvbmZpZyA9IHJlcXVpcmUoXCIuLi90c2NvbmZpZy90c2NvbmZpZ1wiKTtcbnZhciBwcm9qZWN0XzEgPSByZXF1aXJlKFwiLi9jb3JlL3Byb2plY3RcIik7XG52YXIgZnN1ID0gcmVxdWlyZShcIi4uL3V0aWxzL2ZzVXRpbFwiKTtcbnZhciBxdWVyeVBhcmVudCA9IHJlcXVpcmUoJy4uLy4uL3dvcmtlci9xdWVyeVBhcmVudCcpO1xuZXhwb3J0cy5xdWVyeVBhcmVudCA9IHF1ZXJ5UGFyZW50O1xudmFyIGNoaWxkO1xuZnVuY3Rpb24gZml4Q2hpbGQoY2hpbGRJbmplY3RlZCkge1xuICAgIGNoaWxkID0gY2hpbGRJbmplY3RlZDtcbiAgICBxdWVyeVBhcmVudC5lY2hvTnVtV2l0aE1vZGlmaWNhdGlvbiA9IGNoaWxkLnNlbmRUb0lwYyhxdWVyeVBhcmVudC5lY2hvTnVtV2l0aE1vZGlmaWNhdGlvbik7XG4gICAgcXVlcnlQYXJlbnQuZ2V0VXBkYXRlZFRleHRGb3JVbnNhdmVkRWRpdG9ycyA9IGNoaWxkLnNlbmRUb0lwYyhxdWVyeVBhcmVudC5nZXRVcGRhdGVkVGV4dEZvclVuc2F2ZWRFZGl0b3JzKTtcbiAgICBxdWVyeVBhcmVudC5nZXRPcGVuRWRpdG9yUGF0aHMgPSBjaGlsZC5zZW5kVG9JcGMocXVlcnlQYXJlbnQuZ2V0T3BlbkVkaXRvclBhdGhzKTtcbiAgICBxdWVyeVBhcmVudC5zZXRDb25maWd1cmF0aW9uRXJyb3IgPSBjaGlsZC5zZW5kVG9JcGMocXVlcnlQYXJlbnQuc2V0Q29uZmlndXJhdGlvbkVycm9yKTtcbiAgICBxdWVyeVBhcmVudC5ub3RpZnlTdWNjZXNzID0gY2hpbGQuc2VuZFRvSXBjKHF1ZXJ5UGFyZW50Lm5vdGlmeVN1Y2Nlc3MpO1xuICAgIHF1ZXJ5UGFyZW50LmJ1aWxkVXBkYXRlID0gY2hpbGQuc2VuZFRvSXBjKHF1ZXJ5UGFyZW50LmJ1aWxkVXBkYXRlKTtcbn1cbmV4cG9ydHMuZml4Q2hpbGQgPSBmaXhDaGlsZDtcbmZ1bmN0aW9uIGNvbnNpc3RlbnRQYXRoKHF1ZXJ5KSB7XG4gICAgaWYgKCFxdWVyeS5maWxlUGF0aClcbiAgICAgICAgcmV0dXJuO1xuICAgIHF1ZXJ5LmZpbGVQYXRoID0gZnN1LmNvbnNpc3RlbnRQYXRoKHF1ZXJ5LmZpbGVQYXRoKTtcbn1cbmV4cG9ydHMuY29uc2lzdGVudFBhdGggPSBjb25zaXN0ZW50UGF0aDtcbnZhciBwcm9qZWN0QnlQcm9qZWN0RmlsZVBhdGggPSB7fTtcbnZhciBwcm9qZWN0QnlGaWxlUGF0aCA9IHt9O1xudmFyIHdhdGNoaW5nUHJvamVjdEZpbGUgPSB7fTtcbmZ1bmN0aW9uIHdhdGNoUHJvamVjdEZpbGVJZk5vdERvaW5nSXRBbHJlYWR5KHByb2plY3RGaWxlUGF0aCkge1xuICAgIGlmICghZnMuZXhpc3RzU3luYyhwcm9qZWN0RmlsZVBhdGgpKSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG4gICAgaWYgKHdhdGNoaW5nUHJvamVjdEZpbGVbcHJvamVjdEZpbGVQYXRoXSlcbiAgICAgICAgcmV0dXJuO1xuICAgIHdhdGNoaW5nUHJvamVjdEZpbGVbcHJvamVjdEZpbGVQYXRoXSA9IHRydWU7XG4gICAgZnMud2F0Y2gocHJvamVjdEZpbGVQYXRoLCB7IHBlcnNpc3RlbnQ6IGZhbHNlLCByZWN1cnNpdmU6IGZhbHNlIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHByb2plY3RGaWxlUGF0aCkpIHtcbiAgICAgICAgICAgIHZhciBwcm9qZWN0ID0gcHJvamVjdEJ5UHJvamVjdEZpbGVQYXRoW3Byb2plY3RGaWxlUGF0aF07XG4gICAgICAgICAgICBpZiAocHJvamVjdCkge1xuICAgICAgICAgICAgICAgIHZhciBmaWxlcyA9IHByb2plY3QucHJvamVjdEZpbGUucHJvamVjdC5maWxlcztcbiAgICAgICAgICAgICAgICBkZWxldGUgcHJvamVjdEJ5UHJvamVjdEZpbGVQYXRoW3Byb2plY3RGaWxlUGF0aF07XG4gICAgICAgICAgICAgICAgZmlsZXMuZm9yRWFjaChmdW5jdGlvbiAoZmlsZSkgeyByZXR1cm4gZGVsZXRlIHByb2plY3RCeUZpbGVQYXRoW2ZpbGVdOyB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdmFyIHByb2plY3RGaWxlID0gZ2V0T3JDcmVhdGVQcm9qZWN0RmlsZShwcm9qZWN0RmlsZVBhdGgpO1xuICAgICAgICAgICAgY2FjaGVBbmRDcmVhdGVQcm9qZWN0KHByb2plY3RGaWxlKTtcbiAgICAgICAgICAgIHF1ZXJ5UGFyZW50LnNldENvbmZpZ3VyYXRpb25FcnJvcih7IHByb2plY3RGaWxlUGF0aDogcHJvamVjdEZpbGUucHJvamVjdEZpbGVQYXRoLCBlcnJvcjogbnVsbCB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXgpIHtcbiAgICAgICAgfVxuICAgIH0pO1xufVxuZnVuY3Rpb24gY2FjaGVBbmRDcmVhdGVQcm9qZWN0KHByb2plY3RGaWxlKSB7XG4gICAgdmFyIHByb2plY3QgPSBwcm9qZWN0QnlQcm9qZWN0RmlsZVBhdGhbcHJvamVjdEZpbGUucHJvamVjdEZpbGVQYXRoXSA9IG5ldyBwcm9qZWN0XzEuUHJvamVjdChwcm9qZWN0RmlsZSk7XG4gICAgcHJvamVjdEZpbGUucHJvamVjdC5maWxlcy5mb3JFYWNoKGZ1bmN0aW9uIChmaWxlKSB7IHJldHVybiBwcm9qZWN0QnlGaWxlUGF0aFtmaWxlXSA9IHByb2plY3Q7IH0pO1xuICAgIHF1ZXJ5UGFyZW50LmdldFVwZGF0ZWRUZXh0Rm9yVW5zYXZlZEVkaXRvcnMoe30pXG4gICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwKSB7XG4gICAgICAgIHJlc3AuZWRpdG9ycy5mb3JFYWNoKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBjb25zaXN0ZW50UGF0aChlKTtcbiAgICAgICAgICAgIHByb2plY3QubGFuZ3VhZ2VTZXJ2aWNlSG9zdC51cGRhdGVTY3JpcHQoZS5maWxlUGF0aCwgZS50ZXh0KTtcbiAgICAgICAgfSk7XG4gICAgfSk7XG4gICAgd2F0Y2hQcm9qZWN0RmlsZUlmTm90RG9pbmdJdEFscmVhZHkocHJvamVjdEZpbGUucHJvamVjdEZpbGVQYXRoKTtcbiAgICByZXR1cm4gcHJvamVjdDtcbn1cbmV4cG9ydHMuY2FjaGVBbmRDcmVhdGVQcm9qZWN0ID0gY2FjaGVBbmRDcmVhdGVQcm9qZWN0O1xuZnVuY3Rpb24gZ2V0T3JDcmVhdGVQcm9qZWN0RmlsZShmaWxlUGF0aCkge1xuICAgIHRyeSB7XG4gICAgICAgIGlmIChwYXRoLmRpcm5hbWUoZmlsZVBhdGgpID09IHByb2plY3RfMS5sYW5ndWFnZVNlcnZpY2VIb3N0LnR5cGVzY3JpcHREaXJlY3RvcnkpIHtcbiAgICAgICAgICAgIHJldHVybiB0c2NvbmZpZy5nZXREZWZhdWx0SW5NZW1vcnlQcm9qZWN0KGZpbGVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICB2YXIgcHJvamVjdEZpbGUgPSB0c2NvbmZpZy5nZXRQcm9qZWN0U3luYyhmaWxlUGF0aCk7XG4gICAgICAgIHF1ZXJ5UGFyZW50LnNldENvbmZpZ3VyYXRpb25FcnJvcih7IHByb2plY3RGaWxlUGF0aDogcHJvamVjdEZpbGUucHJvamVjdEZpbGVQYXRoLCBlcnJvcjogbnVsbCB9KTtcbiAgICAgICAgcmV0dXJuIHByb2plY3RGaWxlO1xuICAgIH1cbiAgICBjYXRjaCAoZXgpIHtcbiAgICAgICAgdmFyIGVyciA9IGV4O1xuICAgICAgICBpZiAoZXJyLm1lc3NhZ2UgPT09IHRzY29uZmlnLmVycm9ycy5HRVRfUFJPSkVDVF9OT19QUk9KRUNUX0ZPVU5EKSB7XG4gICAgICAgICAgICBpZiAodHNjb25maWcuZW5kc1dpdGgoZmlsZVBhdGgudG9Mb3dlckNhc2UoKSwgJy5kLnRzJykpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdHNjb25maWcuZ2V0RGVmYXVsdEluTWVtb3J5UHJvamVjdChmaWxlUGF0aCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB2YXIgZGV0YWlscyA9IGV4LmRldGFpbHM7XG4gICAgICAgICAgICAgICAgcXVlcnlQYXJlbnQuc2V0Q29uZmlndXJhdGlvbkVycm9yKHtcbiAgICAgICAgICAgICAgICAgICAgcHJvamVjdEZpbGVQYXRoOiBkZXRhaWxzLnByb2plY3RGaWxlUGF0aCxcbiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IGV4Lm1lc3NhZ2UsXG4gICAgICAgICAgICAgICAgICAgICAgICBkZXRhaWxzOiBleC5kZXRhaWxzXG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoZXgubWVzc2FnZSA9PT0gdHNjb25maWcuZXJyb3JzLkdFVF9QUk9KRUNUX0pTT05fUEFSU0VfRkFJTEVEKSB7XG4gICAgICAgICAgICB2YXIgZGV0YWlsczAgPSBleC5kZXRhaWxzO1xuICAgICAgICAgICAgcXVlcnlQYXJlbnQuc2V0Q29uZmlndXJhdGlvbkVycm9yKHtcbiAgICAgICAgICAgICAgICBwcm9qZWN0RmlsZVBhdGg6IGRldGFpbHMwLnByb2plY3RGaWxlUGF0aCxcbiAgICAgICAgICAgICAgICBlcnJvcjoge1xuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBleC5tZXNzYWdlLFxuICAgICAgICAgICAgICAgICAgICBkZXRhaWxzOiBleC5kZXRhaWxzXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB3YXRjaFByb2plY3RGaWxlSWZOb3REb2luZ0l0QWxyZWFkeShkZXRhaWxzMC5wcm9qZWN0RmlsZVBhdGgpO1xuICAgICAgICB9XG4gICAgICAgIGlmIChleC5tZXNzYWdlID09PSB0c2NvbmZpZy5lcnJvcnMuR0VUX1BST0pFQ1RfUFJPSkVDVF9GSUxFX0lOVkFMSURfT1BUSU9OUykge1xuICAgICAgICAgICAgdmFyIGRldGFpbHMxID0gZXguZGV0YWlscztcbiAgICAgICAgICAgIHF1ZXJ5UGFyZW50LnNldENvbmZpZ3VyYXRpb25FcnJvcih7XG4gICAgICAgICAgICAgICAgcHJvamVjdEZpbGVQYXRoOiBkZXRhaWxzMS5wcm9qZWN0RmlsZVBhdGgsXG4gICAgICAgICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXgubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogZXguZGV0YWlsc1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgd2F0Y2hQcm9qZWN0RmlsZUlmTm90RG9pbmdJdEFscmVhZHkoZGV0YWlsczEucHJvamVjdEZpbGVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoZXgubWVzc2FnZSA9PT0gdHNjb25maWcuZXJyb3JzLkdFVF9QUk9KRUNUX0dMT0JfRVhQQU5EX0ZBSUxFRCkge1xuICAgICAgICAgICAgdmFyIGRldGFpbHMyID0gZXguZGV0YWlscztcbiAgICAgICAgICAgIHF1ZXJ5UGFyZW50LnNldENvbmZpZ3VyYXRpb25FcnJvcih7XG4gICAgICAgICAgICAgICAgcHJvamVjdEZpbGVQYXRoOiBkZXRhaWxzMi5wcm9qZWN0RmlsZVBhdGgsXG4gICAgICAgICAgICAgICAgZXJyb3I6IHtcbiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZTogZXgubWVzc2FnZSxcbiAgICAgICAgICAgICAgICAgICAgZGV0YWlsczogZXguZGV0YWlsc1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgd2F0Y2hQcm9qZWN0RmlsZUlmTm90RG9pbmdJdEFscmVhZHkoZGV0YWlsczIucHJvamVjdEZpbGVQYXRoKTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBleDtcbiAgICB9XG59XG5leHBvcnRzLmdldE9yQ3JlYXRlUHJvamVjdEZpbGUgPSBnZXRPckNyZWF0ZVByb2plY3RGaWxlO1xuZnVuY3Rpb24gZ2V0T3JDcmVhdGVQcm9qZWN0KGZpbGVQYXRoKSB7XG4gICAgaWYgKHRzY29uZmlnLmVuZHNXaXRoKGZpbGVQYXRoLCAnLnRzdCcpKSB7XG4gICAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGggKyAnLnRzJztcbiAgICB9XG4gICAgZmlsZVBhdGggPSBmc3UuY29uc2lzdGVudFBhdGgoZmlsZVBhdGgpO1xuICAgIGlmIChwcm9qZWN0QnlGaWxlUGF0aFtmaWxlUGF0aF0pIHtcbiAgICAgICAgcmV0dXJuIHByb2plY3RCeUZpbGVQYXRoW2ZpbGVQYXRoXTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciBwcm9qZWN0RmlsZSA9IGdldE9yQ3JlYXRlUHJvamVjdEZpbGUoZmlsZVBhdGgpO1xuICAgICAgICB2YXIgcHJvamVjdCA9IGNhY2hlQW5kQ3JlYXRlUHJvamVjdChwcm9qZWN0RmlsZSk7XG4gICAgICAgIHJldHVybiBwcm9qZWN0O1xuICAgIH1cbn1cbmV4cG9ydHMuZ2V0T3JDcmVhdGVQcm9qZWN0ID0gZ2V0T3JDcmVhdGVQcm9qZWN0O1xuZnVuY3Rpb24gcmVzZXRDYWNoZShxdWVyeSkge1xuICAgIHByb2plY3RCeVByb2plY3RGaWxlUGF0aCA9IHt9O1xuICAgIHByb2plY3RCeUZpbGVQYXRoID0ge307XG4gICAgaWYgKHF1ZXJ5LmZpbGVQYXRoKSB7XG4gICAgICAgIGNvbnNpc3RlbnRQYXRoKHF1ZXJ5KTtcbiAgICAgICAgdmFyIHByb2plY3QgPSBnZXRPckNyZWF0ZVByb2plY3QocXVlcnkuZmlsZVBhdGgpO1xuICAgICAgICBwcm9qZWN0Lmxhbmd1YWdlU2VydmljZUhvc3QudXBkYXRlU2NyaXB0KHF1ZXJ5LmZpbGVQYXRoLCBxdWVyeS50ZXh0KTtcbiAgICB9XG4gICAgcXVlcnlQYXJlbnQuZ2V0VXBkYXRlZFRleHRGb3JVbnNhdmVkRWRpdG9ycyh7fSlcbiAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHtcbiAgICAgICAgcmVzcC5lZGl0b3JzLmZvckVhY2goZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGNvbnNpc3RlbnRQYXRoKGUpO1xuICAgICAgICAgICAgdmFyIHByb2ogPSBnZXRPckNyZWF0ZVByb2plY3QoZS5maWxlUGF0aCk7XG4gICAgICAgICAgICBwcm9qLmxhbmd1YWdlU2VydmljZUhvc3QudXBkYXRlU2NyaXB0KGUuZmlsZVBhdGgsIGUudGV4dCk7XG4gICAgICAgIH0pO1xuICAgIH0pO1xufVxuZXhwb3J0cy5yZXNldENhY2hlID0gcmVzZXRDYWNoZTtcbiJdfQ==