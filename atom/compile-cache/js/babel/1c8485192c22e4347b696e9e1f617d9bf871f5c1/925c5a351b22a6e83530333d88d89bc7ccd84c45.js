var __extends = this && this.__extends || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() {
        this.constructor = d;
    }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var sp = require("atom-space-pen-views");
var atomUtils = require("../atomUtils");
var parent = require("../../../worker/parent");
var d3 = require("d3");
exports.astURI = "ts-ast:";
exports.astURIFull = "ts-ast-full:";
var AstView = (function (_super) {
    __extends(AstView, _super);
    function AstView(filePath, text, full) {
        var _this = this;
        _super.call(this);
        this.filePath = filePath;
        this.text = text;
        this.full = full;
        this.getURI = function () {
            return atomUtils.uriForPath(_this.full ? exports.astURIFull : exports.astURI, _this.filePath);
        };
        this.getTitle = function () {
            return "TypeScript AST";
        };
        this.getIconName = function () {
            return "repo-forked";
        };
        this.init();
    }
    AstView.content = function () {
        var _this = this;
        return this.div({ "class": "ast-view" }, function () {
            _this.div({ style: "display: flex" }, function () {
                _this.div({ outlet: "mainContent", style: "width: 50%" });
                _this.pre({ "class": "raw-display", outlet: "rawDisplay", style: "width: 50%" });
            });
        });
    };
    AstView.prototype.init = function () {
        var _this = this;
        if (this.full) {
            var query = parent.getASTFull({ filePath: this.filePath });
        } else {
            query = parent.getAST({ filePath: this.filePath });
        }
        query.then(function (res) {
            renderTree(res.root, _this.mainContent, function (node) {
                var display = ("\n" + node.kind + "\n-------------------- AST --------------------\n" + node.rawJson + "\n-------------------- TEXT -------------------\n" + _this.text.substring(node.pos, node.end) + "\n                ").trim();
                _this.rawDisplay.text(display);
            });
        });
    };
    return AstView;
})(sp.ScrollView);
exports.AstView = AstView;
function renderTree(rootNode, _mainContent, display) {
    var root = {
        dom: _mainContent[0],
        jq: _mainContent
    };
    var margin = { top: 30, right: 20, bottom: 30, left: 20 };
    var width = root.jq.width() - margin.left - margin.right;
    var barHeight = 30;
    var barWidth = width * .8;
    var i = 0,
        duration = 400;
    var tree = d3.layout.tree().nodeSize([0, 20]);
    var diagonal = d3.svg.diagonal().projection(function (d) {
        return [d.y, d.x];
    });
    var graphRoot = d3.select(root.dom).append("svg").attr("width", width + margin.left + margin.right);
    var graph = graphRoot.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    var selected;
    select(rootNode);
    function update() {
        var nodes = tree.nodes(rootNode);
        var height = Math.max(500, nodes.length * barHeight + margin.top + margin.bottom);
        d3.select("svg").transition().duration(duration).attr("height", height);
        d3.select(self.frameElement).transition().duration(duration).style("height", height + "px");
        nodes.forEach(function (n, i) {
            n.x = i * barHeight;
        });
        var node = graph.selectAll("g.node").data(nodes, function (d) {
            return d.id || (d.id = ++i);
        });
        var nodeEnter = node.enter().append("g").attr("class", "node").attr("transform", function (d) {
            return "translate(" + rootNode.depth + "," + rootNode.nodeIndex + ")";
        }).style("opacity", 1e-6);
        nodeEnter.append("rect").attr("y", -barHeight / 2).attr("height", barHeight).attr("width", barWidth).style("fill", color).on("click", select);
        nodeEnter.append("text").attr("dy", 3.5).attr("dx", 5.5).text(function (d) {
            return d.kind;
        });
        nodeEnter.transition().duration(duration).attr("transform", function (d) {
            return "translate(" + d.y + "," + d.x + ")";
        }).style("opacity", 1);
        node.transition().duration(duration).attr("transform", function (d) {
            return "translate(" + d.y + "," + d.x + ")";
        }).style("opacity", 1).select("rect").style("fill", color);
        node.exit().transition().duration(duration).attr("transform", function (d) {
            return "translate(" + rootNode.nodeIndex + "," + rootNode.depth + ")";
        }).style("opacity", 1e-6).remove();
        var link = graph.selectAll("path.link").data(tree.links(nodes), function (d) {
            return d.target.id;
        });
        link.enter().insert("path", "g").attr("class", "link").attr("d", function (d) {
            var o = { x: rootNode.depth, y: rootNode.nodeIndex };
            return diagonal({ source: o, target: o });
        }).transition().duration(duration).attr("d", diagonal);
        link.transition().duration(duration).attr("d", diagonal);
        link.exit().transition().duration(duration).attr("d", function (d) {
            var o = { x: rootNode.depth, y: rootNode.nodeIndex };
            return diagonal({ source: o, target: o });
        }).remove();
    }
    function resize() {
        width = root.jq.width() - margin.left - margin.right;
        d3.select("svg").attr("width", width);
        update();
    }
    d3.select(root.dom).on("resize", resize);
    resize();
    function select(node) {
        display(node);
        selected = node;
        update();
    }
    function color(d) {
        if (selected == d) {
            return "rgb(140, 0, 0)";
        }
        return d.children ? "#000000" : "rgb(29, 166, 0)";
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2F0b20vdmlld3MvYXN0Vmlldy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLFNBQVMsR0FBRyxBQUFDLElBQUksSUFBSSxJQUFJLENBQUMsU0FBUyxJQUFLLFVBQVUsQ0FBQyxFQUFFLENBQUMsRUFBRTtBQUN4RCxTQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxjQUFjLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN0RCxhQUFTLEVBQUUsR0FBRztBQUFFLFlBQUksQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0tBQUU7QUFDdkMsS0FBQyxDQUFDLFNBQVMsR0FBRyxDQUFDLEtBQUssSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxFQUFFLENBQUEsQUFBQyxDQUFDO0NBQ3hGLENBQUM7QUFDRixJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUN6QyxJQUFJLFNBQVMsR0FBRyxPQUFPLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDeEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFDL0MsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLE9BQU8sQ0FBQyxNQUFNLEdBQUcsU0FBUyxDQUFDO0FBQzNCLE9BQU8sQ0FBQyxVQUFVLEdBQUcsY0FBYyxDQUFDO0FBQ3BDLElBQUksT0FBTyxHQUFHLENBQUMsVUFBVSxNQUFNLEVBQUU7QUFDN0IsYUFBUyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FB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Q0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQ3pDLFVBQU0sRUFBRSxDQUFDO0FBQ1QsYUFBUyxNQUFNLENBQUMsSUFBSSxFQUFFO0FBQ2xCLGVBQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNkLGdCQUFRLEdBQUcsSUFBSSxDQUFDO0FBQ2hCLGNBQU0sRUFBRSxDQUFDO0tBQ1o7QUFDRCxhQUFTLEtBQUssQ0FBQyxDQUFDLEVBQUU7QUFDZCxZQUFJLFFBQVEsSUFBSSxDQUFDLEVBQUU7QUFDZixtQkFBTyxnQkFBZ0IsQ0FBQztTQUMzQjtBQUNELGVBQU8sQ0FBQyxDQUFDLFFBQVEsR0FBRyxTQUFTLEdBQUcsaUJBQWlCLENBQUM7S0FDckQ7Q0FDSiIsImZpbGUiOiIvVXNlcnMvYW5kcmV3am9uZXMvLmF0b20vcGFja2FnZXMvYXRvbS10eXBlc2NyaXB0L2Rpc3QvbWFpbi9hdG9tL3ZpZXdzL2FzdFZpZXcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgX19leHRlbmRzID0gKHRoaXMgJiYgdGhpcy5fX2V4dGVuZHMpIHx8IGZ1bmN0aW9uIChkLCBiKSB7XG4gICAgZm9yICh2YXIgcCBpbiBiKSBpZiAoYi5oYXNPd25Qcm9wZXJ0eShwKSkgZFtwXSA9IGJbcF07XG4gICAgZnVuY3Rpb24gX18oKSB7IHRoaXMuY29uc3RydWN0b3IgPSBkOyB9XG4gICAgZC5wcm90b3R5cGUgPSBiID09PSBudWxsID8gT2JqZWN0LmNyZWF0ZShiKSA6IChfXy5wcm90b3R5cGUgPSBiLnByb3RvdHlwZSwgbmV3IF9fKCkpO1xufTtcbnZhciBzcCA9IHJlcXVpcmUoJ2F0b20tc3BhY2UtcGVuLXZpZXdzJyk7XG52YXIgYXRvbVV0aWxzID0gcmVxdWlyZShcIi4uL2F0b21VdGlsc1wiKTtcbnZhciBwYXJlbnQgPSByZXF1aXJlKFwiLi4vLi4vLi4vd29ya2VyL3BhcmVudFwiKTtcbnZhciBkMyA9IHJlcXVpcmUoXCJkM1wiKTtcbmV4cG9ydHMuYXN0VVJJID0gXCJ0cy1hc3Q6XCI7XG5leHBvcnRzLmFzdFVSSUZ1bGwgPSBcInRzLWFzdC1mdWxsOlwiO1xudmFyIEFzdFZpZXcgPSAoZnVuY3Rpb24gKF9zdXBlcikge1xuICAgIF9fZXh0ZW5kcyhBc3RWaWV3LCBfc3VwZXIpO1xuICAgIGZ1bmN0aW9uIEFzdFZpZXcoZmlsZVBhdGgsIHRleHQsIGZ1bGwpIHtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgX3N1cGVyLmNhbGwodGhpcyk7XG4gICAgICAgIHRoaXMuZmlsZVBhdGggPSBmaWxlUGF0aDtcbiAgICAgICAgdGhpcy50ZXh0ID0gdGV4dDtcbiAgICAgICAgdGhpcy5mdWxsID0gZnVsbDtcbiAgICAgICAgdGhpcy5nZXRVUkkgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBhdG9tVXRpbHMudXJpRm9yUGF0aChfdGhpcy5mdWxsID8gZXhwb3J0cy5hc3RVUklGdWxsIDogZXhwb3J0cy5hc3RVUkksIF90aGlzLmZpbGVQYXRoKTsgfTtcbiAgICAgICAgdGhpcy5nZXRUaXRsZSA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuICdUeXBlU2NyaXB0IEFTVCc7IH07XG4gICAgICAgIHRoaXMuZ2V0SWNvbk5hbWUgPSBmdW5jdGlvbiAoKSB7IHJldHVybiAncmVwby1mb3JrZWQnOyB9O1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICB9XG4gICAgQXN0Vmlldy5jb250ZW50ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICByZXR1cm4gdGhpcy5kaXYoeyBjbGFzczogJ2FzdC12aWV3JyB9LCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBfdGhpcy5kaXYoeyBzdHlsZTogJ2Rpc3BsYXk6IGZsZXgnIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5kaXYoeyBvdXRsZXQ6ICdtYWluQ29udGVudCcsIHN0eWxlOiAnd2lkdGg6IDUwJScgfSk7XG4gICAgICAgICAgICAgICAgX3RoaXMucHJlKHsgY2xhc3M6ICdyYXctZGlzcGxheScsIG91dGxldDogJ3Jhd0Rpc3BsYXknLCBzdHlsZTogJ3dpZHRoOiA1MCUnIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgQXN0Vmlldy5wcm90b3R5cGUuaW5pdCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgdmFyIF90aGlzID0gdGhpcztcbiAgICAgICAgaWYgKHRoaXMuZnVsbCkge1xuICAgICAgICAgICAgdmFyIHF1ZXJ5ID0gcGFyZW50LmdldEFTVEZ1bGwoeyBmaWxlUGF0aDogdGhpcy5maWxlUGF0aCB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHF1ZXJ5ID0gcGFyZW50LmdldEFTVCh7IGZpbGVQYXRoOiB0aGlzLmZpbGVQYXRoIH0pO1xuICAgICAgICB9XG4gICAgICAgIHF1ZXJ5LnRoZW4oZnVuY3Rpb24gKHJlcykge1xuICAgICAgICAgICAgcmVuZGVyVHJlZShyZXMucm9vdCwgX3RoaXMubWFpbkNvbnRlbnQsIGZ1bmN0aW9uIChub2RlKSB7XG4gICAgICAgICAgICAgICAgdmFyIGRpc3BsYXkgPSAoXCJcXG5cIiArIG5vZGUua2luZCArIFwiXFxuLS0tLS0tLS0tLS0tLS0tLS0tLS0gQVNUIC0tLS0tLS0tLS0tLS0tLS0tLS0tXFxuXCIgKyBub2RlLnJhd0pzb24gKyBcIlxcbi0tLS0tLS0tLS0tLS0tLS0tLS0tIFRFWFQgLS0tLS0tLS0tLS0tLS0tLS0tLVxcblwiICsgX3RoaXMudGV4dC5zdWJzdHJpbmcobm9kZS5wb3MsIG5vZGUuZW5kKSArIFwiXFxuICAgICAgICAgICAgICAgIFwiKS50cmltKCk7XG4gICAgICAgICAgICAgICAgX3RoaXMucmF3RGlzcGxheS50ZXh0KGRpc3BsYXkpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH07XG4gICAgcmV0dXJuIEFzdFZpZXc7XG59KShzcC5TY3JvbGxWaWV3KTtcbmV4cG9ydHMuQXN0VmlldyA9IEFzdFZpZXc7XG5mdW5jdGlvbiByZW5kZXJUcmVlKHJvb3ROb2RlLCBfbWFpbkNvbnRlbnQsIGRpc3BsYXkpIHtcbiAgICB2YXIgcm9vdCA9IHtcbiAgICAgICAgZG9tOiBfbWFpbkNvbnRlbnRbMF0sXG4gICAgICAgIGpxOiBfbWFpbkNvbnRlbnRcbiAgICB9O1xuICAgIHZhciBtYXJnaW4gPSB7IHRvcDogMzAsIHJpZ2h0OiAyMCwgYm90dG9tOiAzMCwgbGVmdDogMjAgfTtcbiAgICB2YXIgd2lkdGggPSByb290LmpxLndpZHRoKCkgLSBtYXJnaW4ubGVmdCAtIG1hcmdpbi5yaWdodDtcbiAgICB2YXIgYmFySGVpZ2h0ID0gMzA7XG4gICAgdmFyIGJhcldpZHRoID0gd2lkdGggKiAuODtcbiAgICB2YXIgaSA9IDAsIGR1cmF0aW9uID0gNDAwO1xuICAgIHZhciB0cmVlID0gZDMubGF5b3V0LnRyZWUoKVxuICAgICAgICAubm9kZVNpemUoWzAsIDIwXSk7XG4gICAgdmFyIGRpYWdvbmFsID0gZDMuc3ZnLmRpYWdvbmFsKClcbiAgICAgICAgLnByb2plY3Rpb24oZnVuY3Rpb24gKGQpIHsgcmV0dXJuIFtkLnksIGQueF07IH0pO1xuICAgIHZhciBncmFwaFJvb3QgPSBkMy5zZWxlY3Qocm9vdC5kb20pLmFwcGVuZChcInN2Z1wiKVxuICAgICAgICAuYXR0cihcIndpZHRoXCIsIHdpZHRoICsgbWFyZ2luLmxlZnQgKyBtYXJnaW4ucmlnaHQpO1xuICAgIHZhciBncmFwaCA9IGdyYXBoUm9vdC5hcHBlbmQoXCJnXCIpXG4gICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIFwidHJhbnNsYXRlKFwiICsgbWFyZ2luLmxlZnQgKyBcIixcIiArIG1hcmdpbi50b3AgKyBcIilcIik7XG4gICAgdmFyIHNlbGVjdGVkO1xuICAgIHNlbGVjdChyb290Tm9kZSk7XG4gICAgZnVuY3Rpb24gdXBkYXRlKCkge1xuICAgICAgICB2YXIgbm9kZXMgPSB0cmVlLm5vZGVzKHJvb3ROb2RlKTtcbiAgICAgICAgdmFyIGhlaWdodCA9IE1hdGgubWF4KDUwMCwgbm9kZXMubGVuZ3RoICogYmFySGVpZ2h0ICsgbWFyZ2luLnRvcCArIG1hcmdpbi5ib3R0b20pO1xuICAgICAgICBkMy5zZWxlY3QoXCJzdmdcIikudHJhbnNpdGlvbigpXG4gICAgICAgICAgICAuZHVyYXRpb24oZHVyYXRpb24pXG4gICAgICAgICAgICAuYXR0cihcImhlaWdodFwiLCBoZWlnaHQpO1xuICAgICAgICBkMy5zZWxlY3Qoc2VsZi5mcmFtZUVsZW1lbnQpLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgLmR1cmF0aW9uKGR1cmF0aW9uKVxuICAgICAgICAgICAgLnN0eWxlKFwiaGVpZ2h0XCIsIGhlaWdodCArIFwicHhcIik7XG4gICAgICAgIG5vZGVzLmZvckVhY2goZnVuY3Rpb24gKG4sIGkpIHtcbiAgICAgICAgICAgIG4ueCA9IGkgKiBiYXJIZWlnaHQ7XG4gICAgICAgIH0pO1xuICAgICAgICB2YXIgbm9kZSA9IGdyYXBoLnNlbGVjdEFsbChcImcubm9kZVwiKVxuICAgICAgICAgICAgLmRhdGEobm9kZXMsIGZ1bmN0aW9uIChkKSB7IHJldHVybiBkLmlkIHx8IChkLmlkID0gKytpKTsgfSk7XG4gICAgICAgIHZhciBub2RlRW50ZXIgPSBub2RlLmVudGVyKCkuYXBwZW5kKFwiZ1wiKVxuICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcIm5vZGVcIilcbiAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIGZ1bmN0aW9uIChkKSB7IHJldHVybiBcInRyYW5zbGF0ZShcIiArIHJvb3ROb2RlLmRlcHRoICsgXCIsXCIgKyByb290Tm9kZS5ub2RlSW5kZXggKyBcIilcIjsgfSlcbiAgICAgICAgICAgIC5zdHlsZShcIm9wYWNpdHlcIiwgMWUtNik7XG4gICAgICAgIG5vZGVFbnRlci5hcHBlbmQoXCJyZWN0XCIpXG4gICAgICAgICAgICAuYXR0cihcInlcIiwgLWJhckhlaWdodCAvIDIpXG4gICAgICAgICAgICAuYXR0cihcImhlaWdodFwiLCBiYXJIZWlnaHQpXG4gICAgICAgICAgICAuYXR0cihcIndpZHRoXCIsIGJhcldpZHRoKVxuICAgICAgICAgICAgLnN0eWxlKFwiZmlsbFwiLCBjb2xvcilcbiAgICAgICAgICAgIC5vbihcImNsaWNrXCIsIHNlbGVjdCk7XG4gICAgICAgIG5vZGVFbnRlci5hcHBlbmQoXCJ0ZXh0XCIpXG4gICAgICAgICAgICAuYXR0cihcImR5XCIsIDMuNSlcbiAgICAgICAgICAgIC5hdHRyKFwiZHhcIiwgNS41KVxuICAgICAgICAgICAgLnRleHQoZnVuY3Rpb24gKGQpIHtcbiAgICAgICAgICAgIHJldHVybiBkLmtpbmQ7XG4gICAgICAgIH0pO1xuICAgICAgICBub2RlRW50ZXIudHJhbnNpdGlvbigpXG4gICAgICAgICAgICAuZHVyYXRpb24oZHVyYXRpb24pXG4gICAgICAgICAgICAuYXR0cihcInRyYW5zZm9ybVwiLCBmdW5jdGlvbiAoZCkgeyByZXR1cm4gXCJ0cmFuc2xhdGUoXCIgKyBkLnkgKyBcIixcIiArIGQueCArIFwiKVwiOyB9KVxuICAgICAgICAgICAgLnN0eWxlKFwib3BhY2l0eVwiLCAxKTtcbiAgICAgICAgbm9kZS50cmFuc2l0aW9uKClcbiAgICAgICAgICAgIC5kdXJhdGlvbihkdXJhdGlvbilcbiAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIGZ1bmN0aW9uIChkKSB7IHJldHVybiBcInRyYW5zbGF0ZShcIiArIGQueSArIFwiLFwiICsgZC54ICsgXCIpXCI7IH0pXG4gICAgICAgICAgICAuc3R5bGUoXCJvcGFjaXR5XCIsIDEpXG4gICAgICAgICAgICAuc2VsZWN0KFwicmVjdFwiKVxuICAgICAgICAgICAgLnN0eWxlKFwiZmlsbFwiLCBjb2xvcik7XG4gICAgICAgIG5vZGUuZXhpdCgpLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgLmR1cmF0aW9uKGR1cmF0aW9uKVxuICAgICAgICAgICAgLmF0dHIoXCJ0cmFuc2Zvcm1cIiwgZnVuY3Rpb24gKGQpIHsgcmV0dXJuIFwidHJhbnNsYXRlKFwiICsgcm9vdE5vZGUubm9kZUluZGV4ICsgXCIsXCIgKyByb290Tm9kZS5kZXB0aCArIFwiKVwiOyB9KVxuICAgICAgICAgICAgLnN0eWxlKFwib3BhY2l0eVwiLCAxZS02KVxuICAgICAgICAgICAgLnJlbW92ZSgpO1xuICAgICAgICB2YXIgbGluayA9IGdyYXBoLnNlbGVjdEFsbChcInBhdGgubGlua1wiKVxuICAgICAgICAgICAgLmRhdGEodHJlZS5saW5rcyhub2RlcyksIGZ1bmN0aW9uIChkKSB7IHJldHVybiBkLnRhcmdldC5pZDsgfSk7XG4gICAgICAgIGxpbmsuZW50ZXIoKS5pbnNlcnQoXCJwYXRoXCIsIFwiZ1wiKVxuICAgICAgICAgICAgLmF0dHIoXCJjbGFzc1wiLCBcImxpbmtcIilcbiAgICAgICAgICAgIC5hdHRyKFwiZFwiLCBmdW5jdGlvbiAoZCkge1xuICAgICAgICAgICAgdmFyIG8gPSB7IHg6IHJvb3ROb2RlLmRlcHRoLCB5OiByb290Tm9kZS5ub2RlSW5kZXggfTtcbiAgICAgICAgICAgIHJldHVybiBkaWFnb25hbCh7IHNvdXJjZTogbywgdGFyZ2V0OiBvIH0pO1xuICAgICAgICB9KVxuICAgICAgICAgICAgLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgLmR1cmF0aW9uKGR1cmF0aW9uKVxuICAgICAgICAgICAgLmF0dHIoXCJkXCIsIGRpYWdvbmFsKTtcbiAgICAgICAgbGluay50cmFuc2l0aW9uKClcbiAgICAgICAgICAgIC5kdXJhdGlvbihkdXJhdGlvbilcbiAgICAgICAgICAgIC5hdHRyKFwiZFwiLCBkaWFnb25hbCk7XG4gICAgICAgIGxpbmsuZXhpdCgpLnRyYW5zaXRpb24oKVxuICAgICAgICAgICAgLmR1cmF0aW9uKGR1cmF0aW9uKVxuICAgICAgICAgICAgLmF0dHIoXCJkXCIsIGZ1bmN0aW9uIChkKSB7XG4gICAgICAgICAgICB2YXIgbyA9IHsgeDogcm9vdE5vZGUuZGVwdGgsIHk6IHJvb3ROb2RlLm5vZGVJbmRleCB9O1xuICAgICAgICAgICAgcmV0dXJuIGRpYWdvbmFsKHsgc291cmNlOiBvLCB0YXJnZXQ6IG8gfSk7XG4gICAgICAgIH0pXG4gICAgICAgICAgICAucmVtb3ZlKCk7XG4gICAgfVxuICAgIGZ1bmN0aW9uIHJlc2l6ZSgpIHtcbiAgICAgICAgd2lkdGggPSByb290LmpxLndpZHRoKCkgLSBtYXJnaW4ubGVmdCAtIG1hcmdpbi5yaWdodDtcbiAgICAgICAgZDMuc2VsZWN0KFwic3ZnXCIpLmF0dHIoXCJ3aWR0aFwiLCB3aWR0aCk7XG4gICAgICAgIHVwZGF0ZSgpO1xuICAgIH1cbiAgICBkMy5zZWxlY3Qocm9vdC5kb20pLm9uKFwicmVzaXplXCIsIHJlc2l6ZSk7XG4gICAgcmVzaXplKCk7XG4gICAgZnVuY3Rpb24gc2VsZWN0KG5vZGUpIHtcbiAgICAgICAgZGlzcGxheShub2RlKTtcbiAgICAgICAgc2VsZWN0ZWQgPSBub2RlO1xuICAgICAgICB1cGRhdGUoKTtcbiAgICB9XG4gICAgZnVuY3Rpb24gY29sb3IoZCkge1xuICAgICAgICBpZiAoc2VsZWN0ZWQgPT0gZCkge1xuICAgICAgICAgICAgcmV0dXJuIFwicmdiKDE0MCwgMCwgMClcIjtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZC5jaGlsZHJlbiA/IFwiIzAwMDAwMFwiIDogXCJyZ2IoMjksIDE2NiwgMClcIjtcbiAgICB9XG59XG4iXX0=