'use babel';

var createRemoteConnection = _asyncToGenerator(function* (remoteProjectConfig) {
  var RemoteConnection = getRemoteConnection();

  try {
    var connection = new RemoteConnection(restoreClientKey(remoteProjectConfig));
    yield connection.initialize();
    return connection;
  } catch (e) {
    // If connection fails using saved config, open connect dialog.

    var _require4 = require('nuclide-ssh-dialog');

    var openConnectionDialog = _require4.openConnectionDialog;

    return openConnectionDialog({
      initialServer: remoteProjectConfig.host,
      initialCwd: remoteProjectConfig.cwd
    });
  }
});

/**
 * Restore a nuclide project state from a serialized state of the remote connection config.
 */

var restoreNuclideProjectState = _asyncToGenerator(function* (remoteProjectConfig) {
  // TODO use the rest of the config for the connection dialog.
  var projectHostname = remoteProjectConfig.host;
  var projectDirectory = remoteProjectConfig.cwd;

  // try to re-connect, then, add the project to atom.project and the tree.
  var connection = yield createRemoteConnection(remoteProjectConfig);
  if (!connection) {
    getLogger().info('No RemoteConnection returned on restore state trial:', projectHostname, projectDirectory);
  }
  // Reload the project files that have empty text editors/buffers open.
  var closedUris = closeOpenFilesForRemoteProject(remoteProjectConfig);
  // On Atom restart, it tries to open the uri path as a file tab because it's not a local directory.
  // Hence, we close it in the cleanup, because we have the needed connection config saved
  // with the last opened files in the package state.
  if (connection) {
    closedUris.forEach(function (uri) {
      return atom.workspace.open(uri);
    });
  }
});

/**
 * The same TextEditor must be returned to prevent Atom from creating multiple tabs
 * for the same file, because Atom doesn't cache pending opener promises.
 */

var createEditorForNuclide = _asyncToGenerator(function* (connection, uri) {
  var NuclideTextBuffer = require('./NuclideTextBuffer');

  var buffer = new NuclideTextBuffer(connection, { filePath: uri });
  buffer.setEncoding(atom.config.get('core.fileEncoding'));
  try {
    yield buffer.load();
  } catch (err) {
    getLogger().warn('buffer load issue:', err);
    throw err;
  }
  return new TextEditor( /*editorOptions*/{ buffer: buffer, registerEditor: true });
});

function _slicedToArray(arr, i) { if (Array.isArray(arr)) { return arr; } else if (Symbol.iterator in Object(arr)) { var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i['return']) _i['return'](); } finally { if (_d) throw _e; } } return _arr; } else { throw new TypeError('Invalid attempt to destructure non-iterable instance'); } }

function _asyncToGenerator(fn) { return function () { var gen = fn.apply(this, arguments); return new Promise(function (resolve, reject) { var callNext = step.bind(null, 'next'); var callThrow = step.bind(null, 'throw'); function step(key, arg) { try { var info = gen[key](arg); var value = info.value; } catch (error) { reject(error); return; } if (info.done) { resolve(value); } else { Promise.resolve(value).then(callNext, callThrow); } } callNext(); }); }; }

/* @flow */

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var _require = require('atom');

var CompositeDisposable = _require.CompositeDisposable;
var TextEditor = _require.TextEditor;

var _require2 = require('nuclide-client');

var getServiceByNuclideUri = _require2.getServiceByNuclideUri;

var _require3 = require('nuclide-remote-connection');

var RemoteDirectory = _require3.RemoteDirectory;

var subscriptions = null;
var pendingFiles = {};

var logger = null;
function getLogger() {
  return logger || (logger = require('nuclide-logging').getLogger());
}

var RemoteConnection = null;
function getRemoteConnection() {
  return RemoteConnection || (RemoteConnection = require('nuclide-remote-connection').RemoteConnection);
}

function addRemoteFolderToProject(connection) {
  var workingDirectoryUri = connection.getUriForInitialWorkingDirectory();
  // If restoring state, then the project already exists with local directory and wrong repo instances.
  // Hence, we remove it here, if existing, and add the new path for which we added a workspace opener handler.
  atom.project.removePath(workingDirectoryUri);

  atom.project.addPath(workingDirectoryUri);

  var subscription = atom.project.onDidChangePaths(function (paths) {
    if (paths.indexOf(workingDirectoryUri) !== -1) {
      return;
    }
    // The project was removed from the tree.
    subscription.dispose();

    closeOpenFilesForRemoteProject(connection.getConfig());

    var hostname = connection.getRemoteHostname();
    if (getRemoteConnection().getByHostname(hostname).length > 1) {
      getLogger().info('Remaining remote projects using Nuclide Server - no prompt to shutdown');
      return connection.close();
    }

    var choice = atom.confirm({
      message: 'No more remote projects on the host: \'' + hostname + '\'. Would you like to shutdown Nuclide server there?',
      buttons: ['Shutdown', 'Keep It']
    });
    if (choice === 1) {
      return connection.close();
    }
    if (choice === 0) {
      connection.getClient().shutdownServer();
      return connection.close();
    }
  });
}

function closeOpenFilesForRemoteProject(remoteProjectConfig) {
  var _require5 = require('nuclide-atom-helpers');

  var closeTabForBuffer = _require5.closeTabForBuffer;

  var _require6 = require('./utils');

  var sanitizeNuclideUri = _require6.sanitizeNuclideUri;
  var projectHostname = remoteProjectConfig.host;
  var projectDirectory = remoteProjectConfig.cwd;

  var closedUris = [];
  atom.workspace.getTextEditors().forEach(function (editor) {
    var rawUrl = editor.getURI();
    if (!rawUrl) {
      return;
    }
    var uri = sanitizeNuclideUri(rawUrl);

    var _require$parse = require('nuclide-remote-uri').parse(uri);

    var fileHostname = _require$parse.hostname;
    var filePath = _require$parse.path;

    if (fileHostname === projectHostname && filePath.startsWith(projectDirectory)) {
      closeTabForBuffer(editor.getBuffer());
      if (filePath !== projectDirectory) {
        closedUris.push(uri);
      }
    }
  });
  return closedUris;
}

function cleanupRemoteNuclideProjects() {
  getRemoteRootDirectories().forEach(function (directory) {
    return atom.project.removePath(directory.getPath());
  });
}

function getRemoteRootDirectories() {
  return atom.project.getDirectories().filter(function (directory) {
    return directory.getPath().startsWith('nuclide:');
  });
}

/**
 * Encrypts the clientKey of a RemoteConnectionConfiguration.
 * @param remoteProjectConfig - The config with the clientKey we want encrypted.
 * @return returns the passed in config with the clientKey encrypted.
 */
function protectClientKey(remoteProjectConfig) {
  var _require7 = require('nuclide-keytar-wrapper');

  var replacePassword = _require7.replacePassword;

  var crypto = require('crypto');

  var sha1 = crypto.createHash('sha1');
  sha1.update(remoteProjectConfig.host + ':' + remoteProjectConfig.port);
  var sha1sum = sha1.digest('hex');

  var _encryptString = encryptString(remoteProjectConfig.clientKey);

  var salt = _encryptString.salt;
  var password = _encryptString.password;
  var encryptedString = _encryptString.encryptedString;

  replacePassword('nuclide.remoteProjectConfig', sha1sum, '' + password);

  remoteProjectConfig.clientKey = encryptedString + '.' + salt;

  return remoteProjectConfig;
}

/**
 * Decrypts the clientKey of a RemoteConnectionConfiguration.
 * @param remoteProjectConfig - The config with the clientKey we want encrypted.
 * @return returns the passed in config with the clientKey encrypted.
 */
function restoreClientKey(remoteProjectConfig) {
  var _require8 = require('nuclide-keytar-wrapper');

  var getPassword = _require8.getPassword;

  var crypto = require('crypto');

  var sha1 = crypto.createHash('sha1');
  sha1.update(remoteProjectConfig.host + ':' + remoteProjectConfig.port);
  var sha1sum = sha1.digest('hex');

  var password = getPassword('nuclide.remoteProjectConfig', sha1sum);

  if (!password) {
    throw new Error('Cannot find password for encrypted client key');
  }

  var salt;
  var clientKey;

  var _remoteProjectConfig$clientKey$split = remoteProjectConfig.clientKey.split('.');

  var _remoteProjectConfig$clientKey$split2 = _slicedToArray(_remoteProjectConfig$clientKey$split, 2);

  clientKey = _remoteProjectConfig$clientKey$split2[0];
  salt = _remoteProjectConfig$clientKey$split2[1];

  if (!clientKey || !salt) {
    throw new Error('Cannot decrypt client key');
  }

  remoteProjectConfig.clientKey = decryptString(clientKey, password, salt);

  return remoteProjectConfig;
}

function decryptString(text, password, salt) {
  var crypto = require('crypto');

  var decipher = crypto.createDecipheriv('aes-128-cbc', new Buffer(password, 'base64'), new Buffer(salt, 'base64'));

  var decryptedString = decipher.update(text, 'base64', 'utf8');
  decryptedString += decipher.final('utf8');

  return decryptedString;
}

function encryptString(text) {
  var crypto = require('crypto');
  var password = crypto.randomBytes(16).toString('base64');
  var salt = crypto.randomBytes(16).toString('base64');

  var cipher = crypto.createCipheriv('aes-128-cbc', new Buffer(password, 'base64'), new Buffer(salt, 'base64'));

  var encryptedString = cipher.update(text, 'utf8', 'base64');
  encryptedString += cipher.final('base64');

  return {
    password: password,
    salt: salt,
    encryptedString: encryptedString
  };
}

module.exports = {
  __test__: {
    decryptString: decryptString,
    encryptString: encryptString
  },

  activate: function activate(state) {
    subscriptions = new CompositeDisposable();

    subscriptions.add(getRemoteConnection().onDidAddRemoteConnection(function (connection) {
      addRemoteFolderToProject(connection);
    }));

    // Don't do require or any other expensive operations in activate().
    subscriptions.add(atom.packages.onDidActivateInitialPackages(function () {
      // Subscribe opener before restoring the remote projects.
      subscriptions.add(atom.workspace.addOpener(function () {
        var uri = arguments[0] === undefined ? '' : arguments[0];

        if (uri.startsWith('nuclide:')) {
          var connection = getRemoteConnection().getForUri(uri);
          // On Atom restart, it tries to open the uri path as a file tab because it's not a local directory.
          // We can't let that create a file with the initial working directory path.
          if (connection && uri !== connection.getUriForInitialWorkingDirectory()) {
            if (pendingFiles[uri]) {
              return pendingFiles[uri];
            }
            var textEditorPromise = pendingFiles[uri] = createEditorForNuclide(connection, uri);
            var removeFromCache = function removeFromCache() {
              return delete pendingFiles[uri];
            };
            textEditorPromise.then(removeFromCache, removeFromCache);
            return textEditorPromise;
          }
        }
      }));
      subscriptions.add(atom.commands.add('atom-workspace', 'nuclide-remote-projects:connect', function () {
        return require('nuclide-ssh-dialog').openConnectionDialog();
      }));

      // Remove remote projects added in case of reloads.
      // We already have their connection config stored.
      var remoteProjectsConfig = state && state.remoteProjectsConfig || [];
      remoteProjectsConfig.forEach(restoreNuclideProjectState);
      // Clear obsolete config.
      atom.config.set('nuclide.remoteProjectsConfig', []);
    }));
  },

  serialize: function serialize() {
    var remoteProjectsConfig = getRemoteRootDirectories().map(function (directory) {
      var connection = getRemoteConnection().getForUri(directory.getPath());
      return connection && protectClientKey(connection.getConfig());
    }).filter(function (config) {
      return !!config;
    });
    return {
      remoteProjectsConfig: remoteProjectsConfig
    };
  },

  deactivate: function deactivate() {
    // This should always be true here, but we do this to appease Flow.
    if (subscriptions) {
      subscriptions.dispose();
      subscriptions = null;
    }
  },

  createRemoteDirectoryProvider: function createRemoteDirectoryProvider() {
    var RemoteDirectoryProvider = require('./RemoteDirectoryProvider');
    return new RemoteDirectoryProvider();
  },

  createRemoteDirectorySearcher: function createRemoteDirectorySearcher() {
    var RemoteDirectorySearcher = require('./RemoteDirectorySearcher');
    return new RemoteDirectorySearcher(function (dir) {
      return getServiceByNuclideUri('FindInProjectService', dir.getPath());
    });
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9udWNsaWRlLXJlbW90ZS1wcm9qZWN0cy9saWIvbWFpbi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxXQUFXLENBQUM7O0lBNEJHLHNCQUFzQixxQkFBckMsV0FBc0MsbUJBQWtELEVBQThCO0FBQ3BILE1BQUksZ0JBQWdCLEdBQUcsbUJBQW1CLEVBQUUsQ0FBQzs7QUFFN0MsTUFBSTtBQUNGLFFBQUksVUFBVSxHQUFHLElBQUksZ0JBQWdCLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxDQUFDO0FBQzdFLFVBQU0sVUFBVSxDQUFDLFVBQVUsRUFBRSxDQUFDO0FBQzlCLFdBQU8sVUFBVSxDQUFDO0dBQ25CLENBQUMsT0FBTyxDQUFDLEVBQUU7OztvQkFFbUIsT0FBTyxDQUFDLG9CQUFvQixDQUFDOztRQUFyRCxvQkFBb0IsYUFBcEIsb0JBQW9COztBQUN6QixXQUFPLG9CQUFvQixDQUFDO0FBQzFCLG1CQUFhLEVBQUUsbUJBQW1CLENBQUMsSUFBSTtBQUN2QyxnQkFBVSxFQUFFLG1CQUFtQixDQUFDLEdBQUc7S0FDcEMsQ0FBQyxDQUFDO0dBQ0o7Q0FDRjs7Ozs7O0lBaUVjLDBCQUEwQixxQkFBekMsV0FBMEMsbUJBQWtELEVBQUU7O01BRWpGLGVBQWUsR0FBMkIsbUJBQW1CLENBQW5FLElBQUk7TUFBd0IsZ0JBQWdCLEdBQUksbUJBQW1CLENBQTVDLEdBQUc7OztBQUUvQixNQUFJLFVBQVUsR0FBRyxNQUFNLHNCQUFzQixDQUFDLG1CQUFtQixDQUFDLENBQUM7QUFDbkUsTUFBSSxDQUFDLFVBQVUsRUFBRTtBQUNmLGFBQVMsRUFBRSxDQUFDLElBQUksQ0FBQyxzREFBc0QsRUFBRSxlQUFlLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztHQUM3Rzs7QUFFRCxNQUFJLFVBQVUsR0FBRyw4QkFBOEIsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDOzs7O0FBSXJFLE1BQUksVUFBVSxF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bEMsV0FBTztBQUNMLDBCQUFvQixFQUFwQixvQkFBb0I7S0FDckIsQ0FBQztHQUNIOztBQUVELFlBQVUsRUFBQSxzQkFBUzs7QUFFakIsUUFBSSxhQUFhLEVBQUU7QUFDakIsbUJBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztBQUN4QixtQkFBYSxHQUFHLElBQUksQ0FBQztLQUN0QjtHQUNGOztBQUVELCtCQUE2QixFQUFBLHlDQUE0QjtBQUN2RCxRQUFJLHVCQUF1QixHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ25FLFdBQU8sSUFBSSx1QkFBdUIsRUFBRSxDQUFDO0dBQ3RDOztBQUVELCtCQUE2QixFQUFBLHlDQUE0QjtBQUN2RCxRQUFJLHVCQUF1QixHQUFHLE9BQU8sQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO0FBQ25FLFdBQU8sSUFBSSx1QkFBdUIsQ0FBQyxVQUFDLEdBQUc7YUFDckMsc0JBQXNCLENBQUMsc0JBQXNCLEVBQUUsR0FBRyxDQUFDLE9BQU8sRUFBRSxDQUFDO0tBQUEsQ0FBQyxDQUFDO0dBQ2xFO0NBQ0YsQ0FBQyIsImZpbGUiOiIvVXNlcnMvYW5kcmV3am9uZXMvLmF0b20vcGFja2FnZXMvbnVjbGlkZS1yZW1vdGUtcHJvamVjdHMvbGliL21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyIndXNlIGJhYmVsJztcbi8qIEBmbG93ICovXG5cbi8qXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTUtcHJlc2VudCwgRmFjZWJvb2ssIEluYy5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgbGljZW5zZSBmb3VuZCBpbiB0aGUgTElDRU5TRSBmaWxlIGluXG4gKiB0aGUgcm9vdCBkaXJlY3Rvcnkgb2YgdGhpcyBzb3VyY2UgdHJlZS5cbiAqL1xuXG52YXIge0NvbXBvc2l0ZURpc3Bvc2FibGUsIFRleHRFZGl0b3J9ID0gcmVxdWlyZSgnYXRvbScpO1xudmFyIHtnZXRTZXJ2aWNlQnlOdWNsaWRlVXJpfSA9IHJlcXVpcmUoJ251Y2xpZGUtY2xpZW50Jyk7XG52YXIge1JlbW90ZURpcmVjdG9yeX0gPSByZXF1aXJlKCdudWNsaWRlLXJlbW90ZS1jb25uZWN0aW9uJyk7XG5cbnZhciBzdWJzY3JpcHRpb25zOiA/Q29tcG9zaXRlRGlzcG9zYWJsZSA9IG51bGw7XG52YXIgcGVuZGluZ0ZpbGVzID0ge307XG5cbnZhciBsb2dnZXIgPSBudWxsO1xuZnVuY3Rpb24gZ2V0TG9nZ2VyKCkge1xuICByZXR1cm4gbG9nZ2VyIHx8IChsb2dnZXIgPSByZXF1aXJlKCdudWNsaWRlLWxvZ2dpbmcnKS5nZXRMb2dnZXIoKSk7XG59XG5cbnZhciBSZW1vdGVDb25uZWN0aW9uID0gbnVsbDtcbmZ1bmN0aW9uIGdldFJlbW90ZUNvbm5lY3Rpb24oKTogUmVtb3RlQ29ubmVjdGlvbiB7XG4gIHJldHVybiBSZW1vdGVDb25uZWN0aW9uIHx8IChSZW1vdGVDb25uZWN0aW9uID0gcmVxdWlyZSgnbnVjbGlkZS1yZW1vdGUtY29ubmVjdGlvbicpLlJlbW90ZUNvbm5lY3Rpb24pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVSZW1vdGVDb25uZWN0aW9uKHJlbW90ZVByb2plY3RDb25maWc6IFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uKTogUHJvbWlzZTw/UmVtb3RlQ29ubmVjdGlvbj4ge1xuICB2YXIgUmVtb3RlQ29ubmVjdGlvbiA9IGdldFJlbW90ZUNvbm5lY3Rpb24oKTtcblxuICB0cnkge1xuICAgIHZhciBjb25uZWN0aW9uID0gbmV3IFJlbW90ZUNvbm5lY3Rpb24ocmVzdG9yZUNsaWVudEtleShyZW1vdGVQcm9qZWN0Q29uZmlnKSk7XG4gICAgYXdhaXQgY29ubmVjdGlvbi5pbml0aWFsaXplKCk7XG4gICAgcmV0dXJuIGNvbm5lY3Rpb247XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBJZiBjb25uZWN0aW9uIGZhaWxzIHVzaW5nIHNhdmVkIGNvbmZpZywgb3BlbiBjb25uZWN0IGRpYWxvZy5cbiAgICB2YXIge29wZW5Db25uZWN0aW9uRGlhbG9nfSA9IHJlcXVpcmUoJ251Y2xpZGUtc3NoLWRpYWxvZycpO1xuICAgIHJldHVybiBvcGVuQ29ubmVjdGlvbkRpYWxvZyh7XG4gICAgICBpbml0aWFsU2VydmVyOiByZW1vdGVQcm9qZWN0Q29uZmlnLmhvc3QsXG4gICAgICBpbml0aWFsQ3dkOiByZW1vdGVQcm9qZWN0Q29uZmlnLmN3ZCxcbiAgICB9KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhZGRSZW1vdGVGb2xkZXJUb1Byb2plY3QoY29ubmVjdGlvbjogUmVtb3RlQ29ubmVjdGlvbikge1xuICB2YXIgd29ya2luZ0RpcmVjdG9yeVVyaSA9IGNvbm5lY3Rpb24uZ2V0VXJpRm9ySW5pdGlhbFdvcmtpbmdEaXJlY3RvcnkoKTtcbiAgLy8gSWYgcmVzdG9yaW5nIHN0YXRlLCB0aGVuIHRoZSBwcm9qZWN0IGFscmVhZHkgZXhpc3RzIHdpdGggbG9jYWwgZGlyZWN0b3J5IGFuZCB3cm9uZyByZXBvIGluc3RhbmNlcy5cbiAgLy8gSGVuY2UsIHdlIHJlbW92ZSBpdCBoZXJlLCBpZiBleGlzdGluZywgYW5kIGFkZCB0aGUgbmV3IHBhdGggZm9yIHdoaWNoIHdlIGFkZGVkIGEgd29ya3NwYWNlIG9wZW5lciBoYW5kbGVyLlxuICBhdG9tLnByb2plY3QucmVtb3ZlUGF0aCh3b3JraW5nRGlyZWN0b3J5VXJpKTtcblxuICBhdG9tLnByb2plY3QuYWRkUGF0aCh3b3JraW5nRGlyZWN0b3J5VXJpKTtcblxuICB2YXIgc3Vic2NyaXB0aW9uID0gYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHMocGF0aHMgPT4ge1xuICAgIGlmIChwYXRocy5pbmRleE9mKHdvcmtpbmdEaXJlY3RvcnlVcmkpICE9PSAtMSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICAvLyBUaGUgcHJvamVjdCB3YXMgcmVtb3ZlZCBmcm9tIHRoZSB0cmVlLlxuICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlKCk7XG5cbiAgICBjbG9zZU9wZW5GaWxlc0ZvclJlbW90ZVByb2plY3QoY29ubmVjdGlvbi5nZXRDb25maWcoKSk7XG5cbiAgICB2YXIgaG9zdG5hbWUgPSBjb25uZWN0aW9uLmdldFJlbW90ZUhvc3RuYW1lKCk7XG4gICAgaWYgKGdldFJlbW90ZUNvbm5lY3Rpb24oKS5nZXRCeUhvc3RuYW1lKGhvc3RuYW1lKS5sZW5ndGggPiAxKSB7XG4gICAgICBnZXRMb2dnZXIoKS5pbmZvKCdSZW1haW5pbmcgcmVtb3RlIHByb2plY3RzIHVzaW5nIE51Y2xpZGUgU2VydmVyIC0gbm8gcHJvbXB0IHRvIHNodXRkb3duJyk7XG4gICAgICByZXR1cm4gY29ubmVjdGlvbi5jbG9zZSgpO1xuICAgIH1cblxuICAgIHZhciBjaG9pY2UgPSBhdG9tLmNvbmZpcm0oe1xuICAgICAgbWVzc2FnZTogJ05vIG1vcmUgcmVtb3RlIHByb2plY3RzIG9uIHRoZSBob3N0OiBcXCcnICsgaG9zdG5hbWUgKyAnXFwnLiBXb3VsZCB5b3UgbGlrZSB0byBzaHV0ZG93biBOdWNsaWRlIHNlcnZlciB0aGVyZT8nLFxuICAgICAgYnV0dG9uczogWydTaHV0ZG93bicsICdLZWVwIEl0J10sXG4gICAgfSk7XG4gICAgaWYgKGNob2ljZSA9PT0gMSkge1xuICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uY2xvc2UoKTtcbiAgICB9XG4gICAgaWYgKGNob2ljZSA9PT0gMCkge1xuICAgICAgY29ubmVjdGlvbi5nZXRDbGllbnQoKS5zaHV0ZG93blNlcnZlcigpO1xuICAgICAgcmV0dXJuIGNvbm5lY3Rpb24uY2xvc2UoKTtcbiAgICB9XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjbG9zZU9wZW5GaWxlc0ZvclJlbW90ZVByb2plY3QocmVtb3RlUHJvamVjdENvbmZpZzogUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24pOiBBcnJheTxzdHJpbmc+IHtcbiAgdmFyIHtjbG9zZVRhYkZvckJ1ZmZlcn0gPSByZXF1aXJlKCdudWNsaWRlLWF0b20taGVscGVycycpO1xuICB2YXIge3Nhbml0aXplTnVjbGlkZVVyaX0gPSByZXF1aXJlKCcuL3V0aWxzJyk7XG5cbiAgdmFyIHtob3N0OiBwcm9qZWN0SG9zdG5hbWUsIGN3ZDogcHJvamVjdERpcmVjdG9yeX0gPSByZW1vdGVQcm9qZWN0Q29uZmlnO1xuICB2YXIgY2xvc2VkVXJpcyA9IFtdO1xuICBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpLmZvckVhY2goZWRpdG9yID0+IHtcbiAgICB2YXIgcmF3VXJsID0gZWRpdG9yLmdldFVSSSgpO1xuICAgIGlmICghcmF3VXJsKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciB1cmkgPSBzYW5pdGl6ZU51Y2xpZGVVcmkocmF3VXJsKTtcbiAgICB2YXIge2hvc3RuYW1lOiBmaWxlSG9zdG5hbWUsIHBhdGg6IGZpbGVQYXRofSA9IHJlcXVpcmUoJ251Y2xpZGUtcmVtb3RlLXVyaScpLnBhcnNlKHVyaSk7XG4gICAgaWYgKGZpbGVIb3N0bmFtZSA9PT0gcHJvamVjdEhvc3RuYW1lICYmIGZpbGVQYXRoLnN0YXJ0c1dpdGgocHJvamVjdERpcmVjdG9yeSkpIHtcbiAgICAgIGNsb3NlVGFiRm9yQnVmZmVyKGVkaXRvci5nZXRCdWZmZXIoKSk7XG4gICAgICBpZiAoZmlsZVBhdGggIT09IHByb2plY3REaXJlY3RvcnkpIHtcbiAgICAgICAgY2xvc2VkVXJpcy5wdXNoKHVyaSk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIGNsb3NlZFVyaXM7XG59XG5cbi8qKlxuICogUmVzdG9yZSBhIG51Y2xpZGUgcHJvamVjdCBzdGF0ZSBmcm9tIGEgc2VyaWFsaXplZCBzdGF0ZSBvZiB0aGUgcmVtb3RlIGNvbm5lY3Rpb24gY29uZmlnLlxuICovXG5hc3luYyBmdW5jdGlvbiByZXN0b3JlTnVjbGlkZVByb2plY3RTdGF0ZShyZW1vdGVQcm9qZWN0Q29uZmlnOiBSZW1vdGVDb25uZWN0aW9uQ29uZmlndXJhdGlvbikge1xuICAvLyBUT0RPIHVzZSB0aGUgcmVzdCBvZiB0aGUgY29uZmlnIGZvciB0aGUgY29ubmVjdGlvbiBkaWFsb2cuXG4gIHZhciB7aG9zdDogcHJvamVjdEhvc3RuYW1lLCBjd2Q6IHByb2plY3REaXJlY3Rvcnl9ID0gcmVtb3RlUHJvamVjdENvbmZpZztcbiAgLy8gdHJ5IHRvIHJlLWNvbm5lY3QsIHRoZW4sIGFkZCB0aGUgcHJvamVjdCB0byBhdG9tLnByb2plY3QgYW5kIHRoZSB0cmVlLlxuICB2YXIgY29ubmVjdGlvbiA9IGF3YWl0IGNyZWF0ZVJlbW90ZUNvbm5lY3Rpb24ocmVtb3RlUHJvamVjdENvbmZpZyk7XG4gIGlmICghY29ubmVjdGlvbikge1xuICAgIGdldExvZ2dlcigpLmluZm8oJ05vIFJlbW90ZUNvbm5lY3Rpb24gcmV0dXJuZWQgb24gcmVzdG9yZSBzdGF0ZSB0cmlhbDonLCBwcm9qZWN0SG9zdG5hbWUsIHByb2plY3REaXJlY3RvcnkpO1xuICB9XG4gIC8vIFJlbG9hZCB0aGUgcHJvamVjdCBmaWxlcyB0aGF0IGhhdmUgZW1wdHkgdGV4dCBlZGl0b3JzL2J1ZmZlcnMgb3Blbi5cbiAgdmFyIGNsb3NlZFVyaXMgPSBjbG9zZU9wZW5GaWxlc0ZvclJlbW90ZVByb2plY3QocmVtb3RlUHJvamVjdENvbmZpZyk7XG4gIC8vIE9uIEF0b20gcmVzdGFydCwgaXQgdHJpZXMgdG8gb3BlbiB0aGUgdXJpIHBhdGggYXMgYSBmaWxlIHRhYiBiZWNhdXNlIGl0J3Mgbm90IGEgbG9jYWwgZGlyZWN0b3J5LlxuICAvLyBIZW5jZSwgd2UgY2xvc2UgaXQgaW4gdGhlIGNsZWFudXAsIGJlY2F1c2Ugd2UgaGF2ZSB0aGUgbmVlZGVkIGNvbm5lY3Rpb24gY29uZmlnIHNhdmVkXG4gIC8vIHdpdGggdGhlIGxhc3Qgb3BlbmVkIGZpbGVzIGluIHRoZSBwYWNrYWdlIHN0YXRlLlxuICBpZiAoY29ubmVjdGlvbikge1xuICAgIGNsb3NlZFVyaXMuZm9yRWFjaCh1cmkgPT4gYXRvbS53b3Jrc3BhY2Uub3Blbih1cmkpKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjbGVhbnVwUmVtb3RlTnVjbGlkZVByb2plY3RzKCkge1xuICBnZXRSZW1vdGVSb290RGlyZWN0b3JpZXMoKS5mb3JFYWNoKGRpcmVjdG9yeSA9PiBhdG9tLnByb2plY3QucmVtb3ZlUGF0aChkaXJlY3RvcnkuZ2V0UGF0aCgpKSk7XG59XG5cbmZ1bmN0aW9uIGdldFJlbW90ZVJvb3REaXJlY3RvcmllcygpIHtcbiAgcmV0dXJuIGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpLmZpbHRlcihkaXJlY3RvcnkgPT4gZGlyZWN0b3J5LmdldFBhdGgoKS5zdGFydHNXaXRoKCdudWNsaWRlOicpKTtcbn1cblxuLyoqXG4gKiBUaGUgc2FtZSBUZXh0RWRpdG9yIG11c3QgYmUgcmV0dXJuZWQgdG8gcHJldmVudCBBdG9tIGZyb20gY3JlYXRpbmcgbXVsdGlwbGUgdGFic1xuICogZm9yIHRoZSBzYW1lIGZpbGUsIGJlY2F1c2UgQXRvbSBkb2Vzbid0IGNhY2hlIHBlbmRpbmcgb3BlbmVyIHByb21pc2VzLlxuICovXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVFZGl0b3JGb3JOdWNsaWRlKGNvbm5lY3Rpb246IFJlbW90ZUNvbm5lY3Rpb24sIHVyaTogc3RyaW5nKTogVGV4dEVkaXRvciB7XG4gIHZhciBOdWNsaWRlVGV4dEJ1ZmZlciA9IHJlcXVpcmUoJy4vTnVjbGlkZVRleHRCdWZmZXInKTtcblxuICB2YXIgYnVmZmVyID0gbmV3IE51Y2xpZGVUZXh0QnVmZmVyKGNvbm5lY3Rpb24sIHtmaWxlUGF0aDogdXJpfSk7XG4gIGJ1ZmZlci5zZXRFbmNvZGluZyhhdG9tLmNvbmZpZy5nZXQoJ2NvcmUuZmlsZUVuY29kaW5nJykpO1xuICB0cnkge1xuICAgIGF3YWl0IGJ1ZmZlci5sb2FkKCk7XG4gIH0gY2F0Y2goZXJyKSB7XG4gICAgZ2V0TG9nZ2VyKCkud2FybignYnVmZmVyIGxvYWQgaXNzdWU6JywgZXJyKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbiAgcmV0dXJuIG5ldyBUZXh0RWRpdG9yKC8qZWRpdG9yT3B0aW9ucyovIHtidWZmZXIsIHJlZ2lzdGVyRWRpdG9yOiB0cnVlfSk7XG59XG5cbi8qKlxuICogRW5jcnlwdHMgdGhlIGNsaWVudEtleSBvZiBhIFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uLlxuICogQHBhcmFtIHJlbW90ZVByb2plY3RDb25maWcgLSBUaGUgY29uZmlnIHdpdGggdGhlIGNsaWVudEtleSB3ZSB3YW50IGVuY3J5cHRlZC5cbiAqIEByZXR1cm4gcmV0dXJucyB0aGUgcGFzc2VkIGluIGNvbmZpZyB3aXRoIHRoZSBjbGllbnRLZXkgZW5jcnlwdGVkLlxuICovXG5mdW5jdGlvbiBwcm90ZWN0Q2xpZW50S2V5KHJlbW90ZVByb2plY3RDb25maWc6IFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uKTogUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24ge1xuICB2YXIge3JlcGxhY2VQYXNzd29yZH0gPSByZXF1aXJlKCdudWNsaWRlLWtleXRhci13cmFwcGVyJyk7XG4gIHZhciBjcnlwdG8gPSByZXF1aXJlKCdjcnlwdG8nKTtcblxuICB2YXIgc2hhMSA9IGNyeXB0by5jcmVhdGVIYXNoKCdzaGExJyk7XG4gIHNoYTEudXBkYXRlKGAke3JlbW90ZVByb2plY3RDb25maWcuaG9zdH06JHtyZW1vdGVQcm9qZWN0Q29uZmlnLnBvcnR9YCk7XG4gIHZhciBzaGExc3VtID0gc2hhMS5kaWdlc3QoJ2hleCcpO1xuXG4gIHZhciB7c2FsdCwgcGFzc3dvcmQsIGVuY3J5cHRlZFN0cmluZ30gPSBlbmNyeXB0U3RyaW5nKHJlbW90ZVByb2plY3RDb25maWcuY2xpZW50S2V5KTtcbiAgcmVwbGFjZVBhc3N3b3JkKCdudWNsaWRlLnJlbW90ZVByb2plY3RDb25maWcnLCBzaGExc3VtLCBgJHtwYXNzd29yZH1gKTtcblxuICByZW1vdGVQcm9qZWN0Q29uZmlnLmNsaWVudEtleSA9IGVuY3J5cHRlZFN0cmluZyArICcuJyArIHNhbHQ7XG5cbiAgcmV0dXJuIHJlbW90ZVByb2plY3RDb25maWc7XG59XG5cbi8qKlxuICogRGVjcnlwdHMgdGhlIGNsaWVudEtleSBvZiBhIFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uLlxuICogQHBhcmFtIHJlbW90ZVByb2plY3RDb25maWcgLSBUaGUgY29uZmlnIHdpdGggdGhlIGNsaWVudEtleSB3ZSB3YW50IGVuY3J5cHRlZC5cbiAqIEByZXR1cm4gcmV0dXJucyB0aGUgcGFzc2VkIGluIGNvbmZpZyB3aXRoIHRoZSBjbGllbnRLZXkgZW5jcnlwdGVkLlxuICovXG5mdW5jdGlvbiByZXN0b3JlQ2xpZW50S2V5KHJlbW90ZVByb2plY3RDb25maWc6IFJlbW90ZUNvbm5lY3Rpb25Db25maWd1cmF0aW9uKTogUmVtb3RlQ29ubmVjdGlvbkNvbmZpZ3VyYXRpb24ge1xuICB2YXIge2dldFBhc3N3b3JkfSA9IHJlcXVpcmUoJ251Y2xpZGUta2V5dGFyLXdyYXBwZXInKTtcbiAgdmFyIGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuXG4gIHZhciBzaGExID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTEnKTtcbiAgc2hhMS51cGRhdGUoYCR7cmVtb3RlUHJvamVjdENvbmZpZy5ob3N0fToke3JlbW90ZVByb2plY3RDb25maWcucG9ydH1gKTtcbiAgdmFyIHNoYTFzdW0gPSBzaGExLmRpZ2VzdCgnaGV4Jyk7XG5cbiAgdmFyIHBhc3N3b3JkID0gZ2V0UGFzc3dvcmQoJ251Y2xpZGUucmVtb3RlUHJvamVjdENvbmZpZycsIHNoYTFzdW0pO1xuXG4gIGlmICghcGFzc3dvcmQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBmaW5kIHBhc3N3b3JkIGZvciBlbmNyeXB0ZWQgY2xpZW50IGtleScpO1xuICB9XG5cbiAgdmFyIHNhbHQ7XG4gIHZhciBjbGllbnRLZXk7XG5cbiAgW2NsaWVudEtleSwgc2FsdF0gPSByZW1vdGVQcm9qZWN0Q29uZmlnLmNsaWVudEtleS5zcGxpdCgnLicpO1xuXG4gIGlmICghY2xpZW50S2V5IHx8ICFzYWx0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgZGVjcnlwdCBjbGllbnQga2V5Jyk7XG4gIH1cblxuICByZW1vdGVQcm9qZWN0Q29uZmlnLmNsaWVudEtleSA9IGRlY3J5cHRTdHJpbmcoY2xpZW50S2V5LCBwYXNzd29yZCwgc2FsdCk7XG5cbiAgcmV0dXJuIHJlbW90ZVByb2plY3RDb25maWc7XG59XG5cbmZ1bmN0aW9uIGRlY3J5cHRTdHJpbmcodGV4dDogc3RyaW5nLCBwYXNzd29yZDogc3RyaW5nLCBzYWx0OiBzdHJpbmcpOiBzdHJpbmcge1xuICB2YXIgY3J5cHRvID0gcmVxdWlyZSgnY3J5cHRvJyk7XG5cbiAgdmFyIGRlY2lwaGVyID0gY3J5cHRvLmNyZWF0ZURlY2lwaGVyaXYoXG4gICAgICAnYWVzLTEyOC1jYmMnLFxuICAgICAgbmV3IEJ1ZmZlcihwYXNzd29yZCwgJ2Jhc2U2NCcpLFxuICAgICAgbmV3IEJ1ZmZlcihzYWx0LCAnYmFzZTY0JykpO1xuXG4gIHZhciBkZWNyeXB0ZWRTdHJpbmcgPSBkZWNpcGhlci51cGRhdGUodGV4dCwgJ2Jhc2U2NCcsICd1dGY4Jyk7XG4gIGRlY3J5cHRlZFN0cmluZyArPSBkZWNpcGhlci5maW5hbCgndXRmOCcpO1xuXG4gIHJldHVybiBkZWNyeXB0ZWRTdHJpbmc7XG59XG5cbmZ1bmN0aW9uIGVuY3J5cHRTdHJpbmcodGV4dDogc3RyaW5nKTogYW55IHtcbiAgdmFyIGNyeXB0byA9IHJlcXVpcmUoJ2NyeXB0bycpO1xuICB2YXIgcGFzc3dvcmQgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoMTYpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbiAgdmFyIHNhbHQgPSBjcnlwdG8ucmFuZG9tQnl0ZXMoMTYpLnRvU3RyaW5nKCdiYXNlNjQnKTtcblxuICB2YXIgY2lwaGVyID0gY3J5cHRvLmNyZWF0ZUNpcGhlcml2KFxuICAgICdhZXMtMTI4LWNiYycsXG4gICAgbmV3IEJ1ZmZlcihwYXNzd29yZCwgJ2Jhc2U2NCcpLFxuICAgIG5ldyBCdWZmZXIoc2FsdCwgJ2Jhc2U2NCcpKTtcblxuICB2YXIgZW5jcnlwdGVkU3RyaW5nID0gY2lwaGVyLnVwZGF0ZSh0ZXh0LCAndXRmOCcsICdiYXNlNjQnKTtcbiAgZW5jcnlwdGVkU3RyaW5nICs9IGNpcGhlci5maW5hbCgnYmFzZTY0Jyk7XG5cbiAgcmV0dXJuIHtcbiAgICBwYXNzd29yZCxcbiAgICBzYWx0LFxuICAgIGVuY3J5cHRlZFN0cmluZyxcbiAgfTtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG4gIF9fdGVzdF9fOiB7XG4gICAgZGVjcnlwdFN0cmluZyxcbiAgICBlbmNyeXB0U3RyaW5nLFxuICB9LFxuXG4gIGFjdGl2YXRlKHN0YXRlOiA/YW55KTogdm9pZCB7XG4gICAgc3Vic2NyaXB0aW9ucyA9IG5ldyBDb21wb3NpdGVEaXNwb3NhYmxlKCk7XG5cbiAgICBzdWJzY3JpcHRpb25zLmFkZChnZXRSZW1vdGVDb25uZWN0aW9uKCkub25EaWRBZGRSZW1vdGVDb25uZWN0aW9uKGNvbm5lY3Rpb24gPT4ge1xuICAgICAgYWRkUmVtb3RlRm9sZGVyVG9Qcm9qZWN0KGNvbm5lY3Rpb24pO1xuICAgIH0pKTtcblxuICAgIC8vIERvbid0IGRvIHJlcXVpcmUgb3IgYW55IG90aGVyIGV4cGVuc2l2ZSBvcGVyYXRpb25zIGluIGFjdGl2YXRlKCkuXG4gICAgc3Vic2NyaXB0aW9ucy5hZGQoYXRvbS5wYWNrYWdlcy5vbkRpZEFjdGl2YXRlSW5pdGlhbFBhY2thZ2VzKCgpID0+IHtcbiAgICAgIC8vIFN1YnNjcmliZSBvcGVuZXIgYmVmb3JlIHJlc3RvcmluZyB0aGUgcmVtb3RlIHByb2plY3RzLlxuICAgICAgc3Vic2NyaXB0aW9ucy5hZGQoYXRvbS53b3Jrc3BhY2UuYWRkT3BlbmVyKCh1cmkgPSAnJykgPT4ge1xuICAgICAgICBpZiAodXJpLnN0YXJ0c1dpdGgoJ251Y2xpZGU6JykpIHtcbiAgICAgICAgICB2YXIgY29ubmVjdGlvbiA9IGdldFJlbW90ZUNvbm5lY3Rpb24oKS5nZXRGb3JVcmkodXJpKTtcbiAgICAgICAgICAvLyBPbiBBdG9tIHJlc3RhcnQsIGl0IHRyaWVzIHRvIG9wZW4gdGhlIHVyaSBwYXRoIGFzIGEgZmlsZSB0YWIgYmVjYXVzZSBpdCdzIG5vdCBhIGxvY2FsIGRpcmVjdG9yeS5cbiAgICAgICAgICAvLyBXZSBjYW4ndCBsZXQgdGhhdCBjcmVhdGUgYSBmaWxlIHdpdGggdGhlIGluaXRpYWwgd29ya2luZyBkaXJlY3RvcnkgcGF0aC5cbiAgICAgICAgICBpZiAoY29ubmVjdGlvbiAmJiB1cmkgIT09IGNvbm5lY3Rpb24uZ2V0VXJpRm9ySW5pdGlhbFdvcmtpbmdEaXJlY3RvcnkoKSkge1xuICAgICAgICAgICAgaWYgKHBlbmRpbmdGaWxlc1t1cmldKSB7XG4gICAgICAgICAgICAgIHJldHVybiBwZW5kaW5nRmlsZXNbdXJpXTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHZhciB0ZXh0RWRpdG9yUHJvbWlzZSA9IHBlbmRpbmdGaWxlc1t1cmldID0gY3JlYXRlRWRpdG9yRm9yTnVjbGlkZShjb25uZWN0aW9uLCB1cmkpO1xuICAgICAgICAgICAgdmFyIHJlbW92ZUZyb21DYWNoZSA9ICgpID0+IGRlbGV0ZSBwZW5kaW5nRmlsZXNbdXJpXTtcbiAgICAgICAgICAgIHRleHRFZGl0b3JQcm9taXNlLnRoZW4ocmVtb3ZlRnJvbUNhY2hlLCByZW1vdmVGcm9tQ2FjaGUpO1xuICAgICAgICAgICAgcmV0dXJuIHRleHRFZGl0b3JQcm9taXNlO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSkpO1xuICAgIHN1YnNjcmlwdGlvbnMuYWRkKGF0b20uY29tbWFuZHMuYWRkKFxuICAgICAgICAnYXRvbS13b3Jrc3BhY2UnLFxuICAgICAgICAnbnVjbGlkZS1yZW1vdGUtcHJvamVjdHM6Y29ubmVjdCcsXG4gICAgICAgICgpID0+IHJlcXVpcmUoJ251Y2xpZGUtc3NoLWRpYWxvZycpLm9wZW5Db25uZWN0aW9uRGlhbG9nKClcbiAgICApKTtcblxuICAgICAgLy8gUmVtb3ZlIHJlbW90ZSBwcm9qZWN0cyBhZGRlZCBpbiBjYXNlIG9mIHJlbG9hZHMuXG4gICAgICAvLyBXZSBhbHJlYWR5IGhhdmUgdGhlaXIgY29ubmVjdGlvbiBjb25maWcgc3RvcmVkLlxuICAgICAgdmFyIHJlbW90ZVByb2plY3RzQ29uZmlnID0gKHN0YXRlICYmIHN0YXRlLnJlbW90ZVByb2plY3RzQ29uZmlnKSB8fCBbXTtcbiAgICAgIHJlbW90ZVByb2plY3RzQ29uZmlnLmZvckVhY2gocmVzdG9yZU51Y2xpZGVQcm9qZWN0U3RhdGUpO1xuICAgICAgLy8gQ2xlYXIgb2Jzb2xldGUgY29uZmlnLlxuICAgICAgYXRvbS5jb25maWcuc2V0KCdudWNsaWRlLnJlbW90ZVByb2plY3RzQ29uZmlnJywgW10pO1xuICAgIH0pKTtcbiAgfSxcblxuICBzZXJpYWxpemUoKTogYW55IHtcbiAgICB2YXIgcmVtb3RlUHJvamVjdHNDb25maWcgPSBnZXRSZW1vdGVSb290RGlyZWN0b3JpZXMoKVxuICAgICAgICAubWFwKGRpcmVjdG9yeSA9PiB7XG4gICAgICAgICAgdmFyIGNvbm5lY3Rpb24gPSBnZXRSZW1vdGVDb25uZWN0aW9uKCkuZ2V0Rm9yVXJpKGRpcmVjdG9yeS5nZXRQYXRoKCkpO1xuICAgICAgICAgIHJldHVybiBjb25uZWN0aW9uICYmIHByb3RlY3RDbGllbnRLZXkoY29ubmVjdGlvbi5nZXRDb25maWcoKSk7XG4gICAgICAgIH0pLmZpbHRlcihjb25maWcgPT4gISFjb25maWcpO1xuICAgIHJldHVybiB7XG4gICAgICByZW1vdGVQcm9qZWN0c0NvbmZpZyxcbiAgICB9O1xuICB9LFxuXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgLy8gVGhpcyBzaG91bGQgYWx3YXlzIGJlIHRydWUgaGVyZSwgYnV0IHdlIGRvIHRoaXMgdG8gYXBwZWFzZSBGbG93LlxuICAgIGlmIChzdWJzY3JpcHRpb25zKSB7XG4gICAgICBzdWJzY3JpcHRpb25zLmRpc3Bvc2UoKTtcbiAgICAgIHN1YnNjcmlwdGlvbnMgPSBudWxsO1xuICAgIH1cbiAgfSxcblxuICBjcmVhdGVSZW1vdGVEaXJlY3RvcnlQcm92aWRlcigpOiBSZW1vdGVEaXJlY3RvcnlQcm92aWRlciB7XG4gICAgdmFyIFJlbW90ZURpcmVjdG9yeVByb3ZpZGVyID0gcmVxdWlyZSgnLi9SZW1vdGVEaXJlY3RvcnlQcm92aWRlcicpO1xuICAgIHJldHVybiBuZXcgUmVtb3RlRGlyZWN0b3J5UHJvdmlkZXIoKTtcbiAgfSxcblxuICBjcmVhdGVSZW1vdGVEaXJlY3RvcnlTZWFyY2hlcigpOiBSZW1vdGVEaXJlY3RvcnlTZWFyY2hlciB7XG4gICAgdmFyIFJlbW90ZURpcmVjdG9yeVNlYXJjaGVyID0gcmVxdWlyZSgnLi9SZW1vdGVEaXJlY3RvcnlTZWFyY2hlcicpO1xuICAgIHJldHVybiBuZXcgUmVtb3RlRGlyZWN0b3J5U2VhcmNoZXIoKGRpcjogUmVtb3RlRGlyZWN0b3J5KSA9PlxuICAgICAgZ2V0U2VydmljZUJ5TnVjbGlkZVVyaSgnRmluZEluUHJvamVjdFNlcnZpY2UnLCBkaXIuZ2V0UGF0aCgpKSk7XG4gIH0sXG59O1xuIl19