var path = require('path');
var fs = require('fs');
var textBuffer = require('basarat-text-buffer');
function createScriptInfo(fileName, text, isOpen) {
    if (isOpen === void 0) {
        isOpen = false;
    }
    var version = 1;
    var editRanges = [];
    var _lineStarts;
    var _lineStartIsDirty = true;
    var buffer = new textBuffer(text);
    function getLineStarts() {
        if (_lineStartIsDirty) {
            _lineStarts = [];
            var totalLength = 0;
            buffer.lines.forEach(function (line, index) {
                _lineStarts.push(totalLength);
                var lineLength = line.length;
                totalLength = totalLength + lineLength + buffer.lineEndings[index].length;
            });
            _lineStartIsDirty = false;
        }
        return _lineStarts;
    }
    function updateContent(newContent) {
        buffer = new textBuffer(newContent);
        _lineStartIsDirty = true;
        editRanges = [];
        version++;
    }
    function editContent(minChar, limChar, newText) {
        var start = getLineAndColForPositon(minChar);
        var end = getLineAndColForPositon(limChar);
        buffer.setTextInRange([[start.line, start.col], [end.line, end.col]], newText, { normalizeLineEndings: false });
        _lineStartIsDirty = true;
        editRanges.push({
            span: { start: minChar, length: limChar - minChar },
            newLength: newText.length
        });
        version++;
    }
    function getPositionFromLine(line, ch) {
        return buffer.characterIndexForPosition([line, ch]);
    }
    function getLineAndColForPositon(position) {
        var _a = buffer.positionForCharacterIndex(position),
            row = _a.row,
            column = _a.column;
        return {
            line: row,
            col: column
        };
    }
    function getLinePreview(line) {
        return (buffer.lines[line] || '').trim();
    }
    return {
        getFileName: function getFileName() {
            return fileName;
        },
        getContent: function getContent() {
            return buffer.getText();
        },
        getVersion: function getVersion() {
            return version;
        },
        getIsOpen: function getIsOpen() {
            return isOpen;
        },
        setIsOpen: function setIsOpen(val) {
            return isOpen = val;
        },
        getEditRanges: function getEditRanges() {
            return editRanges;
        },
        getLineStarts: getLineStarts,
        updateContent: updateContent,
        editContent: editContent,
        getPositionFromLine: getPositionFromLine,
        getLineAndColForPositon: getLineAndColForPositon,
        getLinePreview: getLinePreview
    };
}
function getScriptSnapShot(scriptInfo) {
    var lineStarts = scriptInfo.getLineStarts();
    var textSnapshot = scriptInfo.getContent();
    var version = scriptInfo.getVersion();
    var editRanges = scriptInfo.getEditRanges();
    function getChangeRange(oldSnapshot) {
        var unchanged = { span: { start: 0, length: 0 }, newLength: 0 };
        function collapseChangesAcrossMultipleVersions(changes) {
            if (changes.length === 0) {
                return unchanged;
            }
            if (changes.length === 1) {
                return changes[0];
            }
            var change0 = changes[0];
            var oldStartN = change0.span.start;
            var oldEndN = change0.span.start + change0.span.length;
            var newEndN = oldStartN + change0.newLength;
            for (var i = 1; i < changes.length; i++) {
                var nextChange = changes[i];
                var oldStart1 = oldStartN;
                var oldEnd1 = oldEndN;
                var newEnd1 = newEndN;
                var oldStart2 = nextChange.span.start;
                var oldEnd2 = nextChange.span.start + nextChange.span.length;
                var newEnd2 = oldStart2 + nextChange.newLength;
                oldStartN = Math.min(oldStart1, oldStart2);
                oldEndN = Math.max(oldEnd1, oldEnd1 + (oldEnd2 - newEnd1));
                newEndN = Math.max(newEnd2, newEnd2 + (newEnd1 - oldEnd2));
            }
            return { span: { start: oldStartN, length: oldEndN - oldStartN }, newLength: newEndN - oldStartN };
        }
        ;
        var scriptVersion = oldSnapshot.version || 0;
        if (scriptVersion === version) {
            return unchanged;
        }
        var initialEditRangeIndex = editRanges.length - (version - scriptVersion);
        if (initialEditRangeIndex < 0) {
            return null;
        }
        var entries = editRanges.slice(initialEditRangeIndex);
        return collapseChangesAcrossMultipleVersions(entries);
    }
    return {
        getText: function getText(start, end) {
            return textSnapshot.substring(start, end);
        },
        getLength: function getLength() {
            return textSnapshot.length;
        },
        getChangeRange: getChangeRange,
        getLineStartPositions: function getLineStartPositions() {
            return lineStarts;
        },
        version: version
    };
}
exports.getDefaultLibFilePath = function (options) {
    var filename = ts.getDefaultLibFileName(options);
    return path.join(path.dirname(require.resolve('ntypescript')), filename).split('\\').join('/');
};
exports.typescriptDirectory = path.dirname(require.resolve('ntypescript')).split('\\').join('/');
var LanguageServiceHost = (function () {
    function LanguageServiceHost(config) {
        var _this = this;
        this.config = config;
        this.fileNameToScript = Object.create(null);
        this.addScript = function (fileName, content) {
            try {
                if (!content) {
                    content = fs.readFileSync(fileName).toString();
                }
            } catch (ex) {
                content = '';
            }
            var script = createScriptInfo(fileName, content);
            _this.fileNameToScript[fileName] = script;
        };
        this.removeScript = function (fileName) {
            delete _this.fileNameToScript[fileName];
        };
        this.removeAll = function () {
            _this.fileNameToScript = Object.create(null);
        };
        this.updateScript = function (fileName, content) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                script.updateContent(content);
                return;
            } else {
                _this.addScript(fileName, content);
            }
        };
        this.editScript = function (fileName, start, end, newText) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                var minChar = script.getPositionFromLine(start.line, start.col);
                var limChar = script.getPositionFromLine(end.line, end.col);
                script.editContent(minChar, limChar, newText);
                return;
            }
            throw new Error('No script with name \'' + fileName + '\'');
        };
        this.setScriptIsOpen = function (fileName, isOpen) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                script.setIsOpen(isOpen);
                return;
            }
            throw new Error('No script with name \'' + fileName + '\'');
        };
        this.getScriptContent = function (fileName) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                return script.getContent();
            }
            return null;
        };
        this.hasScript = function (fileName) {
            return !!_this.fileNameToScript[fileName];
        };
        this.getIndexFromPosition = function (fileName, position) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                return script.getPositionFromLine(position.line, position.col);
            }
            return -1;
        };
        this.getPositionFromIndex = function (fileName, index) {
            if (!_this.fileNameToScript[fileName]) _this.addScript(fileName);
            var script = _this.fileNameToScript[fileName];
            if (script) {
                return script.getLineAndColForPositon(index);
            }
            return null;
        };
        this.getPositionFromTextSpanWithLinePreview = function (fileName, textSpan) {
            var position = _this.getPositionFromIndex(fileName, textSpan.start);
            var script = _this.fileNameToScript[fileName];
            var preview = script.getLinePreview(position.line);
            return { preview: preview, position: position };
        };
        this.getCompilationSettings = function () {
            return _this.config.project.compilerOptions;
        };
        this.getScriptFileNames = function () {
            return Object.keys(_this.fileNameToScript);
        };
        this.getScriptVersion = function (fileName) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                return '' + script.getVersion();
            }
            return '0';
        };
        this.getScriptIsOpen = function (fileName) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                return script.getIsOpen();
            }
            return false;
        };
        this.getScriptSnapshot = function (fileName) {
            var script = _this.fileNameToScript[fileName];
            if (script) {
                return getScriptSnapShot(script);
            } else if (fs.existsSync(fileName)) {
                _this.config.project.files.push(fileName);
                _this.addScript(fileName);
                return _this.getScriptSnapshot(fileName);
            }
            return null;
        };
        this.getCurrentDirectory = function () {
            return _this.config.projectFileDirectory;
        };
        this.getDefaultLibFileName = ts.getDefaultLibFileName;
        if (!config.project.compilerOptions.noLib) {
            this.addScript(exports.getDefaultLibFilePath(config.project.compilerOptions));
        }
    }
    return LanguageServiceHost;
})();
exports.LanguageServiceHost = LanguageServiceHost;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2xhbmcvY29yZS9sYW5ndWFnZVNlcnZpY2VIb3N0Mi5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDM0IsSUFBSSxFQUFFLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDO0FBQ3ZCLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ2hELFNBQVMsZ0JBQWdCLENBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUU7QUFDOUMsUUFBSSxNQUFNLEtBQUssS0FBSyxDQUFDLEVBQUU7QUFBRSxjQUFNLEdBQUcsS0FBSyxDQUFDO0tBQUU7QUFDMUMsUUFBSSxPQUFPLEdBQUcsQ0FBQyxDQUFDO0FBQ2hCLFFBQUksVUFBVSxHQUFHLEVBQUUsQ0FBQztBQUNwQixRQUFJLFdBQVcsQ0FBQztBQUNoQixRQUFJLGlCQUFpQixHQUFHLElBQUksQ0FBQztBQUM3QixRQUFJLE1BQU0sR0FBRyxJQUFJLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNsQyxhQUFTLGFBQWEsR0FBRztBQUNyQixZQUFJLGlCQUFpQixFQUFFO0FBQ25CLHVCQUFXLEdBQUcsRUFBRSxDQUFDO0FBQ2pCLGdCQUFJLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFDcEIsa0JBQU0sQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQVUsSUFBSSxFQUFFLEtBQUssRUFBRTtBQUN4QywyQkFBVyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM5QixvQkFBSSxVQUFVLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUM3QiwyQkFBVyxHQUFHLFdBQVcsR0FBRyxVQUFVLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUM7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LEtBQUssQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUMscUJBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUIsdUJBQU8sS0FBSyxDQUFDLGlCQUFpQixDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQzVDO0FBQ0QsbUJBQU8sSUFBSSxDQUFDO1NBQ2YsQ0FBQztBQUNGLFlBQUksQ0FBQyxtQkFBbUIsR0FBRyxZQUFZO0FBQ25DLG1CQUFPLEtBQUssQ0FBQyxNQUFNLENBQUMsb0JBQW9CLENBQUM7U0FDNUMsQ0FBQztBQUNGLFlBQUksQ0FBQyxxQkFBcUIsR0FBRyxFQUFFLENBQUMscUJBQXFCLENBQUM7QUFDdEQsWUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRTtBQUN2QyxnQkFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMscUJBQXFCLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO1NBQ2pGO0tBQ0o7QUFDRCxXQUFPLG1CQUFtQixDQUFDO0NBQzlCLENBQUEsRUFBRyxDQUFDO0FBQ0wsT0FBTyxDQUFDLG1CQUFtQixHQUFHLG1CQUFtQixDQUFDIiwiZmlsZSI6Ii9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2xhbmcvY29yZS9sYW5ndWFnZVNlcnZpY2VIb3N0Mi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciB0ZXh0QnVmZmVyID0gcmVxdWlyZSgnYmFzYXJhdC10ZXh0LWJ1ZmZlcicpO1xuZnVuY3Rpb24gY3JlYXRlU2NyaXB0SW5mbyhmaWxlTmFtZSwgdGV4dCwgaXNPcGVuKSB7XG4gICAgaWYgKGlzT3BlbiA9PT0gdm9pZCAwKSB7IGlzT3BlbiA9IGZhbHNlOyB9XG4gICAgdmFyIHZlcnNpb24gPSAxO1xuICAgIHZhciBlZGl0UmFuZ2VzID0gW107XG4gICAgdmFyIF9saW5lU3RhcnRzO1xuICAgIHZhciBfbGluZVN0YXJ0SXNEaXJ0eSA9IHRydWU7XG4gICAgdmFyIGJ1ZmZlciA9IG5ldyB0ZXh0QnVmZmVyKHRleHQpO1xuICAgIGZ1bmN0aW9uIGdldExpbmVTdGFydHMoKSB7XG4gICAgICAgIGlmIChfbGluZVN0YXJ0SXNEaXJ0eSkge1xuICAgICAgICAgICAgX2xpbmVTdGFydHMgPSBbXTtcbiAgICAgICAgICAgIHZhciB0b3RhbExlbmd0aCA9IDA7XG4gICAgICAgICAgICBidWZmZXIubGluZXMuZm9yRWFjaChmdW5jdGlvbiAobGluZSwgaW5kZXgpIHtcbiAgICAgICAgICAgICAgICBfbGluZVN0YXJ0cy5wdXNoKHRvdGFsTGVuZ3RoKTtcbiAgICAgICAgICAgICAgICB2YXIgbGluZUxlbmd0aCA9IGxpbmUubGVuZ3RoO1xuICAgICAgICAgICAgICAgIHRvdGFsTGVuZ3RoID0gdG90YWxMZW5ndGggKyBsaW5lTGVuZ3RoICsgYnVmZmVyLmxpbmVFbmRpbmdzW2luZGV4XS5sZW5ndGg7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIF9saW5lU3RhcnRJc0RpcnR5ID0gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIF9saW5lU3RhcnRzO1xuICAgIH1cbiAgICBmdW5jdGlvbiB1cGRhdGVDb250ZW50KG5ld0NvbnRlbnQpIHtcbiAgICAgICAgYnVmZmVyID0gbmV3IHRleHRCdWZmZXIobmV3Q29udGVudCk7XG4gICAgICAgIF9saW5lU3RhcnRJc0RpcnR5ID0gdHJ1ZTtcbiAgICAgICAgZWRpdFJhbmdlcyA9IFtdO1xuICAgICAgICB2ZXJzaW9uKys7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGVkaXRDb250ZW50KG1pbkNoYXIsIGxpbUNoYXIsIG5ld1RleHQpIHtcbiAgICAgICAgdmFyIHN0YXJ0ID0gZ2V0TGluZUFuZENvbEZvclBvc2l0b24obWluQ2hhcik7XG4gICAgICAgIHZhciBlbmQgPSBnZXRMaW5lQW5kQ29sRm9yUG9zaXRvbihsaW1DaGFyKTtcbiAgICAgICAgYnVmZmVyLnNldFRleHRJblJhbmdlKFtbc3RhcnQubGluZSwgc3RhcnQuY29sXSwgW2VuZC5saW5lLCBlbmQuY29sXV0sIG5ld1RleHQsIHsgbm9ybWFsaXplTGluZUVuZGluZ3M6IGZhbHNlIH0pO1xuICAgICAgICBfbGluZVN0YXJ0SXNEaXJ0eSA9IHRydWU7XG4gICAgICAgIGVkaXRSYW5nZXMucHVzaCh7XG4gICAgICAgICAgICBzcGFuOiB7IHN0YXJ0OiBtaW5DaGFyLCBsZW5ndGg6IGxpbUNoYXIgLSBtaW5DaGFyIH0sXG4gICAgICAgICAgICBuZXdMZW5ndGg6IG5ld1RleHQubGVuZ3RoXG4gICAgICAgIH0pO1xuICAgICAgICB2ZXJzaW9uKys7XG4gICAgfVxuICAgIGZ1bmN0aW9uIGdldFBvc2l0aW9uRnJvbUxpbmUobGluZSwgY2gpIHtcbiAgICAgICAgcmV0dXJuIGJ1ZmZlci5jaGFyYWN0ZXJJbmRleEZvclBvc2l0aW9uKFtsaW5lLCBjaF0pO1xuICAgIH1cbiAgICBmdW5jdGlvbiBnZXRMaW5lQW5kQ29sRm9yUG9zaXRvbihwb3NpdGlvbikge1xuICAgICAgICB2YXIgX2EgPSBidWZmZXIucG9zaXRpb25Gb3JDaGFyYWN0ZXJJbmRleChwb3NpdGlvbiksIHJvdyA9IF9hLnJvdywgY29sdW1uID0gX2EuY29sdW1uO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgbGluZTogcm93LFxuICAgICAgICAgICAgY29sOiBjb2x1bW5cbiAgICAgICAgfTtcbiAgICB9XG4gICAgZnVuY3Rpb24gZ2V0TGluZVByZXZpZXcobGluZSkge1xuICAgICAgICByZXR1cm4gKGJ1ZmZlci5saW5lc1tsaW5lXSB8fCAnJykudHJpbSgpO1xuICAgIH1cbiAgICByZXR1cm4ge1xuICAgICAgICBnZXRGaWxlTmFtZTogZnVuY3Rpb24gKCkgeyByZXR1cm4gZmlsZU5hbWU7IH0sXG4gICAgICAgIGdldENvbnRlbnQ6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGJ1ZmZlci5nZXRUZXh0KCk7IH0sXG4gICAgICAgIGdldFZlcnNpb246IGZ1bmN0aW9uICgpIHsgcmV0dXJuIHZlcnNpb247IH0sXG4gICAgICAgIGdldElzT3BlbjogZnVuY3Rpb24gKCkgeyByZXR1cm4gaXNPcGVuOyB9LFxuICAgICAgICBzZXRJc09wZW46IGZ1bmN0aW9uICh2YWwpIHsgcmV0dXJuIGlzT3BlbiA9IHZhbDsgfSxcbiAgICAgICAgZ2V0RWRpdFJhbmdlczogZnVuY3Rpb24gKCkgeyByZXR1cm4gZWRpdFJhbmdlczsgfSxcbiAgICAgICAgZ2V0TGluZVN0YXJ0czogZ2V0TGluZVN0YXJ0cyxcbiAgICAgICAgdXBkYXRlQ29udGVudDogdXBkYXRlQ29udGVudCxcbiAgICAgICAgZWRpdENvbnRlbnQ6IGVkaXRDb250ZW50LFxuICAgICAgICBnZXRQb3NpdGlvbkZyb21MaW5lOiBnZXRQb3NpdGlvbkZyb21MaW5lLFxuICAgICAgICBnZXRMaW5lQW5kQ29sRm9yUG9zaXRvbjogZ2V0TGluZUFuZENvbEZvclBvc2l0b24sXG4gICAgICAgIGdldExpbmVQcmV2aWV3OiBnZXRMaW5lUHJldmlld1xuICAgIH07XG59XG5mdW5jdGlvbiBnZXRTY3JpcHRTbmFwU2hvdChzY3JpcHRJbmZvKSB7XG4gICAgdmFyIGxpbmVTdGFydHMgPSBzY3JpcHRJbmZvLmdldExpbmVTdGFydHMoKTtcbiAgICB2YXIgdGV4dFNuYXBzaG90ID0gc2NyaXB0SW5mby5nZXRDb250ZW50KCk7XG4gICAgdmFyIHZlcnNpb24gPSBzY3JpcHRJbmZvLmdldFZlcnNpb24oKTtcbiAgICB2YXIgZWRpdFJhbmdlcyA9IHNjcmlwdEluZm8uZ2V0RWRpdFJhbmdlcygpO1xuICAgIGZ1bmN0aW9uIGdldENoYW5nZVJhbmdlKG9sZFNuYXBzaG90KSB7XG4gICAgICAgIHZhciB1bmNoYW5nZWQgPSB7IHNwYW46IHsgc3RhcnQ6IDAsIGxlbmd0aDogMCB9LCBuZXdMZW5ndGg6IDAgfTtcbiAgICAgICAgZnVuY3Rpb24gY29sbGFwc2VDaGFuZ2VzQWNyb3NzTXVsdGlwbGVWZXJzaW9ucyhjaGFuZ2VzKSB7XG4gICAgICAgICAgICBpZiAoY2hhbmdlcy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gdW5jaGFuZ2VkO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGNoYW5nZXMubGVuZ3RoID09PSAxKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGNoYW5nZXNbMF07XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgY2hhbmdlMCA9IGNoYW5nZXNbMF07XG4gICAgICAgICAgICB2YXIgb2xkU3RhcnROID0gY2hhbmdlMC5zcGFuLnN0YXJ0O1xuICAgICAgICAgICAgdmFyIG9sZEVuZE4gPSBjaGFuZ2UwLnNwYW4uc3RhcnQgKyBjaGFuZ2UwLnNwYW4ubGVuZ3RoO1xuICAgICAgICAgICAgdmFyIG5ld0VuZE4gPSBvbGRTdGFydE4gKyBjaGFuZ2UwLm5ld0xlbmd0aDtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAxOyBpIDwgY2hhbmdlcy5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBuZXh0Q2hhbmdlID0gY2hhbmdlc1tpXTtcbiAgICAgICAgICAgICAgICB2YXIgb2xkU3RhcnQxID0gb2xkU3RhcnROO1xuICAgICAgICAgICAgICAgIHZhciBvbGRFbmQxID0gb2xkRW5kTjtcbiAgICAgICAgICAgICAgICB2YXIgbmV3RW5kMSA9IG5ld0VuZE47XG4gICAgICAgICAgICAgICAgdmFyIG9sZFN0YXJ0MiA9IG5leHRDaGFuZ2Uuc3Bhbi5zdGFydDtcbiAgICAgICAgICAgICAgICB2YXIgb2xkRW5kMiA9IG5leHRDaGFuZ2Uuc3Bhbi5zdGFydCArIG5leHRDaGFuZ2Uuc3Bhbi5sZW5ndGg7XG4gICAgICAgICAgICAgICAgdmFyIG5ld0VuZDIgPSBvbGRTdGFydDIgKyBuZXh0Q2hhbmdlLm5ld0xlbmd0aDtcbiAgICAgICAgICAgICAgICBvbGRTdGFydE4gPSBNYXRoLm1pbihvbGRTdGFydDEsIG9sZFN0YXJ0Mik7XG4gICAgICAgICAgICAgICAgb2xkRW5kTiA9IE1hdGgubWF4KG9sZEVuZDEsIG9sZEVuZDEgKyAob2xkRW5kMiAtIG5ld0VuZDEpKTtcbiAgICAgICAgICAgICAgICBuZXdFbmROID0gTWF0aC5tYXgobmV3RW5kMiwgbmV3RW5kMiArIChuZXdFbmQxIC0gb2xkRW5kMikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIHsgc3BhbjogeyBzdGFydDogb2xkU3RhcnROLCBsZW5ndGg6IG9sZEVuZE4gLSBvbGRTdGFydE4gfSwgbmV3TGVuZ3RoOiBuZXdFbmROIC0gb2xkU3RhcnROIH07XG4gICAgICAgIH1cbiAgICAgICAgO1xuICAgICAgICB2YXIgc2NyaXB0VmVyc2lvbiA9IG9sZFNuYXBzaG90LnZlcnNpb24gfHwgMDtcbiAgICAgICAgaWYgKHNjcmlwdFZlcnNpb24gPT09IHZlcnNpb24pIHtcbiAgICAgICAgICAgIHJldHVybiB1bmNoYW5nZWQ7XG4gICAgICAgIH1cbiAgICAgICAgdmFyIGluaXRpYWxFZGl0UmFuZ2VJbmRleCA9IGVkaXRSYW5nZXMubGVuZ3RoIC0gKHZlcnNpb24gLSBzY3JpcHRWZXJzaW9uKTtcbiAgICAgICAgaWYgKGluaXRpYWxFZGl0UmFuZ2VJbmRleCA8IDApIHtcbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgICAgIHZhciBlbnRyaWVzID0gZWRpdFJhbmdlcy5zbGljZShpbml0aWFsRWRpdFJhbmdlSW5kZXgpO1xuICAgICAgICByZXR1cm4gY29sbGFwc2VDaGFuZ2VzQWNyb3NzTXVsdGlwbGVWZXJzaW9ucyhlbnRyaWVzKTtcbiAgICB9XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZ2V0VGV4dDogZnVuY3Rpb24gKHN0YXJ0LCBlbmQpIHsgcmV0dXJuIHRleHRTbmFwc2hvdC5zdWJzdHJpbmcoc3RhcnQsIGVuZCk7IH0sXG4gICAgICAgIGdldExlbmd0aDogZnVuY3Rpb24gKCkgeyByZXR1cm4gdGV4dFNuYXBzaG90Lmxlbmd0aDsgfSxcbiAgICAgICAgZ2V0Q2hhbmdlUmFuZ2U6IGdldENoYW5nZVJhbmdlLFxuICAgICAgICBnZXRMaW5lU3RhcnRQb3NpdGlvbnM6IGZ1bmN0aW9uICgpIHsgcmV0dXJuIGxpbmVTdGFydHM7IH0sXG4gICAgICAgIHZlcnNpb246IHZlcnNpb25cbiAgICB9O1xufVxuZXhwb3J0cy5nZXREZWZhdWx0TGliRmlsZVBhdGggPSBmdW5jdGlvbiAob3B0aW9ucykge1xuICAgIHZhciBmaWxlbmFtZSA9IHRzLmdldERlZmF1bHRMaWJGaWxlTmFtZShvcHRpb25zKTtcbiAgICByZXR1cm4gKHBhdGguam9pbihwYXRoLmRpcm5hbWUocmVxdWlyZS5yZXNvbHZlKCdudHlwZXNjcmlwdCcpKSwgZmlsZW5hbWUpKS5zcGxpdCgnXFxcXCcpLmpvaW4oJy8nKTtcbn07XG5leHBvcnRzLnR5cGVzY3JpcHREaXJlY3RvcnkgPSBwYXRoLmRpcm5hbWUocmVxdWlyZS5yZXNvbHZlKCdudHlwZXNjcmlwdCcpKS5zcGxpdCgnXFxcXCcpLmpvaW4oJy8nKTtcbnZhciBMYW5ndWFnZVNlcnZpY2VIb3N0ID0gKGZ1bmN0aW9uICgpIHtcbiAgICBmdW5jdGlvbiBMYW5ndWFnZVNlcnZpY2VIb3N0KGNvbmZpZykge1xuICAgICAgICB2YXIgX3RoaXMgPSB0aGlzO1xuICAgICAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICAgICAgdGhpcy5maWxlTmFtZVRvU2NyaXB0ID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbiAgICAgICAgdGhpcy5hZGRTY3JpcHQgPSBmdW5jdGlvbiAoZmlsZU5hbWUsIGNvbnRlbnQpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgaWYgKCFjb250ZW50KSB7XG4gICAgICAgICAgICAgICAgICAgIGNvbnRlbnQgPSBmcy5yZWFkRmlsZVN5bmMoZmlsZU5hbWUpLnRvU3RyaW5nKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2F0Y2ggKGV4KSB7XG4gICAgICAgICAgICAgICAgY29udGVudCA9ICcnO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgdmFyIHNjcmlwdCA9IGNyZWF0ZVNjcmlwdEluZm8oZmlsZU5hbWUsIGNvbnRlbnQpO1xuICAgICAgICAgICAgX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV0gPSBzY3JpcHQ7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucmVtb3ZlU2NyaXB0ID0gZnVuY3Rpb24gKGZpbGVOYW1lKSB7XG4gICAgICAgICAgICBkZWxldGUgX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV07XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMucmVtb3ZlQWxsID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgX3RoaXMuZmlsZU5hbWVUb1NjcmlwdCA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMudXBkYXRlU2NyaXB0ID0gZnVuY3Rpb24gKGZpbGVOYW1lLCBjb250ZW50KSB7XG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV07XG4gICAgICAgICAgICBpZiAoc2NyaXB0KSB7XG4gICAgICAgICAgICAgICAgc2NyaXB0LnVwZGF0ZUNvbnRlbnQoY29udGVudCk7XG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgX3RoaXMuYWRkU2NyaXB0KGZpbGVOYW1lLCBjb250ZW50KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5lZGl0U2NyaXB0ID0gZnVuY3Rpb24gKGZpbGVOYW1lLCBzdGFydCwgZW5kLCBuZXdUZXh0KSB7XG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV07XG4gICAgICAgICAgICBpZiAoc2NyaXB0KSB7XG4gICAgICAgICAgICAgICAgdmFyIG1pbkNoYXIgPSBzY3JpcHQuZ2V0UG9zaXRpb25Gcm9tTGluZShzdGFydC5saW5lLCBzdGFydC5jb2wpO1xuICAgICAgICAgICAgICAgIHZhciBsaW1DaGFyID0gc2NyaXB0LmdldFBvc2l0aW9uRnJvbUxpbmUoZW5kLmxpbmUsIGVuZC5jb2wpO1xuICAgICAgICAgICAgICAgIHNjcmlwdC5lZGl0Q29udGVudChtaW5DaGFyLCBsaW1DaGFyLCBuZXdUZXh0KTtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNjcmlwdCB3aXRoIG5hbWUgXFwnJyArIGZpbGVOYW1lICsgJ1xcJycpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLnNldFNjcmlwdElzT3BlbiA9IGZ1bmN0aW9uIChmaWxlTmFtZSwgaXNPcGVuKSB7XG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV07XG4gICAgICAgICAgICBpZiAoc2NyaXB0KSB7XG4gICAgICAgICAgICAgICAgc2NyaXB0LnNldElzT3Blbihpc09wZW4pO1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcignTm8gc2NyaXB0IHdpdGggbmFtZSBcXCcnICsgZmlsZU5hbWUgKyAnXFwnJyk7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ2V0U2NyaXB0Q29udGVudCA9IGZ1bmN0aW9uIChmaWxlTmFtZSkge1xuICAgICAgICAgICAgdmFyIHNjcmlwdCA9IF90aGlzLmZpbGVOYW1lVG9TY3JpcHRbZmlsZU5hbWVdO1xuICAgICAgICAgICAgaWYgKHNjcmlwdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBzY3JpcHQuZ2V0Q29udGVudCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaGFzU2NyaXB0ID0gZnVuY3Rpb24gKGZpbGVOYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gISFfdGhpcy5maWxlTmFtZVRvU2NyaXB0W2ZpbGVOYW1lXTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXRJbmRleEZyb21Qb3NpdGlvbiA9IGZ1bmN0aW9uIChmaWxlTmFtZSwgcG9zaXRpb24pIHtcbiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBfdGhpcy5maWxlTmFtZVRvU2NyaXB0W2ZpbGVOYW1lXTtcbiAgICAgICAgICAgIGlmIChzY3JpcHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc2NyaXB0LmdldFBvc2l0aW9uRnJvbUxpbmUocG9zaXRpb24ubGluZSwgcG9zaXRpb24uY29sKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAtMTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXRQb3NpdGlvbkZyb21JbmRleCA9IGZ1bmN0aW9uIChmaWxlTmFtZSwgaW5kZXgpIHtcbiAgICAgICAgICAgIGlmICghX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV0pXG4gICAgICAgICAgICAgICAgX3RoaXMuYWRkU2NyaXB0KGZpbGVOYW1lKTtcbiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBfdGhpcy5maWxlTmFtZVRvU2NyaXB0W2ZpbGVOYW1lXTtcbiAgICAgICAgICAgIGlmIChzY3JpcHQpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gc2NyaXB0LmdldExpbmVBbmRDb2xGb3JQb3NpdG9uKGluZGV4KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmdldFBvc2l0aW9uRnJvbVRleHRTcGFuV2l0aExpbmVQcmV2aWV3ID0gZnVuY3Rpb24gKGZpbGVOYW1lLCB0ZXh0U3Bhbikge1xuICAgICAgICAgICAgdmFyIHBvc2l0aW9uID0gX3RoaXMuZ2V0UG9zaXRpb25Gcm9tSW5kZXgoZmlsZU5hbWUsIHRleHRTcGFuLnN0YXJ0KTtcbiAgICAgICAgICAgIHZhciBzY3JpcHQgPSBfdGhpcy5maWxlTmFtZVRvU2NyaXB0W2ZpbGVOYW1lXTtcbiAgICAgICAgICAgIHZhciBwcmV2aWV3ID0gc2NyaXB0LmdldExpbmVQcmV2aWV3KHBvc2l0aW9uLmxpbmUpO1xuICAgICAgICAgICAgcmV0dXJuIHsgcHJldmlldzogcHJldmlldywgcG9zaXRpb246IHBvc2l0aW9uIH07XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ2V0Q29tcGlsYXRpb25TZXR0aW5ncyA9IGZ1bmN0aW9uICgpIHsgcmV0dXJuIF90aGlzLmNvbmZpZy5wcm9qZWN0LmNvbXBpbGVyT3B0aW9uczsgfTtcbiAgICAgICAgdGhpcy5nZXRTY3JpcHRGaWxlTmFtZXMgPSBmdW5jdGlvbiAoKSB7IHJldHVybiBPYmplY3Qua2V5cyhfdGhpcy5maWxlTmFtZVRvU2NyaXB0KTsgfTtcbiAgICAgICAgdGhpcy5nZXRTY3JpcHRWZXJzaW9uID0gZnVuY3Rpb24gKGZpbGVOYW1lKSB7XG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV07XG4gICAgICAgICAgICBpZiAoc2NyaXB0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuICcnICsgc2NyaXB0LmdldFZlcnNpb24oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiAnMCc7XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuZ2V0U2NyaXB0SXNPcGVuID0gZnVuY3Rpb24gKGZpbGVOYW1lKSB7XG4gICAgICAgICAgICB2YXIgc2NyaXB0ID0gX3RoaXMuZmlsZU5hbWVUb1NjcmlwdFtmaWxlTmFtZV07XG4gICAgICAgICAgICBpZiAoc2NyaXB0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHNjcmlwdC5nZXRJc09wZW4oKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXRTY3JpcHRTbmFwc2hvdCA9IGZ1bmN0aW9uIChmaWxlTmFtZSkge1xuICAgICAgICAgICAgdmFyIHNjcmlwdCA9IF90aGlzLmZpbGVOYW1lVG9TY3JpcHRbZmlsZU5hbWVdO1xuICAgICAgICAgICAgaWYgKHNjcmlwdCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBnZXRTY3JpcHRTbmFwU2hvdChzY3JpcHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoZnMuZXhpc3RzU3luYyhmaWxlTmFtZSkpIHtcbiAgICAgICAgICAgICAgICBfdGhpcy5jb25maWcucHJvamVjdC5maWxlcy5wdXNoKGZpbGVOYW1lKTtcbiAgICAgICAgICAgICAgICBfdGhpcy5hZGRTY3JpcHQoZmlsZU5hbWUpO1xuICAgICAgICAgICAgICAgIHJldHVybiBfdGhpcy5nZXRTY3JpcHRTbmFwc2hvdChmaWxlTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXRDdXJyZW50RGlyZWN0b3J5ID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgcmV0dXJuIF90aGlzLmNvbmZpZy5wcm9qZWN0RmlsZURpcmVjdG9yeTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5nZXREZWZhdWx0TGliRmlsZU5hbWUgPSB0cy5nZXREZWZhdWx0TGliRmlsZU5hbWU7XG4gICAgICAgIGlmICghY29uZmlnLnByb2plY3QuY29tcGlsZXJPcHRpb25zLm5vTGliKSB7XG4gICAgICAgICAgICB0aGlzLmFkZFNjcmlwdChleHBvcnRzLmdldERlZmF1bHRMaWJGaWxlUGF0aChjb25maWcucHJvamVjdC5jb21waWxlck9wdGlvbnMpKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gTGFuZ3VhZ2VTZXJ2aWNlSG9zdDtcbn0pKCk7XG5leHBvcnRzLkxhbmd1YWdlU2VydmljZUhvc3QgPSBMYW5ndWFnZVNlcnZpY2VIb3N0O1xuIl19