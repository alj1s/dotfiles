'use babel';
/* @flow */

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var HackWorker = require('../lib/HackWorker');

var _require = require('events');

var EventEmitter = _require.EventEmitter;

var logger = require('nuclide-logging').getLogger();

describe('HackWorker', function () {
  describe('runWorkerTask()', function () {
    var hackWorker;
    beforeEach(function () {
      hackWorker = new HackWorker();
    });

    afterEach(function () {
      hackWorker.dispose();
    });

    it('runs a trivial function task', function () {
      var taskHandler = jasmine.createSpy();
      hackWorker.runWorkerTask({ cmd: 'parseInt', args: ['25'] }).then(taskHandler);
      waitsFor(function () {
        return taskHandler.callCount > 0;
      });
      runs(function () {
        var response = taskHandler.argsForCall[0][0];
        expect(response).toBe(25);
      });
    });

    it('fail a worker task and gets error', function () {
      var taskHandler = jasmine.createSpy();
      hackWorker.runWorkerTask({ cmd: 'nothing', args: [] })['catch'](taskHandler);
      waitsFor(function () {
        return taskHandler.callCount > 0;
      });
      runs(function () {
        var error = taskHandler.argsForCall[0][0];
        expect(error.type).toBe('error');
        expect(error.message).toBe('Uncaught TypeError: Cannot read property \'apply\' of undefined');
      });
    });
  });

  describe('simulate queueing tasks with custom worker', function () {
    var hackWorker;
    var worker;
    var workerReplyIn = function workerReplyIn(milliSeconds) {
      worker.postMessage = function (message) {
        setTimeout(function () {
          worker.emit('message', { data: message });
        }, milliSeconds);
      };
    };
    beforeEach(function () {
      worker = new EventEmitter();
      worker.addEventListener = worker.addListener;
      worker.terminate = function () {
        return 0;
      };
      workerReplyIn(5);
      hackWorker = new HackWorker({ worker: worker, webWorkerTimeout: 10, poorPerfTimeout: 20 });
    });

    afterEach(function () {
      hackWorker.dispose();
    });

    it('queues and processes two tasks in order', function () {
      var task1Handler = jasmine.createSpy();
      hackWorker.runWorkerTask('reply1').then(task1Handler);
      var task2Handler = jasmine.createSpy();
      hackWorker.runWorkerTask('reply2').then(task2Handler);
      expect(task1Handler.callCount).toBe(0);
      expect(task2Handler.callCount).toBe(0);
      window.advanceClock(6);
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(1);
        expect(task1Handler.argsForCall[0][0]).toBe('reply1');
        expect(task2Handler.callCount).toBe(0);
        window.advanceClock(6);
      });
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(1);
        expect(task2Handler.callCount).toBe(1);
        expect(task2Handler.argsForCall[0][0]).toBe('reply2');
      });
    });

    it('task timeout warning, then the result', function () {
      var warnHandler = logger.warn = jasmine.createSpy();
      workerReplyIn(15);
      var taskHandler = jasmine.createSpy();
      hackWorker.runWorkerTask('reply').then(taskHandler);
      window.advanceClock(11);
      waits(1);
      runs(function () {
        expect(taskHandler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(1);
        expect(warnHandler.argsForCall[0][0]).toBe('Webworker is stuck in a job!');
        window.advanceClock(5);
      });
      waits(1);
      runs(function () {
        expect(taskHandler.callCount).toBe(1);
        expect(warnHandler.callCount).toBe(1);
        expect(taskHandler.argsForCall[0][0]).toBe('reply');
      });
    });

    it('task timeout and perf warnings, then the result, then a normal task time', function () {
      var warnHandler = logger.warn = jasmine.createSpy();
      var task1Handler = jasmine.createSpy();
      var task2Handler = jasmine.createSpy();
      // schedule the first task with extraordinary response time.
      workerReplyIn(25);
      hackWorker.runWorkerTask('reply1').then(task1Handler);
      // queue another task with a normal task time.
      workerReplyIn(5);
      hackWorker.runWorkerTask('reply2').then(task2Handler);
      window.advanceClock(11);
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(0);
        expect(task2Handler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(1);
        expect(warnHandler.argsForCall[0][0]).toBe('Webworker is stuck in a job!');
        window.advanceClock(11);
      });
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(0);
        expect(task2Handler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(2);
        expect(warnHandler.argsForCall[1][0]).toBe('Poor Webworker Performance!');
        window.advanceClock(4);
      });
      waits(1);
      runs(function () {
        expect(task1Handler.callCount).toBe(1);
        expect(task1Handler.argsForCall[0][0]).toBe('reply1');
        expect(task2Handler.callCount).toBe(0);
        expect(warnHandler.callCount).toBe(2);
        window.advanceClock(6);
      });
      waits(1);
      runs(function () {
        expect(task2Handler.callCount).toBe(1);
        expect(task2Handler.argsForCall[0][0]).toBe('reply2');
      });
    });
  });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9udWNsaWRlLWhhY2svc3BlYy9IYWNrV29ya2VyLXNwZWMuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsV0FBVyxDQUFDOzs7Ozs7Ozs7OztBQVdaLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDOztlQUN6QixPQUFPLENBQUMsUUFBUSxDQUFDOztJQUFqQyxZQUFZLFlBQVosWUFBWTs7QUFDakIsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7O0FBRXBELFFBQVEsQ0FBQyxZQUFZLEVBQUUsWUFBTTtBQUMzQixVQUFRLENBQUMsaUJBQWlCLEVBQUUsWUFBTTtBQUNoQyxRQUFJLFVBQVUsQ0FBQztBQUNmLGNBQVUsQ0FBQyxZQUFNO0FBQ2YsZ0JBQVUsR0FBRyxJQUFJLFVBQVUsRUFBRSxDQUFDO0tBQy9CLENBQUMsQ0FBQzs7QUFFSCxhQUFTLENBQUMsWUFBTTtBQUNkLGdCQUFVLENBQUMsT0FBTyxFQUFFLENBQUM7S0FDdEIsQ0FBQyxDQUFDOztBQUVILE1BQUUsQ0FBQyw4QkFBOEIsRUFBRSxZQUFNO0FBQ3ZDLFVBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztBQUN0QyxnQkFBVSxDQUFDLGFBQWEsQ0FBQyxFQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLENBQUMsSUFBSSxDQUFDLEVBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztBQUM1RSxjQUFRLENBQUM7ZUFBTSxXQUFXLENBQUMsU0FBUyxHQUFHLENBQUM7T0FBQSxDQUFDLENBQUM7QUFDMUMsVUFBSSxDQUFDLFlBQU07QUFDVCxZQUFJLFFBQVEsR0FBRyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzdDLGNBQU0sQ0FBQyxRQUFR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LGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEQsWUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4QixXQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDVCxVQUFJLENBQUMsWUFBTTtBQUNULGNBQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLGNBQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLGNBQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLGNBQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLDhCQUE4QixDQUFDLENBQUM7QUFDM0UsY0FBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQztPQUN6QixDQUFDLENBQUM7QUFDSCxXQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDVCxVQUFJLENBQUMsWUFBTTtBQUNULGNBQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLGNBQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLGNBQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLGNBQU0sQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLDZCQUE2QixDQUFDLENBQUM7QUFDMUUsY0FBTSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsQ0FBQztPQUN4QixDQUFDLENBQUM7QUFDSCxXQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDVCxVQUFJLENBQUMsWUFBTTtBQUNULGNBQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLGNBQU0sQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQ3RELGNBQU0sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3ZDLGNBQU0sQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ3RDLGNBQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUM7T0FDeEIsQ0FBQyxDQUFDO0FBQ0gsV0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ1QsVUFBSSxDQUFDLFlBQU07QUFDVCxjQUFNLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUN2QyxjQUFNLENBQUMsWUFBWSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztPQUN2RCxDQUFDLENBQUM7S0FDSixDQUFDLENBQUM7R0FDSixDQUFDLENBQUM7Q0FDSixDQUFDLENBQUMiLCJmaWxlIjoiL1VzZXJzL2FuZHJld2pvbmVzLy5hdG9tL3BhY2thZ2VzL251Y2xpZGUtaGFjay9zcGVjL0hhY2tXb3JrZXItc3BlYy5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbnZhciBIYWNrV29ya2VyID0gcmVxdWlyZSgnLi4vbGliL0hhY2tXb3JrZXInKTtcbnZhciB7RXZlbnRFbWl0dGVyfSA9IHJlcXVpcmUoJ2V2ZW50cycpO1xudmFyIGxvZ2dlciA9IHJlcXVpcmUoJ251Y2xpZGUtbG9nZ2luZycpLmdldExvZ2dlcigpO1xuXG5kZXNjcmliZSgnSGFja1dvcmtlcicsICgpID0+IHtcbiAgZGVzY3JpYmUoJ3J1bldvcmtlclRhc2soKScsICgpID0+IHtcbiAgICB2YXIgaGFja1dvcmtlcjtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGhhY2tXb3JrZXIgPSBuZXcgSGFja1dvcmtlcigpO1xuICAgIH0pO1xuXG4gICAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICAgIGhhY2tXb3JrZXIuZGlzcG9zZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3J1bnMgYSB0cml2aWFsIGZ1bmN0aW9uIHRhc2snLCAoKSA9PiB7XG4gICAgICB2YXIgdGFza0hhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgaGFja1dvcmtlci5ydW5Xb3JrZXJUYXNrKHtjbWQ6ICdwYXJzZUludCcsIGFyZ3M6IFsnMjUnXX0pLnRoZW4odGFza0hhbmRsZXIpO1xuICAgICAgd2FpdHNGb3IoKCkgPT4gdGFza0hhbmRsZXIuY2FsbENvdW50ID4gMCk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgdmFyIHJlc3BvbnNlID0gdGFza0hhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF07XG4gICAgICAgIGV4cGVjdChyZXNwb25zZSkudG9CZSgyNSk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdmYWlsIGEgd29ya2VyIHRhc2sgYW5kIGdldHMgZXJyb3InLCAoKSA9PiB7XG4gICAgICB2YXIgdGFza0hhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgaGFja1dvcmtlci5ydW5Xb3JrZXJUYXNrKHtjbWQ6ICdub3RoaW5nJywgYXJnczogW119KS5jYXRjaCh0YXNrSGFuZGxlcik7XG4gICAgICB3YWl0c0ZvcigoKSA9PiB0YXNrSGFuZGxlci5jYWxsQ291bnQgPiAwKTtcbiAgICAgIHJ1bnMoKCkgPT4ge1xuICAgICAgICB2YXIgZXJyb3IgPSB0YXNrSGFuZGxlci5hcmdzRm9yQ2FsbFswXVswXTtcbiAgICAgICAgZXhwZWN0KGVycm9yLnR5cGUpLnRvQmUoJ2Vycm9yJyk7XG4gICAgICAgIGV4cGVjdChlcnJvci5tZXNzYWdlKS50b0JlKCdVbmNhdWdodCBUeXBlRXJyb3I6IENhbm5vdCByZWFkIHByb3BlcnR5IFxcJ2FwcGx5XFwnIG9mIHVuZGVmaW5lZCcpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzaW11bGF0ZSBxdWV1ZWluZyB0YXNrcyB3aXRoIGN1c3RvbSB3b3JrZXInLCAoKSA9PiB7XG4gICAgdmFyIGhhY2tXb3JrZXI7XG4gICAgdmFyIHdvcmtlcjtcbiAgICB2YXIgd29ya2VyUmVwbHlJbiA9IChtaWxsaVNlY29uZHMpID0+IHtcbiAgICAgIHdvcmtlci5wb3N0TWVzc2FnZSA9IChtZXNzYWdlKSA9PiB7XG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICAgIHdvcmtlci5lbWl0KCdtZXNzYWdlJywge2RhdGE6IG1lc3NhZ2V9KTtcbiAgICAgICAgfSwgbWlsbGlTZWNvbmRzKTtcbiAgICAgIH07XG4gICAgfTtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHdvcmtlciA9IG5ldyBFdmVudEVtaXR0ZXIoKTtcbiAgICAgIHdvcmtlci5hZGRFdmVudExpc3RlbmVyID0gd29ya2VyLmFkZExpc3RlbmVyO1xuICAgICAgd29ya2VyLnRlcm1pbmF0ZSA9ICgpID0+IDA7XG4gICAgICB3b3JrZXJSZXBseUluKDUpO1xuICAgICAgaGFja1dvcmtlciA9IG5ldyBIYWNrV29ya2VyKHt3b3JrZXIsIHdlYldvcmtlclRpbWVvdXQ6IDEwLCBwb29yUGVyZlRpbWVvdXQ6IDIwfSk7XG4gICAgfSk7XG5cbiAgICBhZnRlckVhY2goKCkgPT4ge1xuICAgICAgaGFja1dvcmtlci5kaXNwb3NlKCk7XG4gICAgfSk7XG5cbiAgICBpdCgncXVldWVzIGFuZCBwcm9jZXNzZXMgdHdvIHRhc2tzIGluIG9yZGVyJywgKCkgPT4ge1xuICAgICAgdmFyIHRhc2sxSGFuZGxlciA9IGphc21pbmUuY3JlYXRlU3B5KCk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MScpLnRoZW4odGFzazFIYW5kbGVyKTtcbiAgICAgIHZhciB0YXNrMkhhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgaGFja1dvcmtlci5ydW5Xb3JrZXJUYXNrKCdyZXBseTInKS50aGVuKHRhc2sySGFuZGxlcik7XG4gICAgICBleHBlY3QodGFzazFIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgwKTtcbiAgICAgIGV4cGVjdCh0YXNrMkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg2KTtcbiAgICAgIHdhaXRzKDEpO1xuICAgICAgcnVucygoKSA9PiB7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3QodGFzazFIYW5kbGVyLmFyZ3NGb3JDYWxsWzBdWzBdKS50b0JlKCdyZXBseTEnKTtcbiAgICAgICAgZXhwZWN0KHRhc2sySGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMCk7XG4gICAgICAgIHdpbmRvdy5hZHZhbmNlQ2xvY2soNik7XG4gICAgICB9KTtcbiAgICAgIHdhaXRzKDEpO1xuICAgICAgcnVucygoKSA9PiB7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KHRhc2sySGFuZGxlci5hcmdzRm9yQ2FsbFswXVswXSkudG9CZSgncmVwbHkyJyk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCd0YXNrIHRpbWVvdXQgd2FybmluZywgdGhlbiB0aGUgcmVzdWx0JywgKCkgPT4ge1xuICAgICAgdmFyIHdhcm5IYW5kbGVyID0gbG9nZ2VyLndhcm4gPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgd29ya2VyUmVwbHlJbigxNSk7XG4gICAgICB2YXIgdGFza0hhbmRsZXIgPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgaGFja1dvcmtlci5ydW5Xb3JrZXJUYXNrKCdyZXBseScpLnRoZW4odGFza0hhbmRsZXIpO1xuICAgICAgd2luZG93LmFkdmFuY2VDbG9jaygxMSk7XG4gICAgICB3YWl0cygxKTtcbiAgICAgIHJ1bnMoKCkgPT4ge1xuICAgICAgICBleHBlY3QodGFza0hhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ1dlYndvcmtlciBpcyBzdHVjayBpbiBhIGpvYiEnKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg1KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2tIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmNhbGxDb3VudCkudG9CZSgxKTtcbiAgICAgICAgZXhwZWN0KHRhc2tIYW5kbGVyLmFyZ3NGb3JDYWxsWzBdWzBdKS50b0JlKCdyZXBseScpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBpdCgndGFzayB0aW1lb3V0IGFuZCBwZXJmIHdhcm5pbmdzLCB0aGVuIHRoZSByZXN1bHQsIHRoZW4gYSBub3JtYWwgdGFzayB0aW1lJywgKCkgPT4ge1xuICAgICAgdmFyIHdhcm5IYW5kbGVyID0gbG9nZ2VyLndhcm4gPSBqYXNtaW5lLmNyZWF0ZVNweSgpO1xuICAgICAgdmFyIHRhc2sxSGFuZGxlciA9IGphc21pbmUuY3JlYXRlU3B5KCk7XG4gICAgICB2YXIgdGFzazJIYW5kbGVyID0gamFzbWluZS5jcmVhdGVTcHkoKTtcbiAgICAgIC8vIHNjaGVkdWxlIHRoZSBmaXJzdCB0YXNrIHdpdGggZXh0cmFvcmRpbmFyeSByZXNwb25zZSB0aW1lLlxuICAgICAgd29ya2VyUmVwbHlJbigyNSk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MScpLnRoZW4odGFzazFIYW5kbGVyKTtcbiAgICAgIC8vIHF1ZXVlIGFub3RoZXIgdGFzayB3aXRoIGEgbm9ybWFsIHRhc2sgdGltZS5cbiAgICAgIHdvcmtlclJlcGx5SW4oNSk7XG4gICAgICBoYWNrV29ya2VyLnJ1bldvcmtlclRhc2soJ3JlcGx5MicpLnRoZW4odGFzazJIYW5kbGVyKTtcbiAgICAgIHdpbmRvdy5hZHZhbmNlQ2xvY2soMTEpO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sxSGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMCk7XG4gICAgICAgIGV4cGVjdCh0YXNrMkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuY2FsbENvdW50KS50b0JlKDEpO1xuICAgICAgICBleHBlY3Qod2FybkhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ1dlYndvcmtlciBpcyBzdHVjayBpbiBhIGpvYiEnKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jaygxMSk7XG4gICAgICB9KTtcbiAgICAgIHdhaXRzKDEpO1xuICAgICAgcnVucygoKSA9PiB7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuY2FsbENvdW50KS50b0JlKDApO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgwKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmNhbGxDb3VudCkudG9CZSgyKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmFyZ3NGb3JDYWxsWzFdWzBdKS50b0JlKCdQb29yIFdlYndvcmtlciBQZXJmb3JtYW5jZSEnKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg0KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sxSGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdCh0YXNrMUhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ3JlcGx5MScpO1xuICAgICAgICBleHBlY3QodGFzazJIYW5kbGVyLmNhbGxDb3VudCkudG9CZSgwKTtcbiAgICAgICAgZXhwZWN0KHdhcm5IYW5kbGVyLmNhbGxDb3VudCkudG9CZSgyKTtcbiAgICAgICAgd2luZG93LmFkdmFuY2VDbG9jayg2KTtcbiAgICAgIH0pO1xuICAgICAgd2FpdHMoMSk7XG4gICAgICBydW5zKCgpID0+IHtcbiAgICAgICAgZXhwZWN0KHRhc2sySGFuZGxlci5jYWxsQ291bnQpLnRvQmUoMSk7XG4gICAgICAgIGV4cGVjdCh0YXNrMkhhbmRsZXIuYXJnc0ZvckNhbGxbMF1bMF0pLnRvQmUoJ3JlcGx5MicpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=