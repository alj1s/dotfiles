var path = require('path');
var fs = require('fs');
var fsu = require('../utils/fsUtil');
var _atom = require('atom');
var url = require('url');
function getEditorPosition(editor) {
    var bufferPos = editor.getCursorBufferPosition();
    return getEditorPositionForBufferPosition(editor, bufferPos);
}
exports.getEditorPosition = getEditorPosition;
function getEditorPositionForBufferPosition(editor, bufferPos) {
    var buffer = editor.getBuffer();
    return buffer.characterIndexForPosition(bufferPos);
}
exports.getEditorPositionForBufferPosition = getEditorPositionForBufferPosition;
function isAllowedExtension(ext) {
    return ext == '.ts' || ext == '.tst' || ext == '.tsx';
}
exports.isAllowedExtension = isAllowedExtension;
function onDiskAndTs(editor) {
    if (editor instanceof require('atom').TextEditor) {
        var filePath = editor.getPath();
        if (!filePath) {
            return false;
        }
        var ext = path.extname(filePath);
        if (isAllowedExtension(ext)) {
            if (fs.existsSync(filePath)) {
                return true;
            }
        }
    }
    return false;
}
exports.onDiskAndTs = onDiskAndTs;
function getFilePathPosition() {
    var editor = atom.workspace.getActiveTextEditor();
    var filePath = editor.getPath();
    var position = getEditorPosition(editor);
    return { filePath: filePath, position: position };
}
exports.getFilePathPosition = getFilePathPosition;
function getFilePath() {
    var editor = atom.workspace.getActiveTextEditor();
    var filePath = editor.getPath();
    return { filePath: filePath };
}
exports.getFilePath = getFilePath;
function getEditorsForAllPaths(filePaths) {
    var map = {};
    var activeEditors = atom.workspace.getTextEditors().filter(function (editor) {
        return !!editor.getPath();
    });
    function addConsistentlyToMap(editor) {
        map[fsu.consistentPath(editor.getPath())] = editor;
    }
    activeEditors.forEach(addConsistentlyToMap);
    var newPaths = filePaths.filter(function (p) {
        return !map[p];
    });
    if (!newPaths.length) return Promise.resolve(map);
    var promises = newPaths.map(function (p) {
        return atom.workspace.open(p, {});
    });
    return Promise.all(promises).then(function (editors) {
        editors.forEach(addConsistentlyToMap);
        return map;
    });
}
exports.getEditorsForAllPaths = getEditorsForAllPaths;
function getRangeForTextSpan(editor, ts) {
    var buffer = editor.buffer;
    var start = editor.buffer.positionForCharacterIndex(ts.start);
    var end = editor.buffer.positionForCharacterIndex(ts.start + ts.length);
    var range = new _atom.Range(start, end);
    return range;
}
exports.getRangeForTextSpan = getRangeForTextSpan;
function getTypeScriptEditorsWithPaths() {
    return atom.workspace.getTextEditors().filter(function (editor) {
        return !!editor.getPath();
    }).filter(function (editor) {
        return path.extname(editor.getPath()) === '.ts';
    });
}
exports.getTypeScriptEditorsWithPaths = getTypeScriptEditorsWithPaths;
function getOpenTypeScritEditorsConsistentPaths() {
    return getTypeScriptEditorsWithPaths().map(function (e) {
        return fsu.consistentPath(e.getPath());
    });
}
exports.getOpenTypeScritEditorsConsistentPaths = getOpenTypeScritEditorsConsistentPaths;
function quickNotifySuccess(htmlMessage) {
    var notification = atom.notifications.addSuccess(htmlMessage, { dismissable: true });
    setTimeout(function () {
        notification.dismiss();
    }, 800);
}
exports.quickNotifySuccess = quickNotifySuccess;
function quickNotifyWarning(htmlMessage) {
    var notification = atom.notifications.addWarning(htmlMessage, { dismissable: true });
    setTimeout(function () {
        notification.dismiss();
    }, 800);
}
exports.quickNotifyWarning = quickNotifyWarning;
function formatCode(editor, edits) {
    for (var i = edits.length - 1; i >= 0; i--) {
        var edit = edits[i];
        editor.setTextInBufferRange([[edit.start.line, edit.start.col], [edit.end.line, edit.end.col]], edit.newText);
    }
}
exports.formatCode = formatCode;
function kindToColor(kind) {
    switch (kind) {
        case 'interface':
            return 'rgb(16, 255, 0)';
        case 'keyword':
            return 'rgb(0, 207, 255)';
        case 'class':
            return 'rgb(255, 0, 194)';
        default:
            return 'white';
    }
}
exports.kindToColor = kindToColor;
function kindToType(kind) {
    switch (kind) {
        case 'interface':
            return 'type';
        case 'identifier':
            return 'variable';
        case 'local function':
            return 'function';
        case 'local var':
            return 'variable';
        case 'var':
        case 'parameter':
            return 'variable';
        case 'alias':
            return 'import';
        case 'type parameter':
            return 'type';
        default:
            return kind.split(' ')[0];
    }
}
exports.kindToType = kindToType;
function commandForTypeScript(e) {
    var editor = atom.workspace.getActiveTextEditor();
    if (!editor) return e.abortKeyBinding() && false;
    var ext = path.extname(editor.getPath());
    if (!isAllowedExtension(ext)) return e.abortKeyBinding() && false;
    return true;
}
exports.commandForTypeScript = commandForTypeScript;
function getCurrentPath() {
    var editor = atom.workspace.getActiveTextEditor();
    return fsu.consistentPath(editor.getPath());
}
exports.getCurrentPath = getCurrentPath;
exports.knownScopes = {
    reference: 'reference.path.string',
    require: 'require.path.string',
    es6import: 'es6import.path.string'
};
function editorInTheseScopes(matches) {
    var editor = atom.workspace.getActiveTextEditor();
    var scopes = editor.getLastCursor().getScopeDescriptor().scopes;
    var lastScope = scopes[scopes.length - 1];
    if (matches.some(function (p) {
        return lastScope === p;
    })) return lastScope;else return '';
}
exports.editorInTheseScopes = editorInTheseScopes;
function getActiveEditor() {
    return atom.workspace.getActiveTextEditor();
}
exports.getActiveEditor = getActiveEditor;
function uriForPath(uriProtocol, filePath) {
    return uriProtocol + '//' + filePath;
}
exports.uriForPath = uriForPath;
function registerOpener(config) {
    atom.commands.add(config.commandSelector, config.commandName, function (e) {
        if (!commandForTypeScript(e)) return;
        var uri = uriForPath(config.uriProtocol, getCurrentPath());
        var old_pane = atom.workspace.paneForURI(uri);
        if (old_pane) {
            old_pane.destroyItem(old_pane.itemForUri(uri));
        }
        atom.workspace.open(uri, config.getData());
    });
    atom.workspace.addOpener(function (uri, data) {
        try {
            var protocol = url.parse(uri).protocol;
        } catch (error) {
            return;
        }
        if (protocol !== config.uriProtocol) {
            return;
        }
        return config.onOpen(data);
    });
}
exports.registerOpener = registerOpener;
function triggerLinter() {
    atom.commands.dispatch(atom.views.getView(atom.workspace.getActiveTextEditor()), 'linter:lint');
}
exports.triggerLinter = triggerLinter;
var _snippetsManager;
function _setSnippetsManager(snippetsManager) {
    _snippetsManager = snippetsManager;
}
exports._setSnippetsManager = _setSnippetsManager;
function insertSnippet(snippet, editor, cursor) {
    if (_snippetsManager) {
        _snippetsManager.insertSnippet(snippet, editor, cursor);
    } else {
        console.error('Why no snippet manager?');
    }
}
exports.insertSnippet = insertSnippet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2F0b20vYXRvbVV0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUMzQixJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsSUFBSSxHQUFHLEdBQUcsT0FBTyxDQUFDLGlCQUFpQixDQUFDLENBQUM7QUFDckMsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQzVCLElBQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixTQUFTLGlCQUFpQixDQUFDLE1BQU0sRUFBRTtBQUMvQixRQUFJLFNBQVMsR0FBRyxNQUFNLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztBQUNqRCxXQUFPLGtDQUFrQyxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsQ0FBQztDQUNoRTtBQUNELE9BQU8sQ0FBQyxpQkFBaUIsR0FBRyxpQkFBaUIsQ0FBQztBQUM5QyxTQUFTLGtDQUFrQyxDQUFDLE1BQU0sRUFBRSxTQUFTLEVBQUU7QUFDM0QsUUFBSSxNQUFNLEdBQUcsTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDO0FBQ2hDLFdBQU8sTUFBTSxDQUFDLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQ3REO0FBQ0QsT0FBTyxDQUFDLGtDQUFrQyxHQUFHLGtDQUFrQyxDQUFDO0FBQ2hGLFNBQVMsa0JBQWtCLENBQUMsR0FBRyxFQUFFO0FBQzdCLFdBQVEsR0FBRyxJQUFJLEtBQUssSUFBSSxHQUFHLElBQUksTUFBTSxJQUFJLEdBQUcsSUFBSSxNQUFNLENBQUU7Q0FDM0Q7QUFDRCxPQUFPLENBQUMsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUM7QUFDaEQsU0FBUyxXQUFXLENBQUMsTUFBTSxFQUFFO0FBQ3pC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U0FDVjtBQUNELFlBQUksUUFBUSxLQUFLLE1BQU0sQ0FBQyxXQUFXLEVBQUU7QUFDakMsbUJBQU87U0FDVjtBQUNELGVBQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztLQUM5QixDQUFDLENBQUM7Q0FDTjtBQUNELE9BQU8sQ0FBQyxjQUFjLEdBQUcsY0FBYyxDQUFDO0FBQ3hDLFNBQVMsYUFBYSxHQUFHO0FBQ3JCLFFBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsbUJBQW1CLEVBQUUsQ0FBQyxFQUFFLGFBQWEsQ0FBQyxDQUFDO0NBQ25HO0FBQ0QsT0FBTyxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7QUFDdEMsSUFBSSxnQkFBZ0IsQ0FBQztBQUNyQixTQUFTLG1CQUFtQixDQUFDLGVBQWUsRUFBRTtBQUMxQyxvQkFBZ0IsR0FBRyxlQUFlLENBQUM7Q0FDdEM7QUFDRCxPQUFPLENBQUMsbUJBQW1CLEdBQUcsbUJBQW1CLENBQUM7QUFDbEQsU0FBUyxhQUFhLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7QUFDNUMsUUFBSSxnQkFBZ0IsRUFBRTtBQUNsQix3QkFBZ0IsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztLQUMzRCxNQUNJO0FBQ0QsZUFBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO0tBQzVDO0NBQ0o7QUFDRCxPQUFPLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyIsImZpbGUiOiIvVXNlcnMvYW5kcmV3am9uZXMvLmF0b20vcGFja2FnZXMvYXRvbS10eXBlc2NyaXB0L2Rpc3QvbWFpbi9hdG9tL2F0b21VdGlscy5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xudmFyIGZzID0gcmVxdWlyZSgnZnMnKTtcbnZhciBmc3UgPSByZXF1aXJlKFwiLi4vdXRpbHMvZnNVdGlsXCIpO1xudmFyIF9hdG9tID0gcmVxdWlyZSgnYXRvbScpO1xudmFyIHVybCA9IHJlcXVpcmUoJ3VybCcpO1xuZnVuY3Rpb24gZ2V0RWRpdG9yUG9zaXRpb24oZWRpdG9yKSB7XG4gICAgdmFyIGJ1ZmZlclBvcyA9IGVkaXRvci5nZXRDdXJzb3JCdWZmZXJQb3NpdGlvbigpO1xuICAgIHJldHVybiBnZXRFZGl0b3JQb3NpdGlvbkZvckJ1ZmZlclBvc2l0aW9uKGVkaXRvciwgYnVmZmVyUG9zKTtcbn1cbmV4cG9ydHMuZ2V0RWRpdG9yUG9zaXRpb24gPSBnZXRFZGl0b3JQb3NpdGlvbjtcbmZ1bmN0aW9uIGdldEVkaXRvclBvc2l0aW9uRm9yQnVmZmVyUG9zaXRpb24oZWRpdG9yLCBidWZmZXJQb3MpIHtcbiAgICB2YXIgYnVmZmVyID0gZWRpdG9yLmdldEJ1ZmZlcigpO1xuICAgIHJldHVybiBidWZmZXIuY2hhcmFjdGVySW5kZXhGb3JQb3NpdGlvbihidWZmZXJQb3MpO1xufVxuZXhwb3J0cy5nZXRFZGl0b3JQb3NpdGlvbkZvckJ1ZmZlclBvc2l0aW9uID0gZ2V0RWRpdG9yUG9zaXRpb25Gb3JCdWZmZXJQb3NpdGlvbjtcbmZ1bmN0aW9uIGlzQWxsb3dlZEV4dGVuc2lvbihleHQpIHtcbiAgICByZXR1cm4gKGV4dCA9PSAnLnRzJyB8fCBleHQgPT0gJy50c3QnIHx8IGV4dCA9PSAnLnRzeCcpO1xufVxuZXhwb3J0cy5pc0FsbG93ZWRFeHRlbnNpb24gPSBpc0FsbG93ZWRFeHRlbnNpb247XG5mdW5jdGlvbiBvbkRpc2tBbmRUcyhlZGl0b3IpIHtcbiAgICBpZiAoZWRpdG9yIGluc3RhbmNlb2YgcmVxdWlyZSgnYXRvbScpLlRleHRFZGl0b3IpIHtcbiAgICAgICAgdmFyIGZpbGVQYXRoID0gZWRpdG9yLmdldFBhdGgoKTtcbiAgICAgICAgaWYgKCFmaWxlUGF0aCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIHZhciBleHQgPSBwYXRoLmV4dG5hbWUoZmlsZVBhdGgpO1xuICAgICAgICBpZiAoaXNBbGxvd2VkRXh0ZW5zaW9uKGV4dCkpIHtcbiAgICAgICAgICAgIGlmIChmcy5leGlzdHNTeW5jKGZpbGVQYXRoKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiBmYWxzZTtcbn1cbmV4cG9ydHMub25EaXNrQW5kVHMgPSBvbkRpc2tBbmRUcztcbmZ1bmN0aW9uIGdldEZpbGVQYXRoUG9zaXRpb24oKSB7XG4gICAgdmFyIGVkaXRvciA9IGF0b20ud29ya3NwYWNlLmdldEFjdGl2ZVRleHRFZGl0b3IoKTtcbiAgICB2YXIgZmlsZVBhdGggPSBlZGl0b3IuZ2V0UGF0aCgpO1xuICAgIHZhciBwb3NpdGlvbiA9IGdldEVkaXRvclBvc2l0aW9uKGVkaXRvcik7XG4gICAgcmV0dXJuIHsgZmlsZVBhdGg6IGZpbGVQYXRoLCBwb3NpdGlvbjogcG9zaXRpb24gfTtcbn1cbmV4cG9ydHMuZ2V0RmlsZVBhdGhQb3NpdGlvbiA9IGdldEZpbGVQYXRoUG9zaXRpb247XG5mdW5jdGlvbiBnZXRGaWxlUGF0aCgpIHtcbiAgICB2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIHZhciBmaWxlUGF0aCA9IGVkaXRvci5nZXRQYXRoKCk7XG4gICAgcmV0dXJuIHsgZmlsZVBhdGg6IGZpbGVQYXRoIH07XG59XG5leHBvcnRzLmdldEZpbGVQYXRoID0gZ2V0RmlsZVBhdGg7XG5mdW5jdGlvbiBnZXRFZGl0b3JzRm9yQWxsUGF0aHMoZmlsZVBhdGhzKSB7XG4gICAgdmFyIG1hcCA9IHt9O1xuICAgIHZhciBhY3RpdmVFZGl0b3JzID0gYXRvbS53b3Jrc3BhY2UuZ2V0VGV4dEVkaXRvcnMoKS5maWx0ZXIoZnVuY3Rpb24gKGVkaXRvcikgeyByZXR1cm4gISFlZGl0b3IuZ2V0UGF0aCgpOyB9KTtcbiAgICBmdW5jdGlvbiBhZGRDb25zaXN0ZW50bHlUb01hcChlZGl0b3IpIHtcbiAgICAgICAgbWFwW2ZzdS5jb25zaXN0ZW50UGF0aChlZGl0b3IuZ2V0UGF0aCgpKV0gPSBlZGl0b3I7XG4gICAgfVxuICAgIGFjdGl2ZUVkaXRvcnMuZm9yRWFjaChhZGRDb25zaXN0ZW50bHlUb01hcCk7XG4gICAgdmFyIG5ld1BhdGhzID0gZmlsZVBhdGhzLmZpbHRlcihmdW5jdGlvbiAocCkgeyByZXR1cm4gIW1hcFtwXTsgfSk7XG4gICAgaWYgKCFuZXdQYXRocy5sZW5ndGgpXG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUobWFwKTtcbiAgICB2YXIgcHJvbWlzZXMgPSBuZXdQYXRocy5tYXAoZnVuY3Rpb24gKHApIHsgcmV0dXJuIGF0b20ud29ya3NwYWNlLm9wZW4ocCwge30pOyB9KTtcbiAgICByZXR1cm4gUHJvbWlzZS5hbGwocHJvbWlzZXMpLnRoZW4oZnVuY3Rpb24gKGVkaXRvcnMpIHtcbiAgICAgICAgZWRpdG9ycy5mb3JFYWNoKGFkZENvbnNpc3RlbnRseVRvTWFwKTtcbiAgICAgICAgcmV0dXJuIG1hcDtcbiAgICB9KTtcbn1cbmV4cG9ydHMuZ2V0RWRpdG9yc0ZvckFsbFBhdGhzID0gZ2V0RWRpdG9yc0ZvckFsbFBhdGhzO1xuZnVuY3Rpb24gZ2V0UmFuZ2VGb3JUZXh0U3BhbihlZGl0b3IsIHRzKSB7XG4gICAgdmFyIGJ1ZmZlciA9IGVkaXRvci5idWZmZXI7XG4gICAgdmFyIHN0YXJ0ID0gZWRpdG9yLmJ1ZmZlci5wb3NpdGlvbkZvckNoYXJhY3RlckluZGV4KHRzLnN0YXJ0KTtcbiAgICB2YXIgZW5kID0gZWRpdG9yLmJ1ZmZlci5wb3NpdGlvbkZvckNoYXJhY3RlckluZGV4KHRzLnN0YXJ0ICsgdHMubGVuZ3RoKTtcbiAgICB2YXIgcmFuZ2UgPSBuZXcgX2F0b20uUmFuZ2Uoc3RhcnQsIGVuZCk7XG4gICAgcmV0dXJuIHJhbmdlO1xufVxuZXhwb3J0cy5nZXRSYW5nZUZvclRleHRTcGFuID0gZ2V0UmFuZ2VGb3JUZXh0U3BhbjtcbmZ1bmN0aW9uIGdldFR5cGVTY3JpcHRFZGl0b3JzV2l0aFBhdGhzKCkge1xuICAgIHJldHVybiBhdG9tLndvcmtzcGFjZS5nZXRUZXh0RWRpdG9ycygpXG4gICAgICAgIC5maWx0ZXIoZnVuY3Rpb24gKGVkaXRvcikgeyByZXR1cm4gISFlZGl0b3IuZ2V0UGF0aCgpOyB9KVxuICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChlZGl0b3IpIHsgcmV0dXJuIChwYXRoLmV4dG5hbWUoZWRpdG9yLmdldFBhdGgoKSkgPT09ICcudHMnKTsgfSk7XG59XG5leHBvcnRzLmdldFR5cGVTY3JpcHRFZGl0b3JzV2l0aFBhdGhzID0gZ2V0VHlwZVNjcmlwdEVkaXRvcnNXaXRoUGF0aHM7XG5mdW5jdGlvbiBnZXRPcGVuVHlwZVNjcml0RWRpdG9yc0NvbnNpc3RlbnRQYXRocygpIHtcbiAgICByZXR1cm4gZ2V0VHlwZVNjcmlwdEVkaXRvcnNXaXRoUGF0aHMoKS5tYXAoZnVuY3Rpb24gKGUpIHsgcmV0dXJuIGZzdS5jb25zaXN0ZW50UGF0aChlLmdldFBhdGgoKSk7IH0pO1xufVxuZXhwb3J0cy5nZXRPcGVuVHlwZVNjcml0RWRpdG9yc0NvbnNpc3RlbnRQYXRocyA9IGdldE9wZW5UeXBlU2NyaXRFZGl0b3JzQ29uc2lzdGVudFBhdGhzO1xuZnVuY3Rpb24gcXVpY2tOb3RpZnlTdWNjZXNzKGh0bWxNZXNzYWdlKSB7XG4gICAgdmFyIG5vdGlmaWNhdGlvbiA9IGF0b20ubm90aWZpY2F0aW9ucy5hZGRTdWNjZXNzKGh0bWxNZXNzYWdlLCB7IGRpc21pc3NhYmxlOiB0cnVlIH0pO1xuICAgIHNldFRpbWVvdXQoZnVuY3Rpb24gKCkge1xuICAgICAgICBub3RpZmljYXRpb24uZGlzbWlzcygpO1xuICAgIH0sIDgwMCk7XG59XG5leHBvcnRzLnF1aWNrTm90aWZ5U3VjY2VzcyA9IHF1aWNrTm90aWZ5U3VjY2VzcztcbmZ1bmN0aW9uIHF1aWNrTm90aWZ5V2FybmluZyhodG1sTWVzc2FnZSkge1xuICAgIHZhciBub3RpZmljYXRpb24gPSBhdG9tLm5vdGlmaWNhdGlvbnMuYWRkV2FybmluZyhodG1sTWVzc2FnZSwgeyBkaXNtaXNzYWJsZTogdHJ1ZSB9KTtcbiAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgICAgbm90aWZpY2F0aW9uLmRpc21pc3MoKTtcbiAgICB9LCA4MDApO1xufVxuZXhwb3J0cy5xdWlja05vdGlmeVdhcm5pbmcgPSBxdWlja05vdGlmeVdhcm5pbmc7XG5mdW5jdGlvbiBmb3JtYXRDb2RlKGVkaXRvciwgZWRpdHMpIHtcbiAgICBmb3IgKHZhciBpID0gZWRpdHMubGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pIHtcbiAgICAgICAgdmFyIGVkaXQgPSBlZGl0c1tpXTtcbiAgICAgICAgZWRpdG9yLnNldFRleHRJbkJ1ZmZlclJhbmdlKFtbZWRpdC5zdGFydC5saW5lLCBlZGl0LnN0YXJ0LmNvbF0sIFtlZGl0LmVuZC5saW5lLCBlZGl0LmVuZC5jb2xdXSwgZWRpdC5uZXdUZXh0KTtcbiAgICB9XG59XG5leHBvcnRzLmZvcm1hdENvZGUgPSBmb3JtYXRDb2RlO1xuZnVuY3Rpb24ga2luZFRvQ29sb3Ioa2luZCkge1xuICAgIHN3aXRjaCAoa2luZCkge1xuICAgICAgICBjYXNlICdpbnRlcmZhY2UnOlxuICAgICAgICAgICAgcmV0dXJuICdyZ2IoMTYsIDI1NSwgMCknO1xuICAgICAgICBjYXNlICdrZXl3b3JkJzpcbiAgICAgICAgICAgIHJldHVybiAncmdiKDAsIDIwNywgMjU1KSc7XG4gICAgICAgIGNhc2UgJ2NsYXNzJzpcbiAgICAgICAgICAgIHJldHVybiAncmdiKDI1NSwgMCwgMTk0KSc7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICByZXR1cm4gJ3doaXRlJztcbiAgICB9XG59XG5leHBvcnRzLmtpbmRUb0NvbG9yID0ga2luZFRvQ29sb3I7XG5mdW5jdGlvbiBraW5kVG9UeXBlKGtpbmQpIHtcbiAgICBzd2l0Y2ggKGtpbmQpIHtcbiAgICAgICAgY2FzZSAnaW50ZXJmYWNlJzpcbiAgICAgICAgICAgIHJldHVybiAndHlwZSc7XG4gICAgICAgIGNhc2UgJ2lkZW50aWZpZXInOlxuICAgICAgICAgICAgcmV0dXJuICd2YXJpYWJsZSc7XG4gICAgICAgIGNhc2UgJ2xvY2FsIGZ1bmN0aW9uJzpcbiAgICAgICAgICAgIHJldHVybiAnZnVuY3Rpb24nO1xuICAgICAgICBjYXNlICdsb2NhbCB2YXInOlxuICAgICAgICAgICAgcmV0dXJuICd2YXJpYWJsZSc7XG4gICAgICAgIGNhc2UgJ3Zhcic6XG4gICAgICAgIGNhc2UgJ3BhcmFtZXRlcic6XG4gICAgICAgICAgICByZXR1cm4gJ3ZhcmlhYmxlJztcbiAgICAgICAgY2FzZSAnYWxpYXMnOlxuICAgICAgICAgICAgcmV0dXJuICdpbXBvcnQnO1xuICAgICAgICBjYXNlICd0eXBlIHBhcmFtZXRlcic6XG4gICAgICAgICAgICByZXR1cm4gJ3R5cGUnO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgcmV0dXJuIGtpbmQuc3BsaXQoJyAnKVswXTtcbiAgICB9XG59XG5leHBvcnRzLmtpbmRUb1R5cGUgPSBraW5kVG9UeXBlO1xuZnVuY3Rpb24gY29tbWFuZEZvclR5cGVTY3JpcHQoZSkge1xuICAgIHZhciBlZGl0b3IgPSBhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCk7XG4gICAgaWYgKCFlZGl0b3IpXG4gICAgICAgIHJldHVybiBlLmFib3J0S2V5QmluZGluZygpICYmIGZhbHNlO1xuICAgIHZhciBleHQgPSBwYXRoLmV4dG5hbWUoZWRpdG9yLmdldFBhdGgoKSk7XG4gICAgaWYgKCFpc0FsbG93ZWRFeHRlbnNpb24oZXh0KSlcbiAgICAgICAgcmV0dXJuIGUuYWJvcnRLZXlCaW5kaW5nKCkgJiYgZmFsc2U7XG4gICAgcmV0dXJuIHRydWU7XG59XG5leHBvcnRzLmNvbW1hbmRGb3JUeXBlU2NyaXB0ID0gY29tbWFuZEZvclR5cGVTY3JpcHQ7XG5mdW5jdGlvbiBnZXRDdXJyZW50UGF0aCgpIHtcbiAgICB2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIHJldHVybiBmc3UuY29uc2lzdGVudFBhdGgoZWRpdG9yLmdldFBhdGgoKSk7XG59XG5leHBvcnRzLmdldEN1cnJlbnRQYXRoID0gZ2V0Q3VycmVudFBhdGg7XG5leHBvcnRzLmtub3duU2NvcGVzID0ge1xuICAgIHJlZmVyZW5jZTogJ3JlZmVyZW5jZS5wYXRoLnN0cmluZycsXG4gICAgcmVxdWlyZTogJ3JlcXVpcmUucGF0aC5zdHJpbmcnLFxuICAgIGVzNmltcG9ydDogJ2VzNmltcG9ydC5wYXRoLnN0cmluZydcbn07XG5mdW5jdGlvbiBlZGl0b3JJblRoZXNlU2NvcGVzKG1hdGNoZXMpIHtcbiAgICB2YXIgZWRpdG9yID0gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xuICAgIHZhciBzY29wZXMgPSBlZGl0b3IuZ2V0TGFzdEN1cnNvcigpLmdldFNjb3BlRGVzY3JpcHRvcigpLnNjb3BlcztcbiAgICB2YXIgbGFzdFNjb3BlID0gc2NvcGVzW3Njb3Blcy5sZW5ndGggLSAxXTtcbiAgICBpZiAobWF0Y2hlcy5zb21lKGZ1bmN0aW9uIChwKSB7IHJldHVybiBsYXN0U2NvcGUgPT09IHA7IH0pKVxuICAgICAgICByZXR1cm4gbGFzdFNjb3BlO1xuICAgIGVsc2VcbiAgICAgICAgcmV0dXJuICcnO1xufVxuZXhwb3J0cy5lZGl0b3JJblRoZXNlU2NvcGVzID0gZWRpdG9ySW5UaGVzZVNjb3BlcztcbmZ1bmN0aW9uIGdldEFjdGl2ZUVkaXRvcigpIHtcbiAgICByZXR1cm4gYXRvbS53b3Jrc3BhY2UuZ2V0QWN0aXZlVGV4dEVkaXRvcigpO1xufVxuZXhwb3J0cy5nZXRBY3RpdmVFZGl0b3IgPSBnZXRBY3RpdmVFZGl0b3I7XG5mdW5jdGlvbiB1cmlGb3JQYXRoKHVyaVByb3RvY29sLCBmaWxlUGF0aCkge1xuICAgIHJldHVybiB1cmlQcm90b2NvbCArIFwiLy9cIiArIGZpbGVQYXRoO1xufVxuZXhwb3J0cy51cmlGb3JQYXRoID0gdXJpRm9yUGF0aDtcbmZ1bmN0aW9uIHJlZ2lzdGVyT3BlbmVyKGNvbmZpZykge1xuICAgIGF0b20uY29tbWFuZHMuYWRkKGNvbmZpZy5jb21tYW5kU2VsZWN0b3IsIGNvbmZpZy5jb21tYW5kTmFtZSwgZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgaWYgKCFjb21tYW5kRm9yVHlwZVNjcmlwdChlKSlcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgdmFyIHVyaSA9IHVyaUZvclBhdGgoY29uZmlnLnVyaVByb3RvY29sLCBnZXRDdXJyZW50UGF0aCgpKTtcbiAgICAgICAgdmFyIG9sZF9wYW5lID0gYXRvbS53b3Jrc3BhY2UucGFuZUZvclVSSSh1cmkpO1xuICAgICAgICBpZiAob2xkX3BhbmUpIHtcbiAgICAgICAgICAgIG9sZF9wYW5lLmRlc3Ryb3lJdGVtKG9sZF9wYW5lLml0ZW1Gb3JVcmkodXJpKSk7XG4gICAgICAgIH1cbiAgICAgICAgYXRvbS53b3Jrc3BhY2Uub3Blbih1cmksIGNvbmZpZy5nZXREYXRhKCkpO1xuICAgIH0pO1xuICAgIGF0b20ud29ya3NwYWNlLmFkZE9wZW5lcihmdW5jdGlvbiAodXJpLCBkYXRhKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB2YXIgcHJvdG9jb2wgPSB1cmwucGFyc2UodXJpKS5wcm90b2NvbDtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAocHJvdG9jb2wgIT09IGNvbmZpZy51cmlQcm90b2NvbCkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb25maWcub25PcGVuKGRhdGEpO1xuICAgIH0pO1xufVxuZXhwb3J0cy5yZWdpc3Rlck9wZW5lciA9IHJlZ2lzdGVyT3BlbmVyO1xuZnVuY3Rpb24gdHJpZ2dlckxpbnRlcigpIHtcbiAgICBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkpLCAnbGludGVyOmxpbnQnKTtcbn1cbmV4cG9ydHMudHJpZ2dlckxpbnRlciA9IHRyaWdnZXJMaW50ZXI7XG52YXIgX3NuaXBwZXRzTWFuYWdlcjtcbmZ1bmN0aW9uIF9zZXRTbmlwcGV0c01hbmFnZXIoc25pcHBldHNNYW5hZ2VyKSB7XG4gICAgX3NuaXBwZXRzTWFuYWdlciA9IHNuaXBwZXRzTWFuYWdlcjtcbn1cbmV4cG9ydHMuX3NldFNuaXBwZXRzTWFuYWdlciA9IF9zZXRTbmlwcGV0c01hbmFnZXI7XG5mdW5jdGlvbiBpbnNlcnRTbmlwcGV0KHNuaXBwZXQsIGVkaXRvciwgY3Vyc29yKSB7XG4gICAgaWYgKF9zbmlwcGV0c01hbmFnZXIpIHtcbiAgICAgICAgX3NuaXBwZXRzTWFuYWdlci5pbnNlcnRTbmlwcGV0KHNuaXBwZXQsIGVkaXRvciwgY3Vyc29yKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ1doeSBubyBzbmlwcGV0IG1hbmFnZXI/Jyk7XG4gICAgfVxufVxuZXhwb3J0cy5pbnNlcnRTbmlwcGV0ID0gaW5zZXJ0U25pcHBldDtcbiJdfQ==