'use babel';
/* @flow */

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

var url = require('url');
var request = require('request');
var MAX_REQUEST_LENGTH = 1e6;

/**
 * Promisified version of the request function:
 * https://www.npmjs.com/package/request#requestoptions-callback
 * Defaults to using the node's querystring module to encode the url query parameters.
 * If you want to use the npm's qs module to encode the query parameters, explicitly provide the option:
 * {useQuerystring: false}
 */
function asyncRequest(options) {
  return new Promise(function (resolve, reject) {
    if (options.useQuerystring === undefined) {
      options.useQuerystring = true;
    }
    request(options, function (error, response, body) {
      if (error) {
        reject(error);
      } else if (response.statusCode < 200 || response.statusCode >= 300) {
        var errorJson = body;
        if (typeof body !== 'object') {
          try {
            errorJson = JSON.parse(body);
          } catch (err) {
            // 404 responses aren't currently JSON.
            errorJson = { message: body };
          }
        }
        var err = new Error(errorJson.message);
        // Success http status codes range from 200 to 299.
        err.code = errorJson.code || response.statusCode;
        reject(err);
      } else {
        resolve({ body: body, response: response });
      }
    });
  });
}

/**
 * Write a text or convert to text response with an optional status code.
 */
function sendTextResponse(response, text, statusCode) {
  if (typeof statusCode === 'number') {
    response.statusCode = statusCode;
  }
  response.write(text || '');
  response.end();
}

/**
 * Write a json response text with an optional status code.
 */
function sendJsonResponse(response, json, statusCode) {
  response.setHeader('Content-Type', 'application/json');
  sendTextResponse(response, JSON.stringify(json), statusCode);
}

/**
  * Parses the request body in an anyc/promise way
  */
function parseRequestBody(httpRequest, isJson) {
  return new Promise(function (resolve, reject) {
    var body = '';
    httpRequest.on('data', function (data) {
      body += data;
      // too much POST data, kill the connection!
      if (body.length > MAX_REQUEST_LENGTH) {
        reject(new Error('body is too big'));
        httpRequest.connection.destroy();
      }
    });
    httpRequest.on('end', function () {
      return resolve(isJson ? JSON.parse(body) : body);
    });
  });
}

/**
 * Parses the url parameters ?abc=erf&lol=432c
 */
function getQueryParameters(requestUrl) {
  var _url$parse = url.parse(requestUrl, true);

  var query = _url$parse.query;

  return query;
}

/**
 * Serializes the method arguments to args and argTypes arrays
 * to send the metadata about the argument types with the data
 * to help the server understand and parse it.
 */
function serializeArgs(args) {
  var argsOnHttp = [];
  var argTypes = [];
  args.forEach(function (arg) {
    // I do this because nulls are normally sent as empty strings
    if (arg === undefined) {
      argsOnHttp.push('');
      argTypes.push('undefined');
    } else if (typeof arg === 'string') {
      argsOnHttp.push(arg);
      argTypes.push('string');
    } else {
      // object, number, boolean null
      argsOnHttp.push(JSON.stringify(arg));
      argTypes.push('object');
    }
  });
  return {
    args: argsOnHttp,
    argTypes: argTypes
  };
}

/**
 * Deserializes a url with query parameters: args, argTypes to an array
 * of the original arguments of the same types the client called the function with.
 */
function deserializeArgs(requestUrl) {
  var _getQueryParameters = getQueryParameters(requestUrl);

  var args = _getQueryParameters.args;
  var argTypes = _getQueryParameters.argTypes;

  args = args || [];
  argTypes = argTypes || [];
  var argsArray = Array.isArray(args) ? args : [args];
  var argTypesArray = Array.isArray(argTypes) ? argTypes : [argTypes];
  return argsArray.map(function (arg, i) {
    // I do this because nulls are normally sent as empty strings.
    if (argTypesArray[i] === 'undefined') {
      return undefined;
    } else if (argTypesArray[i] === 'string') {
      return arg;
    } else {
      // some methods have options object arguments.
      return JSON.parse(arg);
    }
  });
}

module.exports = {
  asyncRequest: asyncRequest,
  deserializeArgs: deserializeArgs,
  getQueryParameters: getQueryParameters,
  parseRequestBody: parseRequestBody,
  sendJsonResponse: sendJsonResponse,
  sendTextResponse: sendTextResponse,
  serializeArgs: serializeArgs
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9udWNsaWRlLXJlbW90ZS1wcm9qZWN0cy9ub2RlX21vZHVsZXMvbnVjbGlkZS1yZW1vdGUtY29ubmVjdGlvbi9ub2RlX21vZHVsZXMvbnVjbGlkZS1zZXJ2ZXIvbGliL3V0aWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFdBQVcsQ0FBQzs7Ozs7Ozs7Ozs7QUFXWixJQUFJLEdBQUcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7QUFDekIsSUFBSSxPQUFPLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2pDLElBQU0sa0JBQWtCLEdBQUcsR0FBRyxDQUFDOzs7Ozs7Ozs7QUFhL0IsU0FBUyxZQUFZLENBQUMsT0FBWSxFQUF5QjtBQUN6RCxTQUFPLElBQUksT0FBTyxDQUFDLFVBQUMsT0FBTyxFQUFFLE1BQU0sRUFBSztBQUN0QyxRQUFJLE9BQU8sQ0FBQyxjQUFjLEtBQUssU0FBUyxFQUFFO0FBQ3hDLGFBQU8sQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO0tBQy9CO0FBQ0QsV0FBTyxDQUFDLE9BQU8sRUFBRSxVQUFDLEtBQUssRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFLO0FBQzFDLFVBQUksS0FBSyxFQUFFO0FBQ1QsY0FBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO09BQ2YsTUFBTSxJQUFJLFFBQVEsQ0FBQyxVQUFVLEdBQUcsR0FBRyxJQUFJLFFBQVEsQ0FBQyxVQUFVLElBQUksR0FBRyxFQUFFO0FBQ2xFLFlBQUksU0FBUyxHQUFHLElBQUksQ0FBQztBQUNyQixZQUFJLE9BQU8sSUFBSSxLQUFLLFFBQVEsRUFBRTtBQUM1QixjQUFJO0FBQ0YscUJBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1dBQzlCLENBQUMsT0FBTyxHQUFHLEVBQUU7O0FBRVoscUJBQVMsR0FBRyxFQUFDLE9BQU8sRUFBRSxJQUFJLEVBQUMsQ0FBQztXQUM3QjtTQUNGO0FBQ0QsWUFBSSxHQUFHLEdBQUcsSUFBSSxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDOztBQUV2QyxXQUFHLENBQUMsSUFBSSxHQUFHLFNBQVMsQ0FBQyxJQUFJLElBQUksUUFBUSxDQUFDLFVBQVUsQ0FBQztBQUNqRCxjQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7T0FDYixNQUFNO0FBQ0wsZUFBTyxDQUFDLEVBQUMsSUFBSSxFQUFKLElBQUksRUFBRSxRQUFRLEVBQVIsUUFBUSxFQUFDLENBQUMsQ0FBQztPQUMzQjtLQUNGLENBQUMsQ0FBQztHQUNKLENBQUMsQ0FBQztDQUNKOzs7OztBQUtELFNBQVMsZ0JBQWdCLENBQUMsUUFBNkIsRUFBRSxJQUFTLEVBQUUsVUFBbUIsRUFBUTtBQUM3RixNQUFJLE9BQU8sVUFBVSxLQUFLLFFBQVEsRUFBRTtBQUNsQyxZQUFRLENBQUMsVUFBVSxHQUFHLFVBQVUsQ0FBQztHQUNsQztBQUNELFVBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0FBQzNCLFVBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztDQUNoQjs7Ozs7QUFLRCxTQUFTLGdCQUFnQixDQUFDLFFBQTZCLEVBQUUsSUFBUyxFQUFFLFVBQW1CLEVBQVE7QUFDN0YsVUFBUSxDQUFDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsa0JBQWtCLENBQUMsQ0FBQztBQUN2RCxrQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxVQUFVLENBQUMsQ0FBQztDQUM5RDs7Ozs7QUFLRCxTQUFTLGdCQUFnQixDQUFDLFdBQWlDLEVBQUUsTUFBZ0IsRUFBbUI7QUFDOUYsU0FBTyxJQUFJLE9BQU8sQ0FBQyxVQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUs7QUFDdEMsUUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO0FBQ2QsZUFBVyxDQUFDLEVBQUUsQ0FBQyxNQUFNLEVBQUUsVUFBQyxJQUFJLEVBQUs7QUFDL0IsVUFBSSxJQUFJLElBQUksQ0FBQzs7QUFFYixVQUFJLElBQUksQ0FBQyxNQUFNLEdBQUcsa0JBQWtCLEVBQUU7QUFDcEMsY0FBTSxDQUFDLElBQUksS0FBSyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQztBQUNyQyxtQkFBVyxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztPQUNsQztLQUNGLENBQUMsQ0FBQztBQUNILGVBQVcsQ0FBQyxFQUFFLENBQUMsS0FBSyxFQUFFO2FBQU0sT0FBTyxDQUFDLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQztLQUFBLENBQUMsQ0FBQztHQUN4RSxDQUFDLENBQUM7Q0FDSjs7Ozs7QUFLRCxTQUFTLGtCQUFrQixDQUFDLFVBQVUsRUFBZTttQkFDckMsR0FBRyxDQUFDLEtBQUssQ0FBQyxVQUFVLEVBQUUsSUFBSSxDQUFDOztNQUFwQyxLQUFLLGNBQUwsS0FBSzs7QUFDVixTQUFPLEtBQUssQ0FBQztDQUNkOzs7Ozs7O0FBT0QsU0FBUyxhQUFhLENBQUMsSUFBZ0IsRUFBdUI7QUFDNUQsTUFBSSxVQUFVLEdBQUcsRUFBRSxDQUFDO0FBQ3BCLE1BQUksUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNsQixNQUFJLENBQUMsT0FBTyxDQUFDLFVBQVMsR0FBRyxFQUFFOztBQUV6QixRQUFJLEdBQUcsS0FBSyxTQUFTLEVBQUU7QUFDckIsZ0JBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDcEIsY0FBUSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQztLQUM1QixNQUFNLElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxFQUFFO0FBQ2xDLGdCQUFVLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3JCLGNBQVEsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7S0FDekIsTUFBTTs7QUFDTCxnQkFBVSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDckMsY0FBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUN6QjtHQUNGLENBQUMsQ0FBQztBQUNILFNBQU87QUFDTCxRQUFJLEVBQUUsVUFBVTtBQUNoQixZQUFRLEVBQVIsUUFBUTtHQUNULENBQUM7Q0FDSDs7Ozs7O0FBTUQsU0FBUyxlQUFlLENBQUMsVUFBa0IsRUFBYzs0QkFDaEMsa0JBQWtCLENBQUMsVUFBVSxDQUFDOztNQUFoRCxJQUFJLHVCQUFKLElBQUk7TUFBRSxRQUFRLHVCQUFSLFFBQVE7O0FBQ25CLE1BQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0FBQ2xCLFVBQVEsR0FBRyxRQUFRLElBQUksRUFBRSxDQUFDO0FBQzFCLE1BQUksU0FBUyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxHQUFHLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDcEQsTUFBSSxhQUFhLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxRQUFRLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUNwRSxTQUFPLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBUyxHQUFHLEVBQUUsQ0FBQyxFQUFFOztBQUVwQyxRQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxXQUFXLEVBQUU7QUFDcEMsYUFBTyxTQUFTLENBQUM7S0FDbEIsTUFBTSxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLEVBQUU7QUFDeEMsYUFBTyxHQUFHLENBQUM7S0FDWixNQUFNOztBQUVMLGFBQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztLQUN4QjtHQUNGLENBQUMsQ0FBQztDQUNKOztBQUVELE1BQU0sQ0FBQyxPQUFPLEdBQUc7QUFDZixjQUFZLEVBQVosWUFBWTtBQUNaLGlCQUFlLEVBQWYsZUFBZTtBQUNmLG9CQUFrQixFQUFsQixrQkFBa0I7QUFDbEIsa0JBQWdCLEVBQWhCLGdCQUFnQjtBQUNoQixrQkFBZ0IsRUFBaEIsZ0JBQWdCO0FBQ2hCLGtCQUFnQixFQUFoQixnQkFBZ0I7QUFDaEIsZUFBYSxFQUFiLGFBQWE7Q0FDZCxDQUFDIiwiZmlsZSI6Ii9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9udWNsaWRlLXJlbW90ZS1wcm9qZWN0cy9ub2RlX21vZHVsZXMvbnVjbGlkZS1yZW1vdGUtY29ubmVjdGlvbi9ub2RlX21vZHVsZXMvbnVjbGlkZS1zZXJ2ZXIvbGliL3V0aWxzLmpzIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBiYWJlbCc7XG4vKiBAZmxvdyAqL1xuXG4vKlxuICogQ29weXJpZ2h0IChjKSAyMDE1LXByZXNlbnQsIEZhY2Vib29rLCBJbmMuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIGxpY2Vuc2UgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBpblxuICogdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKi9cblxudmFyIHVybCA9IHJlcXVpcmUoJ3VybCcpO1xudmFyIHJlcXVlc3QgPSByZXF1aXJlKCdyZXF1ZXN0Jyk7XG5jb25zdCBNQVhfUkVRVUVTVF9MRU5HVEggPSAxZTY7XG5cbnR5cGUgUmVzcG9uc2VCb2R5ID0ge2JvZHk6IHN0cmluZzsgcmVzcG9uc2U6IEh0dHBSZXNwb25zZX07XG50eXBlIFF1ZXJ5UGFyYW1zID0ge1trZXk6c3RyaW5nXTogYW55fTtcbnR5cGUgU2VyaWFsaXplZEFyZ3VtZW50cyA9IHthcmdzOiBBcnJheTxzdHJpbmc+OyBhcmdUeXBlczogQXJyYXk8c3RyaW5nPn07XG5cbi8qKlxuICogUHJvbWlzaWZpZWQgdmVyc2lvbiBvZiB0aGUgcmVxdWVzdCBmdW5jdGlvbjpcbiAqIGh0dHBzOi8vd3d3Lm5wbWpzLmNvbS9wYWNrYWdlL3JlcXVlc3QjcmVxdWVzdG9wdGlvbnMtY2FsbGJhY2tcbiAqIERlZmF1bHRzIHRvIHVzaW5nIHRoZSBub2RlJ3MgcXVlcnlzdHJpbmcgbW9kdWxlIHRvIGVuY29kZSB0aGUgdXJsIHF1ZXJ5IHBhcmFtZXRlcnMuXG4gKiBJZiB5b3Ugd2FudCB0byB1c2UgdGhlIG5wbSdzIHFzIG1vZHVsZSB0byBlbmNvZGUgdGhlIHF1ZXJ5IHBhcmFtZXRlcnMsIGV4cGxpY2l0bHkgcHJvdmlkZSB0aGUgb3B0aW9uOlxuICoge3VzZVF1ZXJ5c3RyaW5nOiBmYWxzZX1cbiAqL1xuZnVuY3Rpb24gYXN5bmNSZXF1ZXN0KG9wdGlvbnM6IGFueSk6IFByb21pc2U8UmVzcG9uc2VCb2R5PiB7XG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgaWYgKG9wdGlvbnMudXNlUXVlcnlzdHJpbmcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgb3B0aW9ucy51c2VRdWVyeXN0cmluZyA9IHRydWU7XG4gICAgfVxuICAgIHJlcXVlc3Qob3B0aW9ucywgKGVycm9yLCByZXNwb25zZSwgYm9keSkgPT4ge1xuICAgICAgaWYgKGVycm9yKSB7XG4gICAgICAgIHJlamVjdChlcnJvcik7XG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPCAyMDAgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZSA+PSAzMDApIHtcbiAgICAgICAgdmFyIGVycm9ySnNvbiA9IGJvZHk7XG4gICAgICAgIGlmICh0eXBlb2YgYm9keSAhPT0gJ29iamVjdCcpIHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgZXJyb3JKc29uID0gSlNPTi5wYXJzZShib2R5KTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIC8vIDQwNCByZXNwb25zZXMgYXJlbid0IGN1cnJlbnRseSBKU09OLlxuICAgICAgICAgICAgZXJyb3JKc29uID0ge21lc3NhZ2U6IGJvZHl9O1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB2YXIgZXJyID0gbmV3IEVycm9yKGVycm9ySnNvbi5tZXNzYWdlKTtcbiAgICAgICAgLy8gU3VjY2VzcyBodHRwIHN0YXR1cyBjb2RlcyByYW5nZSBmcm9tIDIwMCB0byAyOTkuXG4gICAgICAgIGVyci5jb2RlID0gZXJyb3JKc29uLmNvZGUgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZTtcbiAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXNvbHZlKHtib2R5LCByZXNwb25zZX0pO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuLyoqXG4gKiBXcml0ZSBhIHRleHQgb3IgY29udmVydCB0byB0ZXh0IHJlc3BvbnNlIHdpdGggYW4gb3B0aW9uYWwgc3RhdHVzIGNvZGUuXG4gKi9cbmZ1bmN0aW9uIHNlbmRUZXh0UmVzcG9uc2UocmVzcG9uc2U6IGh0dHAuU2VydmVyUmVzcG9uc2UsIHRleHQ6IGFueSwgc3RhdHVzQ29kZTogP251bWJlcik6IHZvaWQge1xuICBpZiAodHlwZW9mIHN0YXR1c0NvZGUgPT09ICdudW1iZXInKSB7XG4gICAgcmVzcG9uc2Uuc3RhdHVzQ29kZSA9IHN0YXR1c0NvZGU7XG4gIH1cbiAgcmVzcG9uc2Uud3JpdGUodGV4dCB8fCAnJyk7XG4gIHJlc3BvbnNlLmVuZCgpO1xufVxuXG4vKipcbiAqIFdyaXRlIGEganNvbiByZXNwb25zZSB0ZXh0IHdpdGggYW4gb3B0aW9uYWwgc3RhdHVzIGNvZGUuXG4gKi9cbmZ1bmN0aW9uIHNlbmRKc29uUmVzcG9uc2UocmVzcG9uc2U6IGh0dHAuU2VydmVyUmVzcG9uc2UsIGpzb246IGFueSwgc3RhdHVzQ29kZTogP251bWJlcik6IHZvaWQge1xuICByZXNwb25zZS5zZXRIZWFkZXIoJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gIHNlbmRUZXh0UmVzcG9uc2UocmVzcG9uc2UsIEpTT04uc3RyaW5naWZ5KGpzb24pLCBzdGF0dXNDb2RlKTtcbn1cblxuLyoqXG4gICogUGFyc2VzIHRoZSByZXF1ZXN0IGJvZHkgaW4gYW4gYW55Yy9wcm9taXNlIHdheVxuICAqL1xuZnVuY3Rpb24gcGFyc2VSZXF1ZXN0Qm9keShodHRwUmVxdWVzdDogaHR0cC5JbmNvbWluZ01lc3NhZ2UsIGlzSnNvbjogP2Jvb2xlYW4pOiBQcm9taXNlPHN0cmluZz4ge1xuICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIHZhciBib2R5ID0gJyc7XG4gICAgaHR0cFJlcXVlc3Qub24oJ2RhdGEnLCAoZGF0YSkgPT4ge1xuICAgICAgYm9keSArPSBkYXRhO1xuICAgICAgLy8gdG9vIG11Y2ggUE9TVCBkYXRhLCBraWxsIHRoZSBjb25uZWN0aW9uIVxuICAgICAgaWYgKGJvZHkubGVuZ3RoID4gTUFYX1JFUVVFU1RfTEVOR1RIKSB7XG4gICAgICAgIHJlamVjdChuZXcgRXJyb3IoJ2JvZHkgaXMgdG9vIGJpZycpKTtcbiAgICAgICAgaHR0cFJlcXVlc3QuY29ubmVjdGlvbi5kZXN0cm95KCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgaHR0cFJlcXVlc3Qub24oJ2VuZCcsICgpID0+IHJlc29sdmUoaXNKc29uID8gSlNPTi5wYXJzZShib2R5KSA6IGJvZHkpKTtcbiAgfSk7XG59XG5cbi8qKlxuICogUGFyc2VzIHRoZSB1cmwgcGFyYW1ldGVycyA/YWJjPWVyZiZsb2w9NDMyY1xuICovXG5mdW5jdGlvbiBnZXRRdWVyeVBhcmFtZXRlcnMocmVxdWVzdFVybCk6IFF1ZXJ5UGFyYW1zIHtcbiAgdmFyIHtxdWVyeX0gPSB1cmwucGFyc2UocmVxdWVzdFVybCwgdHJ1ZSk7XG4gIHJldHVybiBxdWVyeTtcbn1cblxuLyoqXG4gKiBTZXJpYWxpemVzIHRoZSBtZXRob2QgYXJndW1lbnRzIHRvIGFyZ3MgYW5kIGFyZ1R5cGVzIGFycmF5c1xuICogdG8gc2VuZCB0aGUgbWV0YWRhdGEgYWJvdXQgdGhlIGFyZ3VtZW50IHR5cGVzIHdpdGggdGhlIGRhdGFcbiAqIHRvIGhlbHAgdGhlIHNlcnZlciB1bmRlcnN0YW5kIGFuZCBwYXJzZSBpdC5cbiAqL1xuZnVuY3Rpb24gc2VyaWFsaXplQXJncyhhcmdzOiBBcnJheTxhbnk+KTogU2VyaWFsaXplZEFyZ3VtZW50cyB7XG4gIHZhciBhcmdzT25IdHRwID0gW107XG4gIHZhciBhcmdUeXBlcyA9IFtdO1xuICBhcmdzLmZvckVhY2goZnVuY3Rpb24oYXJnKSB7XG4gICAgLy8gSSBkbyB0aGlzIGJlY2F1c2UgbnVsbHMgYXJlIG5vcm1hbGx5IHNlbnQgYXMgZW1wdHkgc3RyaW5nc1xuICAgIGlmIChhcmcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgYXJnc09uSHR0cC5wdXNoKCcnKTtcbiAgICAgIGFyZ1R5cGVzLnB1c2goJ3VuZGVmaW5lZCcpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGFyZ3NPbkh0dHAucHVzaChhcmcpO1xuICAgICAgYXJnVHlwZXMucHVzaCgnc3RyaW5nJyk7XG4gICAgfSBlbHNlIHsgLy8gb2JqZWN0LCBudW1iZXIsIGJvb2xlYW4gbnVsbFxuICAgICAgYXJnc09uSHR0cC5wdXNoKEpTT04uc3RyaW5naWZ5KGFyZykpO1xuICAgICAgYXJnVHlwZXMucHVzaCgnb2JqZWN0Jyk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIHtcbiAgICBhcmdzOiBhcmdzT25IdHRwLFxuICAgIGFyZ1R5cGVzLFxuICB9O1xufVxuXG4vKipcbiAqIERlc2VyaWFsaXplcyBhIHVybCB3aXRoIHF1ZXJ5IHBhcmFtZXRlcnM6IGFyZ3MsIGFyZ1R5cGVzIHRvIGFuIGFycmF5XG4gKiBvZiB0aGUgb3JpZ2luYWwgYXJndW1lbnRzIG9mIHRoZSBzYW1lIHR5cGVzIHRoZSBjbGllbnQgY2FsbGVkIHRoZSBmdW5jdGlvbiB3aXRoLlxuICovXG5mdW5jdGlvbiBkZXNlcmlhbGl6ZUFyZ3MocmVxdWVzdFVybDogc3RyaW5nKTogQXJyYXk8YW55PiB7XG4gIHZhciB7YXJncywgYXJnVHlwZXN9ID0gZ2V0UXVlcnlQYXJhbWV0ZXJzKHJlcXVlc3RVcmwpO1xuICBhcmdzID0gYXJncyB8fCBbXTtcbiAgYXJnVHlwZXMgPSBhcmdUeXBlcyB8fCBbXTtcbiAgdmFyIGFyZ3NBcnJheSA9IEFycmF5LmlzQXJyYXkoYXJncykgPyBhcmdzIDogW2FyZ3NdO1xuICB2YXIgYXJnVHlwZXNBcnJheSA9IEFycmF5LmlzQXJyYXkoYXJnVHlwZXMpID8gYXJnVHlwZXMgOiBbYXJnVHlwZXNdO1xuICByZXR1cm4gYXJnc0FycmF5Lm1hcChmdW5jdGlvbihhcmcsIGkpIHtcbiAgICAvLyBJIGRvIHRoaXMgYmVjYXVzZSBudWxscyBhcmUgbm9ybWFsbHkgc2VudCBhcyBlbXB0eSBzdHJpbmdzLlxuICAgIGlmIChhcmdUeXBlc0FycmF5W2ldID09PSAndW5kZWZpbmVkJykge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGVsc2UgaWYgKGFyZ1R5cGVzQXJyYXlbaV0gPT09ICdzdHJpbmcnKSB7XG4gICAgICByZXR1cm4gYXJnO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBzb21lIG1ldGhvZHMgaGF2ZSBvcHRpb25zIG9iamVjdCBhcmd1bWVudHMuXG4gICAgICByZXR1cm4gSlNPTi5wYXJzZShhcmcpO1xuICAgIH1cbiAgfSk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBhc3luY1JlcXVlc3QsXG4gIGRlc2VyaWFsaXplQXJncyxcbiAgZ2V0UXVlcnlQYXJhbWV0ZXJzLFxuICBwYXJzZVJlcXVlc3RCb2R5LFxuICBzZW5kSnNvblJlc3BvbnNlLFxuICBzZW5kVGV4dFJlc3BvbnNlLFxuICBzZXJpYWxpemVBcmdzLFxufTtcbiJdfQ==