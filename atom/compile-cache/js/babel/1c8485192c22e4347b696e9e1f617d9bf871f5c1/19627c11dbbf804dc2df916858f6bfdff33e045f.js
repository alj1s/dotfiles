/// <reference path='../../globals'/>
var parent = require('../../worker/parent');
var atomConfig = require('./atomConfig');
var fs = require('fs');
var atomUtils = require('./atomUtils');
var fuzzaldrin = require('fuzzaldrin');
var CSON = require('season');
var explicitlyTriggered = false;
function triggerAutocompletePlus() {
    atom.commands.dispatch(atom.views.getView(atom.workspace.getActiveTextEditor()), 'autocomplete-plus:activate');
    explicitlyTriggered = true;
}
exports.triggerAutocompletePlus = triggerAutocompletePlus;
var tsSnipPrefixLookup = Object.create(null);
function loadSnippets() {
    var confPath = atom.getConfigDirPath();
    CSON.readFile(confPath + '/packages/atom-typescript/snippets/typescript-snippets.cson', function (err, snippetsRoot) {
        if (err) return;
        if (!snippetsRoot || !snippetsRoot['.source.ts']) return;
        var tsSnippets = snippetsRoot['.source.ts'];
        for (var snippetName in tsSnippets) {
            if (tsSnippets.hasOwnProperty(snippetName)) {
                tsSnipPrefixLookup[tsSnippets[snippetName].prefix] = {
                    body: tsSnippets[snippetName].body,
                    name: snippetName
                };
            }
        }
    });
}
loadSnippets();
exports.provider = {
    selector: '.source.ts',
    inclusionPriority: 3,
    excludeLowerPriority: false,
    getSuggestions: function getSuggestions(options) {
        var filePath = options.editor.getPath();
        if (!filePath) return Promise.resolve([]);
        if (!fs.existsSync(filePath)) return Promise.resolve([]);
        var pathMatchers = ['reference.path.string', 'require.path.string', 'es6import.path.string'];
        var lastScope = options.scopeDescriptor.scopes[options.scopeDescriptor.scopes.length - 1];
        if (pathMatchers.some(function (p) {
            return lastScope === p;
        })) {
            return parent.getRelativePathsInProject({ filePath: filePath, prefix: options.prefix, includeExternalModules: lastScope !== 'reference.path.string' }).then(function (resp) {
                return resp.files.map(function (file) {
                    var relativePath = file.relativePath;
                    var suggestionText = relativePath;
                    var suggestion = {
                        text: suggestionText,
                        replacementPrefix: resp.endsInPunctuation ? '' : options.prefix,
                        rightLabelHTML: '<span>' + file.name + '</span>',
                        type: 'path'
                    };
                    if (lastScope == 'reference.path.string') {
                        suggestion.atomTS_IsReference = {
                            relativePath: relativePath
                        };
                    }
                    if (lastScope == 'require.path.string') {
                        suggestion.atomTS_IsImport = {
                            relativePath: relativePath
                        };
                    }
                    if (lastScope == 'es6import.path.string') {
                        suggestion.atomTS_IsES6Import = {
                            relativePath: relativePath
                        };
                    }
                    return suggestion;
                });
            });
        } else {
            if (explicitlyTriggered) {
                explicitlyTriggered = false;
            } else {
                if (options.prefix && options.prefix.trim() == ';') {
                    return Promise.resolve([]);
                }
            }
            var position = atomUtils.getEditorPositionForBufferPosition(options.editor, options.bufferPosition);
            var promisedSuggestions = parent.getCompletionsAtPosition({
                filePath: filePath,
                position: position,
                prefix: options.prefix
            }).then(function (resp) {
                var completionList = resp.completions;
                var suggestions = completionList.map(function (c) {
                    if (c.snippet) {
                        return {
                            snippet: c.snippet,
                            replacementPrefix: '',
                            rightLabel: 'signature',
                            type: 'snippet'
                        };
                    } else {
                        var prefix = options.prefix;
                        if (c.name.startsWith('$')) {
                            prefix = '$' + prefix;
                        }
                        return {
                            text: c.name,
                            replacementPrefix: resp.endsInPunctuation ? '' : prefix,
                            rightLabel: c.display,
                            leftLabel: c.kind,
                            type: atomUtils.kindToType(c.kind),
                            description: c.comment
                        };
                    }
                });
                if (tsSnipPrefixLookup[options.prefix]) {
                    var suggestion = {
                        snippet: tsSnipPrefixLookup[options.prefix].body,
                        replacementPrefix: options.prefix,
                        rightLabelHTML: 'snippet: ' + options.prefix,
                        type: 'snippet'
                    };
                    suggestions.unshift(suggestion);
                }
                return suggestions;
            });
            return promisedSuggestions;
        }
    },
    onDidInsertSuggestion: function onDidInsertSuggestion(options) {
        if (options.suggestion.atomTS_IsReference || options.suggestion.atomTS_IsImport || options.suggestion.atomTS_IsES6Import) {
            var quote = (/["']/.exec(atomConfig.preferredQuoteCharacter) || [''])[0];
            if (options.suggestion.atomTS_IsReference) {
                options.editor.moveToBeginningOfLine();
                options.editor.selectToEndOfLine();
                options.editor.replaceSelectedText(null, function () {
                    return '/// <reference path="' + options.suggestion.atomTS_IsReference.relativePath + '.ts"/>';
                });
            }
            if (options.suggestion.atomTS_IsImport) {
                options.editor.moveToBeginningOfLine();
                options.editor.selectToEndOfLine();
                var groups = /^\s*import\s*(\w*)\s*=\s*require\s*\(\s*(["'])/.exec(options.editor.getSelectedText());
                var alias = groups[1];
                quote = quote || groups[2];
                options.editor.replaceSelectedText(null, function () {
                    return 'import ' + alias + ' = require(' + quote + options.suggestion.atomTS_IsImport.relativePath + quote + ');';
                });
            }
            if (options.suggestion.atomTS_IsES6Import) {
                var row = options.editor.getCursorBufferPosition().row;
                var originalText = options.editor.lineTextForBufferRow(row);
                var groups = /(.*)from\s*(["'])/.exec(originalText);
                var beforeFrom = groups[1];
                quote = quote || groups[2];
                var newTextAfterFrom = 'from ' + quote + options.suggestion.atomTS_IsES6Import.relativePath + quote + ';';
                options.editor.setTextInBufferRange([[row, beforeFrom.length], [row, originalText.length]], newTextAfterFrom);
            }
            options.editor.moveToEndOfLine();
        }
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvZGlzdC9tYWluL2F0b20vYXV0b0NvbXBsZXRlUHJvdmlkZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUNBLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO0FBQzVDLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxjQUFjLENBQUMsQ0FBQztBQUN6QyxJQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsSUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0FBQ3ZDLElBQUksVUFBVSxHQUFHLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQztBQUN2QyxJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDN0IsSUFBSSxtQkFBbUIsR0FBRyxLQUFLLENBQUM7QUFDaEMsU0FBUyx1QkFBdUIsR0FBRztBQUMvQixRQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUFFLENBQUMsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0FBQy9HLHVCQUFtQixHQUFHLElBQUksQ0FBQztDQUM5QjtBQUNELE9BQU8sQ0FBQyx1QkFBdUIsR0FBRyx1QkFBdUIsQ0FBQztBQUMxRCxJQUFJLGtCQUFrQixHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDN0MsU0FBUyxZQUFZLEdBQUc7QUFDcEIsUUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7QUFDdkMsUUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEdBQUcsNkRBQTZELEVBQUUsVUFBVSxHQUFHLEVBQUUsWUFBWSxFQUFFO0FBQ2pILFlBQUksR0FBRyxFQUNILE9BQU87QUFD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TUFBTSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVELG9CQUFJLE1BQU0sR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDcEQsb0JBQUksVUFBVSxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUMzQixxQkFBSyxHQUFHLEtBQUssSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0Isb0JBQUksZ0JBQWdCLEdBQUcsT0FBTyxHQUFHLEtBQUssR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLFlBQVksR0FBRyxLQUFLLEdBQUcsR0FBRyxDQUFDO0FBQzFHLHVCQUFPLENBQUMsTUFBTSxDQUFDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLGdCQUFnQixDQUFDLENBQUM7YUFDakg7QUFDRCxtQkFBTyxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztTQUNwQztLQUNKO0NBQ0osQ0FBQyIsImZpbGUiOiIvVXNlcnMvYW5kcmV3am9uZXMvLmF0b20vcGFja2FnZXMvYXRvbS10eXBlc2NyaXB0L2Rpc3QvbWFpbi9hdG9tL2F1dG9Db21wbGV0ZVByb3ZpZGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8vIDxyZWZlcmVuY2UgcGF0aD0nLi4vLi4vZ2xvYmFscycvPlxudmFyIHBhcmVudCA9IHJlcXVpcmUoJy4uLy4uL3dvcmtlci9wYXJlbnQnKTtcbnZhciBhdG9tQ29uZmlnID0gcmVxdWlyZSgnLi9hdG9tQ29uZmlnJyk7XG52YXIgZnMgPSByZXF1aXJlKCdmcycpO1xudmFyIGF0b21VdGlscyA9IHJlcXVpcmUoJy4vYXRvbVV0aWxzJyk7XG52YXIgZnV6emFsZHJpbiA9IHJlcXVpcmUoJ2Z1enphbGRyaW4nKTtcbnZhciBDU09OID0gcmVxdWlyZShcInNlYXNvblwiKTtcbnZhciBleHBsaWNpdGx5VHJpZ2dlcmVkID0gZmFsc2U7XG5mdW5jdGlvbiB0cmlnZ2VyQXV0b2NvbXBsZXRlUGx1cygpIHtcbiAgICBhdG9tLmNvbW1hbmRzLmRpc3BhdGNoKGF0b20udmlld3MuZ2V0VmlldyhhdG9tLndvcmtzcGFjZS5nZXRBY3RpdmVUZXh0RWRpdG9yKCkpLCAnYXV0b2NvbXBsZXRlLXBsdXM6YWN0aXZhdGUnKTtcbiAgICBleHBsaWNpdGx5VHJpZ2dlcmVkID0gdHJ1ZTtcbn1cbmV4cG9ydHMudHJpZ2dlckF1dG9jb21wbGV0ZVBsdXMgPSB0cmlnZ2VyQXV0b2NvbXBsZXRlUGx1cztcbnZhciB0c1NuaXBQcmVmaXhMb29rdXAgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuZnVuY3Rpb24gbG9hZFNuaXBwZXRzKCkge1xuICAgIHZhciBjb25mUGF0aCA9IGF0b20uZ2V0Q29uZmlnRGlyUGF0aCgpO1xuICAgIENTT04ucmVhZEZpbGUoY29uZlBhdGggKyBcIi9wYWNrYWdlcy9hdG9tLXR5cGVzY3JpcHQvc25pcHBldHMvdHlwZXNjcmlwdC1zbmlwcGV0cy5jc29uXCIsIGZ1bmN0aW9uIChlcnIsIHNuaXBwZXRzUm9vdCkge1xuICAgICAgICBpZiAoZXJyKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBpZiAoIXNuaXBwZXRzUm9vdCB8fCAhc25pcHBldHNSb290Wycuc291cmNlLnRzJ10pXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIHZhciB0c1NuaXBwZXRzID0gc25pcHBldHNSb290Wycuc291cmNlLnRzJ107XG4gICAgICAgIGZvciAodmFyIHNuaXBwZXROYW1lIGluIHRzU25pcHBldHMpIHtcbiAgICAgICAgICAgIGlmICh0c1NuaXBwZXRzLmhhc093blByb3BlcnR5KHNuaXBwZXROYW1lKSkge1xuICAgICAgICAgICAgICAgIHRzU25pcFByZWZpeExvb2t1cFt0c1NuaXBwZXRzW3NuaXBwZXROYW1lXS5wcmVmaXhdID0ge1xuICAgICAgICAgICAgICAgICAgICBib2R5OiB0c1NuaXBwZXRzW3NuaXBwZXROYW1lXS5ib2R5LFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBzbmlwcGV0TmFtZVxuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbn1cbmxvYWRTbmlwcGV0cygpO1xuZXhwb3J0cy5wcm92aWRlciA9IHtcbiAgICBzZWxlY3RvcjogJy5zb3VyY2UudHMnLFxuICAgIGluY2x1c2lvblByaW9yaXR5OiAzLFxuICAgIGV4Y2x1ZGVMb3dlclByaW9yaXR5OiBmYWxzZSxcbiAgICBnZXRTdWdnZXN0aW9uczogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgdmFyIGZpbGVQYXRoID0gb3B0aW9ucy5lZGl0b3IuZ2V0UGF0aCgpO1xuICAgICAgICBpZiAoIWZpbGVQYXRoKVxuICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShbXSk7XG4gICAgICAgIGlmICghZnMuZXhpc3RzU3luYyhmaWxlUGF0aCkpXG4gICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcbiAgICAgICAgdmFyIHBhdGhNYXRjaGVycyA9IFsncmVmZXJlbmNlLnBhdGguc3RyaW5nJywgJ3JlcXVpcmUucGF0aC5zdHJpbmcnLCAnZXM2aW1wb3J0LnBhdGguc3RyaW5nJ107XG4gICAgICAgIHZhciBsYXN0U2NvcGUgPSBvcHRpb25zLnNjb3BlRGVzY3JpcHRvci5zY29wZXNbb3B0aW9ucy5zY29wZURlc2NyaXB0b3Iuc2NvcGVzLmxlbmd0aCAtIDFdO1xuICAgICAgICBpZiAocGF0aE1hdGNoZXJzLnNvbWUoZnVuY3Rpb24gKHApIHsgcmV0dXJuIGxhc3RTY29wZSA9PT0gcDsgfSkpIHtcbiAgICAgICAgICAgIHJldHVybiBwYXJlbnQuZ2V0UmVsYXRpdmVQYXRoc0luUHJvamVjdCh7IGZpbGVQYXRoOiBmaWxlUGF0aCwgcHJlZml4OiBvcHRpb25zLnByZWZpeCwgaW5jbHVkZUV4dGVybmFsTW9kdWxlczogbGFzdFNjb3BlICE9PSAncmVmZXJlbmNlLnBhdGguc3RyaW5nJyB9KVxuICAgICAgICAgICAgICAgIC50aGVuKGZ1bmN0aW9uIChyZXNwKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlc3AuZmlsZXMubWFwKGZ1bmN0aW9uIChmaWxlKSB7XG4gICAgICAgICAgICAgICAgICAgIHZhciByZWxhdGl2ZVBhdGggPSBmaWxlLnJlbGF0aXZlUGF0aDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN1Z2dlc3Rpb25UZXh0ID0gcmVsYXRpdmVQYXRoO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3VnZ2VzdGlvbiA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IHN1Z2dlc3Rpb25UZXh0LFxuICAgICAgICAgICAgICAgICAgICAgICAgcmVwbGFjZW1lbnRQcmVmaXg6IHJlc3AuZW5kc0luUHVuY3R1YXRpb24gPyAnJyA6IG9wdGlvbnMucHJlZml4LFxuICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRMYWJlbEhUTUw6ICc8c3Bhbj4nICsgZmlsZS5uYW1lICsgJzwvc3Bhbj4nLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3BhdGgnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIGlmIChsYXN0U2NvcGUgPT0gJ3JlZmVyZW5jZS5wYXRoLnN0cmluZycpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb24uYXRvbVRTX0lzUmVmZXJlbmNlID0ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbGF0aXZlUGF0aDogcmVsYXRpdmVQYXRoXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGlmIChsYXN0U2NvcGUgPT0gJ3JlcXVpcmUucGF0aC5zdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWdnZXN0aW9uLmF0b21UU19Jc0ltcG9ydCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZVBhdGg6IHJlbGF0aXZlUGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdFNjb3BlID09ICdlczZpbXBvcnQucGF0aC5zdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzdWdnZXN0aW9uLmF0b21UU19Jc0VTNkltcG9ydCA9IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWxhdGl2ZVBhdGg6IHJlbGF0aXZlUGF0aFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3VnZ2VzdGlvbjtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgaWYgKGV4cGxpY2l0bHlUcmlnZ2VyZWQpIHtcbiAgICAgICAgICAgICAgICBleHBsaWNpdGx5VHJpZ2dlcmVkID0gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5wcmVmaXggJiYgb3B0aW9ucy5wcmVmaXgudHJpbSgpID09ICc7Jykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKFtdKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgcG9zaXRpb24gPSBhdG9tVXRpbHMuZ2V0RWRpdG9yUG9zaXRpb25Gb3JCdWZmZXJQb3NpdGlvbihvcHRpb25zLmVkaXRvciwgb3B0aW9ucy5idWZmZXJQb3NpdGlvbik7XG4gICAgICAgICAgICB2YXIgcHJvbWlzZWRTdWdnZXN0aW9ucyA9IHBhcmVudC5nZXRDb21wbGV0aW9uc0F0UG9zaXRpb24oe1xuICAgICAgICAgICAgICAgIGZpbGVQYXRoOiBmaWxlUGF0aCxcbiAgICAgICAgICAgICAgICBwb3NpdGlvbjogcG9zaXRpb24sXG4gICAgICAgICAgICAgICAgcHJlZml4OiBvcHRpb25zLnByZWZpeCxcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgLnRoZW4oZnVuY3Rpb24gKHJlc3ApIHtcbiAgICAgICAgICAgICAgICB2YXIgY29tcGxldGlvbkxpc3QgPSByZXNwLmNvbXBsZXRpb25zO1xuICAgICAgICAgICAgICAgIHZhciBzdWdnZXN0aW9ucyA9IGNvbXBsZXRpb25MaXN0Lm1hcChmdW5jdGlvbiAoYykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoYy5zbmlwcGV0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNuaXBwZXQ6IGMuc25pcHBldCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudFByZWZpeDogJycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmlnaHRMYWJlbDogJ3NpZ25hdHVyZScsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3NuaXBwZXQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBwcmVmaXggPSBvcHRpb25zLnByZWZpeDtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChjLm5hbWUuc3RhcnRzV2l0aCgnJCcpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gXCIkXCIgKyBwcmVmaXg7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGMubmFtZSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudFByZWZpeDogcmVzcC5lbmRzSW5QdW5jdHVhdGlvbiA/ICcnIDogcHJlZml4LFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJpZ2h0TGFiZWw6IGMuZGlzcGxheSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZWZ0TGFiZWw6IGMua2luZCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBhdG9tVXRpbHMua2luZFRvVHlwZShjLmtpbmQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc2NyaXB0aW9uOiBjLmNvbW1lbnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgaWYgKHRzU25pcFByZWZpeExvb2t1cFtvcHRpb25zLnByZWZpeF0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHN1Z2dlc3Rpb24gPSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBzbmlwcGV0OiB0c1NuaXBQcmVmaXhMb29rdXBbb3B0aW9ucy5wcmVmaXhdLmJvZHksXG4gICAgICAgICAgICAgICAgICAgICAgICByZXBsYWNlbWVudFByZWZpeDogb3B0aW9ucy5wcmVmaXgsXG4gICAgICAgICAgICAgICAgICAgICAgICByaWdodExhYmVsSFRNTDogXCJzbmlwcGV0OiBcIiArIG9wdGlvbnMucHJlZml4LFxuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3NuaXBwZXQnXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgICAgIHN1Z2dlc3Rpb25zLnVuc2hpZnQoc3VnZ2VzdGlvbik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIHJldHVybiBzdWdnZXN0aW9ucztcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHByb21pc2VkU3VnZ2VzdGlvbnM7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIG9uRGlkSW5zZXJ0U3VnZ2VzdGlvbjogZnVuY3Rpb24gKG9wdGlvbnMpIHtcbiAgICAgICAgaWYgKG9wdGlvbnMuc3VnZ2VzdGlvbi5hdG9tVFNfSXNSZWZlcmVuY2VcbiAgICAgICAgICAgIHx8IG9wdGlvbnMuc3VnZ2VzdGlvbi5hdG9tVFNfSXNJbXBvcnRcbiAgICAgICAgICAgIHx8IG9wdGlvbnMuc3VnZ2VzdGlvbi5hdG9tVFNfSXNFUzZJbXBvcnQpIHtcbiAgICAgICAgICAgIHZhciBxdW90ZSA9ICgvW1wiJ10vLmV4ZWMoYXRvbUNvbmZpZy5wcmVmZXJyZWRRdW90ZUNoYXJhY3RlcikgfHwgWycnXSlbMF07XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5zdWdnZXN0aW9uLmF0b21UU19Jc1JlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMuZWRpdG9yLm1vdmVUb0JlZ2lubmluZ09mTGluZSgpO1xuICAgICAgICAgICAgICAgIG9wdGlvbnMuZWRpdG9yLnNlbGVjdFRvRW5kT2ZMaW5lKCk7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5lZGl0b3IucmVwbGFjZVNlbGVjdGVkVGV4dChudWxsLCBmdW5jdGlvbiAoKSB7IHJldHVybiAnLy8vIDxyZWZlcmVuY2UgcGF0aD1cIicgKyBvcHRpb25zLnN1Z2dlc3Rpb24uYXRvbVRTX0lzUmVmZXJlbmNlLnJlbGF0aXZlUGF0aCArICcudHNcIi8+JzsgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAob3B0aW9ucy5zdWdnZXN0aW9uLmF0b21UU19Jc0ltcG9ydCkge1xuICAgICAgICAgICAgICAgIG9wdGlvbnMuZWRpdG9yLm1vdmVUb0JlZ2lubmluZ09mTGluZSgpO1xuICAgICAgICAgICAgICAgIG9wdGlvbnMuZWRpdG9yLnNlbGVjdFRvRW5kT2ZMaW5lKCk7XG4gICAgICAgICAgICAgICAgdmFyIGdyb3VwcyA9IC9eXFxzKmltcG9ydFxccyooXFx3KilcXHMqPVxccypyZXF1aXJlXFxzKlxcKFxccyooW1wiJ10pLy5leGVjKG9wdGlvbnMuZWRpdG9yLmdldFNlbGVjdGVkVGV4dCgpKTtcbiAgICAgICAgICAgICAgICB2YXIgYWxpYXMgPSBncm91cHNbMV07XG4gICAgICAgICAgICAgICAgcXVvdGUgPSBxdW90ZSB8fCBncm91cHNbMl07XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5lZGl0b3IucmVwbGFjZVNlbGVjdGVkVGV4dChudWxsLCBmdW5jdGlvbiAoKSB7IHJldHVybiBcImltcG9ydCBcIiArIGFsaWFzICsgXCIgPSByZXF1aXJlKFwiICsgcXVvdGUgKyBvcHRpb25zLnN1Z2dlc3Rpb24uYXRvbVRTX0lzSW1wb3J0LnJlbGF0aXZlUGF0aCArIHF1b3RlICsgXCIpO1wiOyB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChvcHRpb25zLnN1Z2dlc3Rpb24uYXRvbVRTX0lzRVM2SW1wb3J0KSB7XG4gICAgICAgICAgICAgICAgdmFyIHJvdyA9IG9wdGlvbnMuZWRpdG9yLmdldEN1cnNvckJ1ZmZlclBvc2l0aW9uKCkucm93O1xuICAgICAgICAgICAgICAgIHZhciBvcmlnaW5hbFRleHQgPSBvcHRpb25zLmVkaXRvci5saW5lVGV4dEZvckJ1ZmZlclJvdyhyb3cpO1xuICAgICAgICAgICAgICAgIHZhciBncm91cHMgPSAvKC4qKWZyb21cXHMqKFtcIiddKS8uZXhlYyhvcmlnaW5hbFRleHQpO1xuICAgICAgICAgICAgICAgIHZhciBiZWZvcmVGcm9tID0gZ3JvdXBzWzFdO1xuICAgICAgICAgICAgICAgIHF1b3RlID0gcXVvdGUgfHwgZ3JvdXBzWzJdO1xuICAgICAgICAgICAgICAgIHZhciBuZXdUZXh0QWZ0ZXJGcm9tID0gXCJmcm9tIFwiICsgcXVvdGUgKyBvcHRpb25zLnN1Z2dlc3Rpb24uYXRvbVRTX0lzRVM2SW1wb3J0LnJlbGF0aXZlUGF0aCArIHF1b3RlICsgXCI7XCI7XG4gICAgICAgICAgICAgICAgb3B0aW9ucy5lZGl0b3Iuc2V0VGV4dEluQnVmZmVyUmFuZ2UoW1tyb3csIGJlZm9yZUZyb20ubGVuZ3RoXSwgW3Jvdywgb3JpZ2luYWxUZXh0Lmxlbmd0aF1dLCBuZXdUZXh0QWZ0ZXJGcm9tKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIG9wdGlvbnMuZWRpdG9yLm1vdmVUb0VuZE9mTGluZSgpO1xuICAgICAgICB9XG4gICAgfVxufTtcbiJdfQ==