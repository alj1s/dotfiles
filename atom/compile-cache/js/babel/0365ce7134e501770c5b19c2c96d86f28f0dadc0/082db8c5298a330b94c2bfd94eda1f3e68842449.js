var _createClass = (function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ('value' in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; })();

/* @flow */

/*
 * Copyright (c) 2015-present, Facebook, Inc.
 * All rights reserved.
 *
 * This source code is licensed under the license found in the LICENSE file in
 * the root directory of this source tree.
 */

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError('Cannot call a class as a function'); } }

'use babel';

var trackFunction;
function track() {
  var trackFunc = trackFunction || (trackFunction = require('nuclide-analytics').track);

  for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
    args[_key] = arguments[_key];
  }

  trackFunc.apply(null, args);
}

var debounceFunction = null;
function debounce() {
  var debounceFunc = debounceFunction || (debounceFunction = require('nuclide-commons').debounce);

  for (var _len2 = arguments.length, args = Array(_len2), _key2 = 0; _key2 < _len2; _key2++) {
    args[_key2] = arguments[_key2];
  }

  return debounceFunc.apply(null, args);
};

var searchResultManager = null;
function getSearchResultManager() {
  return searchResultManager || (searchResultManager = require('./SearchResultManager'));
};

var DEFAULT_PROVIDER = 'FileListProvider';
var MAX_MODAL_WIDTH = 800;

/**
 * A "session" for the purpose of analytics. It exists from the moment the quick-open UI becomes
 * visible until it gets closed, either via file selection or cancellation.
 */
var analyticsSessionId = null;
var AnalyticsEvents = {
  CHANGE_SELECTION: 'quickopen-change-selection',
  CHANGE_TAB: 'quickopen-change-tab',
  CLOSE_PANEL: 'quickopen-close-panel',
  OPEN_PANEL: 'quickopen-open-panel',
  SELECT_FILE: 'quickopen-select-file'
};
var AnalyticsDebounceDelays = {
  CHANGE_TAB: 100,
  CHANGE_SELECTION: 100
};

var _quickSelectionComponent = null;
function getQuickSelectionComponentLazily() {
  if (!_quickSelectionComponent) {
    _quickSelectionComponent = require('./QuickSelectionComponent');
  }
  return _quickSelectionComponent;
}

var _react = null;
function getReactLazily() {
  if (_react === null) {
    _react = require('react-for-atom');
  }
  return _react;
}

var Activation = (function () {
  function Activation() {
    var _this = this;

    _classCallCheck(this, Activation);

    this._previousFocus = null;

    var _require = require('atom');

    var CompositeDisposable = _require.CompositeDisposable;

    this._currentProvider = getSearchResultManager().getProvider(DEFAULT_PROVIDER);
    this._reactDiv = document.createElement('div');
    this._searchPanel = atom.workspace.addModalPanel({ item: this._reactDiv, visible: false });
    this._debouncedUpdateModalPosition = debounce(this._updateModalPosition.bind(this), 200);
    window.addEventListener('resize', this._debouncedUpdateModalPosition);
    this._updateModalPosition();

    this._searchComponent = this._render();
    this._searchComponent.onSelection(function (selection) {
      var options = {};
      if (selection.line) {
        options.initialLine = selection.line;
      }
      if (selection.column) {
        options.initialColumn = selection.column;
      }
      atom.workspace.open(selection.path, options);
      var query = _this._searchComponent.getInputTextEditor().textContent;
      var providerName = _this._currentProvider.constructor.name;
      track(AnalyticsEvents.SELECT_FILE, {
        'quickopen-filepath': selection.path,
        'quickopen-query': query,
        'quickopen-provider': providerName,
        'quickopen-session': analyticsSessionId
      });
      _this.closeSearchPanel();
    });

    this._searchComponent.onCancellation(function () {
      return _this.closeSearchPanel();
    });
    this._searchComponent.onTabChange(debounce(function (providerName) {
      analyticsSessionId = analyticsSessionId || Date.now().toString();
      track(AnalyticsEvents.CHANGE_TAB, {
        'quickopen-provider': providerName,
        'quickopen-session': analyticsSessionId
      });
      _this.toggleProvider(providerName);
    }, AnalyticsDebounceDelays.CHANGE_TAB));
    this._searchComponent.onSelectionChanged(debounce(function (selection) {
      track(AnalyticsEvents.CHANGE_SELECTION, {

        'quickopen-selected-index': selection.selectedItemIndex.toString(),
        'quickopen-selected-service': Number.prototype.toString.call(selection.selectedItemIndex),
        'quickopen-selected-directory': selection.selectedDirectory,
        'quickopen-session': analyticsSessionId
      });
    }, AnalyticsDebounceDelays.CHANGE_SELECTION));
  }

  _createClass(Activation, [{
    key: '_updateModalPosition',
    value: function _updateModalPosition() {
      // Customize modal element
      var modalElement = this._searchPanel.getItem().parentNode;

      var _document$documentElement$getBoundingClientRect = document.documentElement.getBoundingClientRect();

      var width = _document$documentElement$getBoundingClientRect.width;
      var height = _document$documentElement$getBoundingClientRect.height;

      var modalWidth = Math.min(MAX_MODAL_WIDTH, width);
      modalElement.style.setProperty('width', modalWidth + 'px');
      modalElement.style.setProperty('margin-left', -modalWidth / 2 + 'px');
    }
  }, {
    key: '_render',
    value: function _render() {
      var QuickSelectionComponent = getQuickSelectionComponentLazily();
      var React = getReactLazily();
      return React.render(React.createElement(QuickSelectionComponent, {
        provider: this._currentProvider
      }), this._reactDiv);
    }
  }, {
    key: 'toggleProvider',
    value: function toggleProvider(providerName) {
      analyticsSessionId = analyticsSessionId || Date.now().toString();
      track(AnalyticsEvents.CHANGE_TAB, {
        'quickopen-provider': providerName,
        'quickopen-session': analyticsSessionId
      });
      var provider = getSearchResultManager().getProvider(providerName);
      // "toggle" behavior
      if (this._searchPanel !== null && this._searchPanel.isVisible() && provider === this._currentProvider) {
        this.closeSearchPanel();
        return;
      }

      this._currentProvider = provider;
      if (this._searchComponent) {
        this._searchComponent = this._render();
      }
      this.showSearchPanel();
    }
  }, {
    key: 'showSearchPanel',
    value: function showSearchPanel() {
      this._previousFocus = document.activeElement;
      if (this._searchComponent && this._searchPanel) {
        // Start a new search "session" for analytics purposes.
        track(AnalyticsEvents.OPEN_PANEL, {
          'quickopen-session': analyticsSessionId
        });
        this._searchPanel.show();
        this._searchComponent.focus();
        this._searchComponent.selectInput();
      }
    }
  }, {
    key: 'closeSearchPanel',
    value: function closeSearchPanel() {
      if (this._searchComponent && this._searchPanel) {
        track(AnalyticsEvents.CLOSE_PANEL, {
          'quickopen-session': analyticsSessionId
        });
        this._searchPanel.hide();
        this._searchComponent.blur();
        analyticsSessionId = null;
      }

      if (this._previousFocus !== null) {
        this._previousFocus.focus();
        this._previousFocus = null;
      }
    }
  }]);

  return Activation;
})();

var _require2 = require('atom');

var CompositeDisposable = _require2.CompositeDisposable;

var activation = null;
var listeners = null;
var projectRoots = null;

function activateSearchUI() {
  if (!activation) {
    activation = new Activation();
  }
}

/**
 * @param projectPaths All the root directories in the Atom workspace.
 */
function initSearch(projectPaths) {
  var _require3 = require('nuclide-client');

  var getClient = _require3.getClient;

  var newProjectRoots = new Set();
  projectRoots.forEach(function (projectPath) {
    newProjectRoots.add(projectPath);
    if (projectRoots.has(projectPath)) {
      return;
    }
    var client = getClient(projectPath);
    if (client) {
      // It doesn't matter what the search term is. Empirically, doing an initial
      // search speeds up the next search much more than simply doing the setup
      // kicked off by 'fileSearchForDirectory'.
      client.searchDirectory(projectPath, 'a');
    }
  });
  projectRoots = newProjectRoots;
}

module.exports = {

  activate: function activate() {
    listeners = new CompositeDisposable();
    listeners.add(atom.commands.add('atom-workspace', {
      'nuclide-quick-open:toggle-omni-search': function nuclideQuickOpenToggleOmniSearch() {
        activateSearchUI();
        activation.toggleProvider('OmniSearchResultProvider');
      },
      'nuclide-quick-open:toggle-quick-open': function nuclideQuickOpenToggleQuickOpen() {
        activateSearchUI();
        activation.toggleProvider('FileListProvider');
      },
      'nuclide-quick-open:toggle-symbol-search': function nuclideQuickOpenToggleSymbolSearch() {
        activateSearchUI();
        activation.toggleProvider('SymbolListProvider');
      },
      'nuclide-quick-open:toggle-biggrep-search': function nuclideQuickOpenToggleBiggrepSearch() {
        activateSearchUI();
        activation.toggleProvider('BigGrepListProvider');
      },
      'nuclide-quick-open:toggle-openfilename-search': function nuclideQuickOpenToggleOpenfilenameSearch() {
        activateSearchUI();
        activation.toggleProvider('OpenFileListProvider');
      }
    }));

    // Do search preprocessing for all existing and future root directories.
    projectRoots = new Set();
    atom.project.getPaths(initSearch);
    listeners.add(atom.project.onDidChangePaths(initSearch));
  },

  deactivate: function deactivate() {
    if (activation) {
      activation = null;
    }
    if (listeners) {
      listeners.dispose();
      listeners = null;
    }
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9hbmRyZXdqb25lcy8uYXRvbS9wYWNrYWdlcy9udWNsaWRlLXF1aWNrLW9wZW4vbGliL21haW4uanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7QUFBQSxXQUFXLENBQUM7O0FBbUJaLElBQUksYUFBYSxDQUFDO0FBQ2xCLFNBQVMsS0FBSyxHQUFVO0FBQ3RCLE1BQUksU0FBUyxHQUFHLGFBQWEsS0FBSyxhQUFhLEdBQUcsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUMsS0FBSyxDQUFBLENBQUU7O29DQUR0RSxJQUFJO0FBQUosUUFBSTs7O0FBRXBCLFdBQVMsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0NBQzdCOztBQUVELElBQUksZ0JBQWdCLEdBQUcsSUFBSSxDQUFDO0FBQzVCLFNBQVMsUUFBUSxHQUFVO0FBQ3pCLE1BQUksWUFBWSxHQUFHLGdCQUFnQixLQUFLLGdCQUFnQixHQUFHLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLFFBQVEsQ0FBQSxDQUFFOztxQ0FEN0UsSUFBSTtBQUFKLFFBQUk7OztBQUV2QixTQUFPLFlBQVksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxDQUFDO0NBQ3ZDLENBQUM7O0FBRUYsSUFBSSxtQkFBbUIsR0FBRyxJQUFJLENBQUM7QUFDL0IsU0FBUyxzQkFBc0IsR0FBRztBQUNoQyxTQUFPLG1CQUFtQixLQUFLLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyx1QkFBdUIsQ0FBQyxDQUFBLENBQUU7Q0FDeEYsQ0FBQzs7QUFFRixJQUFJLGdCQUFnQixHQUFHLGtCQUFrQixDQUFDO0FBQzFDLElBQUksZUFBZSxHQUFHLEdBQUcsQ0FBQzs7Ozs7O0FBTTFCLElBQUksa0JBQWtCLEdBQUcsSUFBSSxDQUFDO0FBQzlCLElBQUksZUFBZSxHQUFHO0FBQ3BCLGtCQUFnQixFQUFFLDRCQUE0QjtBQUM5QyxZQUFVLEVBQVEsc0JBQXNCO0FBQ3hDLGFB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LEVBQUUsQ0FBQztBQUNuQixrQkFBVSxDQUFDLGNBQWMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO09BQy9DO0FBQ0QsK0NBQXlDLEVBQUUsOENBQU07QUFDL0Msd0JBQWdCLEVBQUUsQ0FBQztBQUNuQixrQkFBVSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO09BQ2pEO0FBQ0QsZ0RBQTBDLEVBQUUsK0NBQU07QUFDaEQsd0JBQWdCLEVBQUUsQ0FBQztBQUNuQixrQkFBVSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUIsQ0FBQyxDQUFDO09BQ2xEO0FBQ0QscURBQStDLEVBQUUsb0RBQU07QUFDckQsd0JBQWdCLEVBQUUsQ0FBQztBQUNuQixrQkFBVSxDQUFDLGNBQWMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO09BQ25EO0tBQ0YsQ0FBQyxDQUNILENBQUM7OztBQUdGLGdCQUFZLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztBQUN6QixRQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNsQyxhQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsZ0JBQWdCLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztHQUMxRDs7QUFFRCxZQUFVLEVBQUEsc0JBQVM7QUFDakIsUUFBSSxVQUFVLEVBQUU7QUFDZCxnQkFBVSxHQUFHLElBQUksQ0FBQztLQUNuQjtBQUNELFFBQUksU0FBUyxFQUFFO0FBQ2IsZUFBUyxDQUFDLE9BQU8sRUFBRSxDQUFDO0FBQ3BCLGVBQVMsR0FBRyxJQUFJLENBQUM7S0FDbEI7R0FDRjtDQUNGLENBQUMiLCJmaWxlIjoiL1VzZXJzL2FuZHJld2pvbmVzLy5hdG9tL3BhY2thZ2VzL251Y2xpZGUtcXVpY2stb3Blbi9saWIvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbIid1c2UgYmFiZWwnO1xuLyogQGZsb3cgKi9cblxuLypcbiAqIENvcHlyaWdodCAoYykgMjAxNS1wcmVzZW50LCBGYWNlYm9vaywgSW5jLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBUaGlzIHNvdXJjZSBjb2RlIGlzIGxpY2Vuc2VkIHVuZGVyIHRoZSBsaWNlbnNlIGZvdW5kIGluIHRoZSBMSUNFTlNFIGZpbGUgaW5cbiAqIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICovXG5cbmltcG9ydCB0eXBlIHtcbiAgUXVpY2tTZWxlY3Rpb25Db21wb25lbnQsXG59IGZyb20gJy4vUXVpY2tTZWxlY3Rpb25Db21wb25lbnQnO1xuXG5pbXBvcnQgdHlwZSB7XG4gIFF1aWNrU2VsZWN0aW9uUHJvdmlkZXIsXG59IGZyb20gJy4vdHlwZXMnO1xuXG52YXIgdHJhY2tGdW5jdGlvbjtcbmZ1bmN0aW9uIHRyYWNrKC4uLmFyZ3MpIHtcbiAgdmFyIHRyYWNrRnVuYyA9IHRyYWNrRnVuY3Rpb24gfHwgKHRyYWNrRnVuY3Rpb24gPSByZXF1aXJlKCdudWNsaWRlLWFuYWx5dGljcycpLnRyYWNrKTtcbiAgdHJhY2tGdW5jLmFwcGx5KG51bGwsIGFyZ3MpO1xufVxuXG52YXIgZGVib3VuY2VGdW5jdGlvbiA9IG51bGw7XG5mdW5jdGlvbiBkZWJvdW5jZSguLi5hcmdzKSB7XG4gIHZhciBkZWJvdW5jZUZ1bmMgPSBkZWJvdW5jZUZ1bmN0aW9uIHx8IChkZWJvdW5jZUZ1bmN0aW9uID0gcmVxdWlyZSgnbnVjbGlkZS1jb21tb25zJykuZGVib3VuY2UpO1xuICByZXR1cm4gZGVib3VuY2VGdW5jLmFwcGx5KG51bGwsIGFyZ3MpO1xufTtcblxudmFyIHNlYXJjaFJlc3VsdE1hbmFnZXIgPSBudWxsO1xuZnVuY3Rpb24gZ2V0U2VhcmNoUmVzdWx0TWFuYWdlcigpIHtcbiAgcmV0dXJuIHNlYXJjaFJlc3VsdE1hbmFnZXIgfHwgKHNlYXJjaFJlc3VsdE1hbmFnZXIgPSByZXF1aXJlKCcuL1NlYXJjaFJlc3VsdE1hbmFnZXInKSk7XG59O1xuXG52YXIgREVGQVVMVF9QUk9WSURFUiA9ICdGaWxlTGlzdFByb3ZpZGVyJztcbnZhciBNQVhfTU9EQUxfV0lEVEggPSA4MDA7XG5cbi8qKlxuICogQSBcInNlc3Npb25cIiBmb3IgdGhlIHB1cnBvc2Ugb2YgYW5hbHl0aWNzLiBJdCBleGlzdHMgZnJvbSB0aGUgbW9tZW50IHRoZSBxdWljay1vcGVuIFVJIGJlY29tZXNcbiAqIHZpc2libGUgdW50aWwgaXQgZ2V0cyBjbG9zZWQsIGVpdGhlciB2aWEgZmlsZSBzZWxlY3Rpb24gb3IgY2FuY2VsbGF0aW9uLlxuICovXG52YXIgYW5hbHl0aWNzU2Vzc2lvbklkID0gbnVsbDtcbnZhciBBbmFseXRpY3NFdmVudHMgPSB7XG4gIENIQU5HRV9TRUxFQ1RJT046ICdxdWlja29wZW4tY2hhbmdlLXNlbGVjdGlvbicsXG4gIENIQU5HRV9UQUI6ICAgICAgICdxdWlja29wZW4tY2hhbmdlLXRhYicsXG4gIENMT1NFX1BBTkVMOiAgICAgICdxdWlja29wZW4tY2xvc2UtcGFuZWwnLFxuICBPUEVOX1BBTkVMOiAgICAgICAncXVpY2tvcGVuLW9wZW4tcGFuZWwnLFxuICBTRUxFQ1RfRklMRTogICAgICAncXVpY2tvcGVuLXNlbGVjdC1maWxlJyxcbn07XG52YXIgQW5hbHl0aWNzRGVib3VuY2VEZWxheXMgPSB7XG4gIENIQU5HRV9UQUI6IDEwMCxcbiAgQ0hBTkdFX1NFTEVDVElPTjogMTAwLFxufTtcblxudmFyIF9xdWlja1NlbGVjdGlvbkNvbXBvbmVudDogP1F1aWNrU2VsZWN0aW9uQ29tcG9uZW50ID0gbnVsbDtcbmZ1bmN0aW9uIGdldFF1aWNrU2VsZWN0aW9uQ29tcG9uZW50TGF6aWx5KCkge1xuICBpZiAoIV9xdWlja1NlbGVjdGlvbkNvbXBvbmVudCkge1xuICAgIF9xdWlja1NlbGVjdGlvbkNvbXBvbmVudCA9IHJlcXVpcmUoJy4vUXVpY2tTZWxlY3Rpb25Db21wb25lbnQnKTtcbiAgfVxuICByZXR1cm4gX3F1aWNrU2VsZWN0aW9uQ29tcG9uZW50O1xufVxuXG52YXIgX3JlYWN0ID0gbnVsbDtcbmZ1bmN0aW9uIGdldFJlYWN0TGF6aWx5KCkge1xuICBpZiAoX3JlYWN0ID09PSBudWxsKSB7XG4gICAgX3JlYWN0ID0gcmVxdWlyZSgncmVhY3QtZm9yLWF0b20nKTtcbiAgfVxuICByZXR1cm4gX3JlYWN0O1xufVxuXG5jbGFzcyBBY3RpdmF0aW9uIHtcbiAgX2N1cnJlbnRQcm92aWRlcjogUXVpY2tTZWxlY3Rpb25Qcm92aWRlcjtcbiAgX3ByZXZpb3VzRm9jdXM6ID9FbGVtZW50O1xuICBfcmVhY3REaXY6IEVsZW1lbnQ7XG4gIF9zZWFyY2hDb21wb25lbnQ6IFF1aWNrU2VsZWN0aW9uQ29tcG9uZW50O1xuICBfc2VhcmNoUGFuZWw6IGF0b20kUGFuZWw7XG4gIF9zdWJzY3JpcHRpb25zOiBhdG9tJENvbXBvc2l0ZURpc3Bvc2FibGU7XG4gIF9kZWJvdW5jZWRVcGRhdGVNb2RhbFBvc2l0aW9uOiAoKSA9PiB2b2lkO1xuXG4gIGNvbnN0cnVjdG9yKCkge1xuICAgIHRoaXMuX3ByZXZpb3VzRm9jdXMgPSBudWxsO1xuXG4gICAgdmFyIHtDb21wb3NpdGVEaXNwb3NhYmxlfSA9IHJlcXVpcmUoJ2F0b20nKTtcbiAgICB0aGlzLl9jdXJyZW50UHJvdmlkZXIgPSBnZXRTZWFyY2hSZXN1bHRNYW5hZ2VyKCkuZ2V0UHJvdmlkZXIoREVGQVVMVF9QUk9WSURFUik7XG4gICAgdGhpcy5fcmVhY3REaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcbiAgICB0aGlzLl9zZWFyY2hQYW5lbCA9IGF0b20ud29ya3NwYWNlLmFkZE1vZGFsUGFuZWwoe2l0ZW06IHRoaXMuX3JlYWN0RGl2LCB2aXNpYmxlOiBmYWxzZX0pO1xuICAgIHRoaXMuX2RlYm91bmNlZFVwZGF0ZU1vZGFsUG9zaXRpb24gPSBkZWJvdW5jZSh0aGlzLl91cGRhdGVNb2RhbFBvc2l0aW9uLmJpbmQodGhpcyksIDIwMCk7XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMuX2RlYm91bmNlZFVwZGF0ZU1vZGFsUG9zaXRpb24pO1xuICAgIHRoaXMuX3VwZGF0ZU1vZGFsUG9zaXRpb24oKTtcblxuICAgIHRoaXMuX3NlYXJjaENvbXBvbmVudCA9IHRoaXMuX3JlbmRlcigpO1xuICAgIHRoaXMuX3NlYXJjaENvbXBvbmVudC5vblNlbGVjdGlvbigoc2VsZWN0aW9uKSA9PiB7XG4gICAgICB2YXIgb3B0aW9ucyA9IHt9O1xuICAgICAgaWYgKHNlbGVjdGlvbi5saW5lKSB7XG4gICAgICAgIG9wdGlvbnMuaW5pdGlhbExpbmUgPSBzZWxlY3Rpb24ubGluZTtcbiAgICAgIH1cbiAgICAgIGlmIChzZWxlY3Rpb24uY29sdW1uKSB7XG4gICAgICAgIG9wdGlvbnMuaW5pdGlhbENvbHVtbiA9IHNlbGVjdGlvbi5jb2x1bW47XG4gICAgICB9XG4gICAgICBhdG9tLndvcmtzcGFjZS5vcGVuKHNlbGVjdGlvbi5wYXRoLCBvcHRpb25zKTtcbiAgICAgIHZhciBxdWVyeSA9IHRoaXMuX3NlYXJjaENvbXBvbmVudC5nZXRJbnB1dFRleHRFZGl0b3IoKS50ZXh0Q29udGVudDtcbiAgICAgIHZhciBwcm92aWRlck5hbWUgPSB0aGlzLl9jdXJyZW50UHJvdmlkZXIuY29uc3RydWN0b3IubmFtZTtcbiAgICAgIHRyYWNrKFxuICAgICAgICBBbmFseXRpY3NFdmVudHMuU0VMRUNUX0ZJTEUsXG4gICAgICAgIHtcbiAgICAgICAgICAncXVpY2tvcGVuLWZpbGVwYXRoJzogc2VsZWN0aW9uLnBhdGgsXG4gICAgICAgICAgJ3F1aWNrb3Blbi1xdWVyeSc6IHF1ZXJ5LFxuICAgICAgICAgICdxdWlja29wZW4tcHJvdmlkZXInOiBwcm92aWRlck5hbWUsXG4gICAgICAgICAgJ3F1aWNrb3Blbi1zZXNzaW9uJzogYW5hbHl0aWNzU2Vzc2lvbklkLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgdGhpcy5jbG9zZVNlYXJjaFBhbmVsKCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLl9zZWFyY2hDb21wb25lbnQub25DYW5jZWxsYXRpb24oKCkgPT4gdGhpcy5jbG9zZVNlYXJjaFBhbmVsKCkpO1xuICAgIHRoaXMuX3NlYXJjaENvbXBvbmVudC5vblRhYkNoYW5nZShkZWJvdW5jZShwcm92aWRlck5hbWUgPT4ge1xuICAgICAgYW5hbHl0aWNzU2Vzc2lvbklkID0gYW5hbHl0aWNzU2Vzc2lvbklkIHx8IERhdGUubm93KCkudG9TdHJpbmcoKTtcbiAgICAgIHRyYWNrKFxuICAgICAgICBBbmFseXRpY3NFdmVudHMuQ0hBTkdFX1RBQixcbiAgICAgICAge1xuICAgICAgICAgICdxdWlja29wZW4tcHJvdmlkZXInOiBwcm92aWRlck5hbWUsXG4gICAgICAgICAgJ3F1aWNrb3Blbi1zZXNzaW9uJzogYW5hbHl0aWNzU2Vzc2lvbklkLFxuICAgICAgICB9XG4gICAgICApO1xuICAgICAgdGhpcy50b2dnbGVQcm92aWRlcihwcm92aWRlck5hbWUpO1xuICAgIH0sIEFuYWx5dGljc0RlYm91bmNlRGVsYXlzLkNIQU5HRV9UQUIpKTtcbiAgICB0aGlzLl9zZWFyY2hDb21wb25lbnQub25TZWxlY3Rpb25DaGFuZ2VkKGRlYm91bmNlKChzZWxlY3Rpb246IGFueSkgPT4ge1xuICAgICAgdHJhY2soXG4gICAgICAgIEFuYWx5dGljc0V2ZW50cy5DSEFOR0VfU0VMRUNUSU9OLFxuICAgICAgICB7XG5cbiAgICAgICAgICAncXVpY2tvcGVuLXNlbGVjdGVkLWluZGV4Jzogc2VsZWN0aW9uLnNlbGVjdGVkSXRlbUluZGV4LnRvU3RyaW5nKCksXG4gICAgICAgICAgJ3F1aWNrb3Blbi1zZWxlY3RlZC1zZXJ2aWNlJzogTnVtYmVyLnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHNlbGVjdGlvbi5zZWxlY3RlZEl0ZW1JbmRleCksXG4gICAgICAgICAgJ3F1aWNrb3Blbi1zZWxlY3RlZC1kaXJlY3RvcnknOiBzZWxlY3Rpb24uc2VsZWN0ZWREaXJlY3RvcnksXG4gICAgICAgICAgJ3F1aWNrb3Blbi1zZXNzaW9uJzogYW5hbHl0aWNzU2Vzc2lvbklkLFxuICAgICAgICB9XG4gICAgICApO1xuICAgIH0sIEFuYWx5dGljc0RlYm91bmNlRGVsYXlzLkNIQU5HRV9TRUxFQ1RJT04pKTtcbiAgfVxuXG4gIF91cGRhdGVNb2RhbFBvc2l0aW9uKCkge1xuICAgIC8vIEN1c3RvbWl6ZSBtb2RhbCBlbGVtZW50XG4gICAgdmFyIG1vZGFsRWxlbWVudCA9IHRoaXMuX3NlYXJjaFBhbmVsLmdldEl0ZW0oKS5wYXJlbnROb2RlO1xuICAgIHZhciB7d2lkdGgsIGhlaWdodH0gPSBkb2N1bWVudC5kb2N1bWVudEVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgdmFyIG1vZGFsV2lkdGggPSBNYXRoLm1pbihNQVhfTU9EQUxfV0lEVEgsIHdpZHRoKTtcbiAgICBtb2RhbEVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoJ3dpZHRoJywgbW9kYWxXaWR0aCArICdweCcpO1xuICAgIG1vZGFsRWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eSgnbWFyZ2luLWxlZnQnLCAoLW1vZGFsV2lkdGggLyAyKSArICdweCcpO1xuICB9XG5cbiAgX3JlbmRlcigpIHtcbiAgICB2YXIgUXVpY2tTZWxlY3Rpb25Db21wb25lbnQgPSBnZXRRdWlja1NlbGVjdGlvbkNvbXBvbmVudExhemlseSgpO1xuICAgIHZhciBSZWFjdCA9IGdldFJlYWN0TGF6aWx5KCk7XG4gICAgcmV0dXJuIFJlYWN0LnJlbmRlcihcbiAgICAgIDxRdWlja1NlbGVjdGlvbkNvbXBvbmVudFxuICAgICAgICBwcm92aWRlcj17dGhpcy5fY3VycmVudFByb3ZpZGVyfVxuICAgICAgLz4sXG4gICAgICB0aGlzLl9yZWFjdERpdlxuICAgICk7XG4gIH1cblxuICB0b2dnbGVQcm92aWRlcihwcm92aWRlck5hbWU6IHN0cmluZykge1xuICAgIGFuYWx5dGljc1Nlc3Npb25JZCA9IGFuYWx5dGljc1Nlc3Npb25JZCB8fCBEYXRlLm5vdygpLnRvU3RyaW5nKCk7XG4gICAgdHJhY2soXG4gICAgICBBbmFseXRpY3NFdmVudHMuQ0hBTkdFX1RBQixcbiAgICAgIHtcbiAgICAgICAgJ3F1aWNrb3Blbi1wcm92aWRlcic6IHByb3ZpZGVyTmFtZSxcbiAgICAgICAgJ3F1aWNrb3Blbi1zZXNzaW9uJzogYW5hbHl0aWNzU2Vzc2lvbklkLFxuICAgICAgfVxuICAgICk7XG4gICAgdmFyIHByb3ZpZGVyID0gZ2V0U2VhcmNoUmVzdWx0TWFuYWdlcigpLmdldFByb3ZpZGVyKHByb3ZpZGVyTmFtZSk7XG4gICAgLy8gXCJ0b2dnbGVcIiBiZWhhdmlvclxuICAgIGlmIChcbiAgICAgIHRoaXMuX3NlYXJjaFBhbmVsICE9PSBudWxsICYmXG4gICAgICB0aGlzLl9zZWFyY2hQYW5lbC5pc1Zpc2libGUoKSAmJlxuICAgICAgcHJvdmlkZXIgPT09IHRoaXMuX2N1cnJlbnRQcm92aWRlclxuICAgICkge1xuICAgICAgdGhpcy5jbG9zZVNlYXJjaFBhbmVsKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5fY3VycmVudFByb3ZpZGVyID0gcHJvdmlkZXI7XG4gICAgaWYgKHRoaXMuX3NlYXJjaENvbXBvbmVudCkge1xuICAgICAgdGhpcy5fc2VhcmNoQ29tcG9uZW50ID0gdGhpcy5fcmVuZGVyKCk7XG4gICAgfVxuICAgIHRoaXMuc2hvd1NlYXJjaFBhbmVsKCk7XG4gIH1cblxuICBzaG93U2VhcmNoUGFuZWwoKSB7XG4gICAgdGhpcy5fcHJldmlvdXNGb2N1cyA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG4gICAgaWYgKHRoaXMuX3NlYXJjaENvbXBvbmVudCAmJiB0aGlzLl9zZWFyY2hQYW5lbCkge1xuICAgICAgLy8gU3RhcnQgYSBuZXcgc2VhcmNoIFwic2Vzc2lvblwiIGZvciBhbmFseXRpY3MgcHVycG9zZXMuXG4gICAgICB0cmFjayhcbiAgICAgICAgQW5hbHl0aWNzRXZlbnRzLk9QRU5fUEFORUwsXG4gICAgICAgIHtcbiAgICAgICAgICAncXVpY2tvcGVuLXNlc3Npb24nOiBhbmFseXRpY3NTZXNzaW9uSWQsXG4gICAgICAgIH1cbiAgICAgICk7XG4gICAgICB0aGlzLl9zZWFyY2hQYW5lbC5zaG93KCk7XG4gICAgICB0aGlzLl9zZWFyY2hDb21wb25lbnQuZm9jdXMoKTtcbiAgICAgIHRoaXMuX3NlYXJjaENvbXBvbmVudC5zZWxlY3RJbnB1dCgpO1xuICAgIH1cbiAgfVxuXG4gIGNsb3NlU2VhcmNoUGFuZWwoKSB7XG4gICAgaWYgKHRoaXMuX3NlYXJjaENvbXBvbmVudCAmJiB0aGlzLl9zZWFyY2hQYW5lbCkge1xuICAgICAgdHJhY2soXG4gICAgICAgIEFuYWx5dGljc0V2ZW50cy5DTE9TRV9QQU5FTCxcbiAgICAgICAge1xuICAgICAgICAgICdxdWlja29wZW4tc2Vzc2lvbic6IGFuYWx5dGljc1Nlc3Npb25JZCxcbiAgICAgICAgfVxuICAgICAgKTtcbiAgICAgIHRoaXMuX3NlYXJjaFBhbmVsLmhpZGUoKTtcbiAgICAgIHRoaXMuX3NlYXJjaENvbXBvbmVudC5ibHVyKCk7XG4gICAgICBhbmFseXRpY3NTZXNzaW9uSWQgPSBudWxsO1xuICAgIH1cblxuICAgIGlmICh0aGlzLl9wcmV2aW91c0ZvY3VzICE9PSBudWxsKSB7XG4gICAgICB0aGlzLl9wcmV2aW91c0ZvY3VzLmZvY3VzKCk7XG4gICAgICB0aGlzLl9wcmV2aW91c0ZvY3VzID0gbnVsbDtcbiAgICB9XG4gIH1cbn1cblxudmFyIHtDb21wb3NpdGVEaXNwb3NhYmxlfSA9IHJlcXVpcmUoJ2F0b20nKTtcblxudmFyIGFjdGl2YXRpb246ID9BY3RpdmF0aW9uID0gbnVsbDtcbnZhciBsaXN0ZW5lcnM6ID9Db21wb3NpdGVEaXNwb3NhYmxlID0gbnVsbDtcbnZhciBwcm9qZWN0Um9vdHM6ID9TZXQgPSBudWxsO1xuXG5mdW5jdGlvbiBhY3RpdmF0ZVNlYXJjaFVJKCk6IHZvaWQge1xuICBpZiAoIWFjdGl2YXRpb24pIHtcbiAgICBhY3RpdmF0aW9uID0gbmV3IEFjdGl2YXRpb24oKTtcbiAgfVxufVxuXG4vKipcbiAqIEBwYXJhbSBwcm9qZWN0UGF0aHMgQWxsIHRoZSByb290IGRpcmVjdG9yaWVzIGluIHRoZSBBdG9tIHdvcmtzcGFjZS5cbiAqL1xuZnVuY3Rpb24gaW5pdFNlYXJjaChwcm9qZWN0UGF0aHM6IEFycmF5PHN0cmluZz4pOiB2b2lkIHtcbiAgdmFyIHtnZXRDbGllbnR9ID0gcmVxdWlyZSgnbnVjbGlkZS1jbGllbnQnKTtcbiAgdmFyIG5ld1Byb2plY3RSb290cyA9IG5ldyBTZXQoKTtcbiAgcHJvamVjdFJvb3RzLmZvckVhY2goKHByb2plY3RQYXRoKSA9PiB7XG4gICAgbmV3UHJvamVjdFJvb3RzLmFkZChwcm9qZWN0UGF0aCk7XG4gICAgaWYgKHByb2plY3RSb290cy5oYXMocHJvamVjdFBhdGgpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHZhciBjbGllbnQgPSBnZXRDbGllbnQocHJvamVjdFBhdGgpO1xuICAgIGlmIChjbGllbnQpIHtcbiAgICAgIC8vIEl0IGRvZXNuJ3QgbWF0dGVyIHdoYXQgdGhlIHNlYXJjaCB0ZXJtIGlzLiBFbXBpcmljYWxseSwgZG9pbmcgYW4gaW5pdGlhbFxuICAgICAgLy8gc2VhcmNoIHNwZWVkcyB1cCB0aGUgbmV4dCBzZWFyY2ggbXVjaCBtb3JlIHRoYW4gc2ltcGx5IGRvaW5nIHRoZSBzZXR1cFxuICAgICAgLy8ga2lja2VkIG9mZiBieSAnZmlsZVNlYXJjaEZvckRpcmVjdG9yeScuXG4gICAgICBjbGllbnQuc2VhcmNoRGlyZWN0b3J5KHByb2plY3RQYXRoLCAnYScpO1xuICAgIH1cbiAgfSk7XG4gIHByb2plY3RSb290cyA9IG5ld1Byb2plY3RSb290cztcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cbiAgYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgbGlzdGVuZXJzID0gbmV3IENvbXBvc2l0ZURpc3Bvc2FibGUoKTtcbiAgICBsaXN0ZW5lcnMuYWRkKFxuICAgICAgYXRvbS5jb21tYW5kcy5hZGQoJ2F0b20td29ya3NwYWNlJywge1xuICAgICAgICAnbnVjbGlkZS1xdWljay1vcGVuOnRvZ2dsZS1vbW5pLXNlYXJjaCc6ICgpID0+IHtcbiAgICAgICAgICBhY3RpdmF0ZVNlYXJjaFVJKCk7XG4gICAgICAgICAgYWN0aXZhdGlvbi50b2dnbGVQcm92aWRlcignT21uaVNlYXJjaFJlc3VsdFByb3ZpZGVyJyk7XG4gICAgICAgIH0sXG4gICAgICAgICdudWNsaWRlLXF1aWNrLW9wZW46dG9nZ2xlLXF1aWNrLW9wZW4nOiAoKSA9PiB7XG4gICAgICAgICAgYWN0aXZhdGVTZWFyY2hVSSgpO1xuICAgICAgICAgIGFjdGl2YXRpb24udG9nZ2xlUHJvdmlkZXIoJ0ZpbGVMaXN0UHJvdmlkZXInKTtcbiAgICAgICAgfSxcbiAgICAgICAgJ251Y2xpZGUtcXVpY2stb3Blbjp0b2dnbGUtc3ltYm9sLXNlYXJjaCc6ICgpID0+IHtcbiAgICAgICAgICBhY3RpdmF0ZVNlYXJjaFVJKCk7XG4gICAgICAgICAgYWN0aXZhdGlvbi50b2dnbGVQcm92aWRlcignU3ltYm9sTGlzdFByb3ZpZGVyJyk7XG4gICAgICAgIH0sXG4gICAgICAgICdudWNsaWRlLXF1aWNrLW9wZW46dG9nZ2xlLWJpZ2dyZXAtc2VhcmNoJzogKCkgPT4ge1xuICAgICAgICAgIGFjdGl2YXRlU2VhcmNoVUkoKTtcbiAgICAgICAgICBhY3RpdmF0aW9uLnRvZ2dsZVByb3ZpZGVyKCdCaWdHcmVwTGlzdFByb3ZpZGVyJyk7XG4gICAgICAgIH0sXG4gICAgICAgICdudWNsaWRlLXF1aWNrLW9wZW46dG9nZ2xlLW9wZW5maWxlbmFtZS1zZWFyY2gnOiAoKSA9PiB7XG4gICAgICAgICAgYWN0aXZhdGVTZWFyY2hVSSgpO1xuICAgICAgICAgIGFjdGl2YXRpb24udG9nZ2xlUHJvdmlkZXIoJ09wZW5GaWxlTGlzdFByb3ZpZGVyJyk7XG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG5cbiAgICAvLyBEbyBzZWFyY2ggcHJlcHJvY2Vzc2luZyBmb3IgYWxsIGV4aXN0aW5nIGFuZCBmdXR1cmUgcm9vdCBkaXJlY3Rvcmllcy5cbiAgICBwcm9qZWN0Um9vdHMgPSBuZXcgU2V0KCk7XG4gICAgYXRvbS5wcm9qZWN0LmdldFBhdGhzKGluaXRTZWFyY2gpO1xuICAgIGxpc3RlbmVycy5hZGQoYXRvbS5wcm9qZWN0Lm9uRGlkQ2hhbmdlUGF0aHMoaW5pdFNlYXJjaCkpO1xuICB9LFxuXG4gIGRlYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgaWYgKGFjdGl2YXRpb24pIHtcbiAgICAgIGFjdGl2YXRpb24gPSBudWxsO1xuICAgIH1cbiAgICBpZiAobGlzdGVuZXJzKSB7XG4gICAgICBsaXN0ZW5lcnMuZGlzcG9zZSgpO1xuICAgICAgbGlzdGVuZXJzID0gbnVsbDtcbiAgICB9XG4gIH1cbn07XG4iXX0=